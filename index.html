const isMarkedBreak = selectedBreaks.has(key);
        const autoBreak = (skipEvery && counter % skipEvery === 0);
        if (isMarkedBreak || autoBreak) {<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KCL PNOMH Graduation Planner ‚Äî Accurate Carousel + Breaks</title>
  <style>
    :root{
      --kcl-red:#d50032;--ink:#111827;--muted:#6b7280;--bg:#fafafa;--card:#ffffff;--line:#e5e7eb;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--chip:#f3f4f6
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,system-ui,-apple-system,Roboto,Arial,sans-serif}
    header{background:var(--kcl-red);color:#fff;padding:18px}
    header h1{margin:0;font-size:22px}
    header .sub{opacity:.9}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .card .inner{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff}
    .btn{background:var(--kcl-red);color:#fff;border:none;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px}
    .timeline{display:grid;gap:10px}
    .term{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff}
    .termHeader{display:flex;justify-content:space-between;align-items:center}
    .termTitle{font-weight:700}
    .kbd{border:1px solid var(--line);background:#fff;border-radius:6px;font-size:12px;padding:2px 6px}
    .moduleTag{border:1px dashed #cfd4dc;background:#f8fafc;border-radius:10px;padding:6px 8px;font-size:12px}
    .syn{background:#fff1f2;border-color:#fecaca}
    .break{background:#fff7ed;border-color:#fed7aa}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>King's College London ‚Äî PNOMH Graduation Planner</h1>
      <div class="sub">Accurate module carousel (2025/2026 pattern), real prerequisites, study breaks, and graduation estimate.</div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <div class="inner">
        <h3>1) Your setup</h3>
        <div class="row">
          <div>
            <label for="award">Intended award</label>
            <select id="award">
              <option value="PGCert">PG Cert (60c)</option>
              <option value="PGDip">PG Dip (120c)</option>
              <option value="MSc" selected>MSc (180c)</option>
            </select>
          </div>
          <div>
            <label for="start">Start teaching window</label>
            <select id="start"></select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="generate" class="btn">Generate plan</button>
          <button id="clearBreaks" class="btn secondary">Clear all breaks</button>
        </div>reaks (pick any)</label>
            <select id="breaks" multiple></select>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="inner">
        <h3>2) Choose up to 4 options</h3>
        <div class="tags" id="options"></div>
        <div style="margin-top:8px" class="tags" id="availabilityNote"></div>
      </div>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <div class="inner">
        <h3>3) Plan</h3>
        <div class="tags" style="margin-bottom:8px">
          <span class="chip">üü¶ Foundation</span>
          <span class="chip">üü• Option</span>
          <span class="chip">üü™ Research Skills</span>
          <span class="chip">‚¨õ Synoptic (2 periods)</span>
          <span class="chip">‚è±Ô∏è 2‚Äëyr target</span>
          <span class="chip">üö´ 6‚Äëyr max</span>
        </div>
        <div id="timeline" class="timeline"></div>
        <div id="impact" class="term" style="margin-top:8px">
          <div class="termHeader"><div class="termTitle">What‚Äëif impact</div><div class="muted">Compare vs no custom breaks</div></div>
          <div id="impactBody" class="muted">Click periods to toggle ad‚Äëhoc breaks (no need to change Pace). Or pick breaks from the dropdown above. Then click <b>Generate plan</b> to update.</div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="generate" class="btn">Generate plan</button>
          <button id="toggleBreaks" class="btn secondary">Toggle breaks (custom)</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // === Programme data from Carousel (2025/2026 swing) ===
    const FOUNDATIONS=['Biological Foundations of Mental Health','Techniques in Neuroscience','Psychological Foundations of Mental Health','Mental Health in the Community'];
    const OPTIONS_LIST=['Mindfulness','Global Mental Health','Psychology & Neuroscience of Addictions','Child & Adolescent Mental Health','Social, Genetic & Environmental Basis of Mental Health','Neuroscience in Society','Psychology & Neuroscience of Affective Disorders','Psychology & Neuroscience of Psychosis','Neuroimaging & Mental Health','Contemporary Advances in Neuroscience','Neurodevelopmental Disorders: From Bench to Bedside'];
    const RESEARCH=['Research Skills 1: From Reviewing & Critical Analysis to Research Ethics','Research Skills 2: From Methods & Procedures to Analysis & Reporting'];
    const SYNOPTIC=['Independent Synoptic Project'];

    const GROUP={FOUNDATION:'foundation',OPTIONS:'options',RESEARCH:'research',SYNOPTIC:'synoptic'};

    const S2025={
      '2025-01':['Techniques in Neuroscience','Psychology & Neuroscience of Affective Disorders','Neuroscience in Society','Social, Genetic & Environmental Basis of Mental Health','Research Skills 1: From Reviewing & Critical Analysis to Research Ethics','Independent Synoptic Project'],
      '2025-03':['Psychological Foundations of Mental Health','Psychology & Neuroscience of Psychosis','Neuroimaging & Mental Health','Research Skills 2: From Methods & Procedures to Analysis & Reporting','Independent Synoptic Project'],
      '2025-05':['Mental Health in the Community','Child & Adolescent Mental Health','Global Mental Health','Neurodevelopmental Disorders: From Bench to Bedside','Research Skills 1: From Reviewing & Critical Analysis to Research Ethics','Independent Synoptic Project'],
      '2025-06':['Biological Foundations of Mental Health','Psychology & Neuroscience of Addictions','Mindfulness','Contemporary Advances in Neuroscience','Research Skills 2: From Methods & Procedures to Analysis & Reporting','Independent Synoptic Project'],
      '2025-09':['Techniques in Neuroscience','Psychology & Neuroscience of Affective Disorders','Neuroscience in Society','Social, Genetic & Environmental Basis of Mental Health','Research Skills 1: From Reviewing & Critical Analysis to Research Ethics','Independent Synoptic Project'],
      '2025-10':['Psychological Foundations of Mental Health','Psychology & Neuroscience of Psychosis','Neuroimaging & Mental Health','Research Skills 2: From Methods & Procedures to Analysis & Reporting']
    };
    const S2026={
      '2026-01':['Mental Health in the Community','Child & Adolescent Mental Health','Global Mental Health','Neurodevelopmental Disorders: From Bench to Bedside','Research Skills 1: From Reviewing & Critical Analysis to Research Ethics','Independent Synoptic Project'],
      '2026-03':['Biological Foundations of Mental Health','Psychology & Neuroscience of Addictions','Mindfulness','Contemporary Advances in Neuroscience','Research Skills 2: From Methods & Procedures to Analysis & Reporting','Independent Synoptic Project'],
      '2026-05':['Techniques in Neuroscience','Psychology & Neuroscience of Affective Disorders','Neuroscience in Society','Social, Genetic & Environmental Basis of Mental Health','Research Skills 1: From Reviewing & Critical Analysis to Research Ethics','Independent Synoptic Project'],
      '2026-06':['Psychological Foundations of Mental Health','Psychology & Neuroscience of Psychosis','Neuroimaging & Mental Health','Research Skills 2: From Methods & Procedures to Analysis & Reporting','Independent Synoptic Project'],
      '2026-09':['Mental Health in the Community','Child & Adolescent Mental Health','Global Mental Health','Neurodevelopmental Disorders: From Bench to Bedside','Research Skills 1: From Reviewing & Critical Analysis to Research Ethics','Independent Synoptic Project'],
      '2026-10':['Biological Foundations of Mental Health','Psychology & Neuroscience of Addictions','Mindfulness','Contemporary Advances in Neuroscience','Research Skills 2: From Methods & Procedures to Analysis & Reporting']
    };

    function buildSchedule(startYear,years=8){
      const m=new Map();
      for(let y=startYear;y<startYear+years;y++){
        const base=(y%2===1)?S2025:S2026; // odd‚Üí2025 pattern
        Object.entries(base).forEach(([k,mods])=>{const mm=k.split('-')[1];m.set(`${y}-${mm}`,[...mods]);});
      }
      return m;
    }

    // Requirements per award
    const REQUIREMENTS={
      PGCert:{foundation:4,options:0,research:0,synoptic:0},
      PGDip:{foundation:4,options:4,research:0,synoptic:0},
      MSc:{foundation:4,options:4,research:2,synoptic:1}
    };

    // Populate UI: start windows from earliest known (Jan 2025)
    const startSel=document.getElementById('start');
    const schedule=buildSchedule(2025,10);
    const keys=[...schedule.keys()].sort();
    keys.forEach(k=>{const d=new Date(+k.split('-')[0],+k.split('-')[1]-1,1);const lab=d.toLocaleString(undefined,{month:'short',year:'numeric'});const o=document.createElement('option');o.value=k;o.textContent=lab;startSel.appendChild(o);});
    startSel.value='2025-01';

    // Render option chips with checkboxes (limit 4)
    const optsWrap=document.getElementById('options');
    OPTIONS_LIST.forEach(name=>{
      const id='opt-'+name.replace(/[^a-z0-9]/gi,'');
      const lbl=document.createElement('label');lbl.className='chip';lbl.style.userSelect='none';
      lbl.innerHTML=`<input type="checkbox" id="${id}" data-name="${name}" style="margin-right:6px">${name}`;
      optsWrap.appendChild(lbl);
    });

    function selectedOptions(){
      const chosen=[...document.querySelectorAll('#options input:checked')].map(cb=>cb.dataset.name);
      return chosen.slice(0,4); // limit to 4
    }

    // Breaks state (persist across re-renders)
    const selectedBreaks = new Set();

    document.getElementById('clearBreaks').addEventListener('click', () => {
      selectedBreaks.clear();
      const breaksSel = document.getElementById('breaks');
      [...breaksSel.options].forEach(o => (o.selected = false));
      generatePlan();
    });

    // Populate breaks selector based on current start window
    function populateBreaksOptions() {
      const breaksSel = document.getElementById('breaks');
      breaksSel.innerHTML = '';
      const startKey = document.getElementById('start').value;
      const hardStop = addYears(startKey, 6);
      const avail = keys.filter(k => k >= startKey && k <= hardStop);
      avail.forEach(k => {
        const d = new Date(+k.split('-')[0], +k.split('-')[1]-1, 1);
        const lab = d.toLocaleString(undefined, { month:'short', year:'numeric' });
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = lab; opt.selected = selectedBreaks.has(k);
        breaksSel.appendChild(opt);
      });
    }

    document.getElementById('start').addEventListener('change', () => {
      populateBreaksOptions();
      generatePlan();
    });

    // Core planning
    let occupiedKeys=new Set();
    let currentPlan=null;

    function generatePlan(applyCustomBreaks=true){
      const award=document.getElementById('award').value;
      const startKey=document.getElementById('start').value;
      const pace=document.getElementById('pace').value;
      // Merge breaks chosen from the dropdown into the persistent set
      const breaksSelEl = document.getElementById('breaks');
      const dropdownBreaks = new Set([...breaksSelEl.options].filter(o=>o.selected).map(o=>o.value));
      dropdownBreaks.forEach(k => selectedBreaks.add(k));
      const req={...REQUIREMENTS[award]};

      const remaining={
        foundation:new Set(FOUNDATIONS),
        options:new Set(selectedOptions().length?selectedOptions():OPTIONS_LIST),
        research:new Set(RESEARCH),
        synoptic:new Set(SYNOPTIC)
      };

      let taken={foundation:0,options:0,research:0,synoptic:0};
      let planned=[];

      const allKeys=keys.filter(k=>k>=startKey);
      const hardStop=addYears(startKey,6); // absolute max
      const target=addYears(startKey,2);
      const iterKeys=allKeys.filter(k=>k<=hardStop);

      let skipEvery=(document.getElementById('pace').value==='light')?3:0;let counter=0;
      occupiedKeys=new Set();

      for(const key of iterKeys){
        counter++;
        const withinTarget=key<=target;
        const mods=schedule.get(key)||[];
        const isCustomBreak=document.querySelector(`.term[data-key="${key}"]`)?.dataset.break==='1';
        const autoBreak=(skipEvery && counter%skipEvery===0);
        if(applyCustomBreaks && ((pace==='custom' && isCustomBreak) || autoBreak)){
          planned.push({key,module:'Break',group:'break',withinTarget});
          continue;
        }

        const canSyn=(taken.research===2 && req.synoptic>0 && remaining.synoptic.size>0);
        let picked=null;
        if(taken.foundation<req.foundation){
          picked=mods.find(m=>remaining.foundation.has(m));
          if(picked){remaining.foundation.delete(picked);taken.foundation++;planned.push({key,module:picked,group:GROUP.FOUNDATION,withinTarget});continue;}
        }
        if(taken.options<req.options){
          picked=mods.find(m=>remaining.options.has(m));
          if(picked){remaining.options.delete(picked);taken.options++;planned.push({key,module:picked,group:GROUP.OPTIONS,withinTarget});continue;}
        }
        if(taken.research<req.research){
          picked=mods.find(m=>remaining.research.has(m));
          if(picked){remaining.research.delete(picked);taken.research++;planned.push({key,module:picked,group:GROUP.RESEARCH,withinTarget});continue;}
        }
        if(canSyn){
          const next=nextKey(key);
          planned.push({key,module:SYNOPTIC[0],group:GROUP.SYNOPTIC,withinTarget});
          planned.push({key:next,module:SYNOPTIC[0]+' (cont.)',group:GROUP.SYNOPTIC,withinTarget:next<=target});
          taken.synoptic++;occupiedKeys.add(next);continue;
        }
        planned.push({key,module:'‚Äî',group:'idle',withinTarget});
      }

      planned=trimAfterDone(planned,taken,req);
      renderTimeline(planned,startKey,target,hardStop,req);
      currentPlan={planned,award,startKey,pace,chosenOptions:selectedOptions()};

      const baseline=buildBaseline({award,startKey,pace,chosenOptions:selectedOptions()});
      renderImpact(baseline,currentPlan);
    }

    function addYears(key,yrs){const [y,m]=key.split('-').map(Number);return `${y+yrs}-${String(m).padStart(2,'0')}`}
    function nextKey(key){const order=['01','03','05','06','09','10'];const[y,m]=key.split('-');const i=order.indexOf(m);return i<order.length-1?`${y}-${order[i+1]}`:`${(+y+1)}-${order[0]}`}
    function trimAfterDone(list,taken,req){function done(){return taken.foundation>=req.foundation&&taken.options>=req.options&&taken.research>=req.research&&taken.synoptic>=req.synoptic}const out=[];for(const p of list){if(done())break;out.push(p)}return out}

    function renderTimeline(planned,startKey,target,hardStop,req){
      const el=document.getElementById('timeline');el.innerHTML='';
      planned.forEach(item=>{
        const term=document.createElement('div');term.className='term';term.dataset.key=item.key;
        term.addEventListener('click', () => {
          const isBreak = selectedBreaks.has(item.key);
          if (!isBreak) selectedBreaks.add(item.key); else selectedBreaks.delete(item.key);
          generatePlan();
        });
        const title=new Date(+item.key.split('-')[0],+item.key.split('-')[1]-1,1).toLocaleString(undefined,{month:'short',year:'numeric'});
        const meta=[];if(item.key===target)meta.push('<span class="warn">‚è±Ô∏è 2‚Äëyr target</span>');if(item.key===hardStop)meta.push('<span class="bad">üö´ 6‚Äëyr max</span>');
        const isBreak = selectedBreaks.has(item.key);
        term.innerHTML=`<div class="termHeader"><div class="termTitle">${title}</div><div class="muted">${meta.join(' ¬∑ ')}</div></div>${isBreak ? '<div class="tags"><span class="moduleTag break">Study break</span></div>' : renderRow(item)}`;
        el.appendChild(term);
      });

      const summary=document.createElement('div');summary.className='muted';summary.style.marginTop='6px';
      const counts=planned.reduce((a,p)=>{a[p.group]=(a[p.group]||0)+(p.group!=='idle'&&p.group!=='break'?1:0);return a;},{});
      summary.innerHTML=`<span class="kbd">Need ‚Üí Foundation ${req.foundation}, Options ${req.options}, Research ${req.research}, Synoptic ${req.synoptic}</span> &nbsp; <span class="kbd">Planned ‚Üí F ${(counts.foundation||0)}, O ${(counts.options||0)}, R ${(counts.research||0)}, Syn ${(counts.synoptic||0)}</span>`;
      el.appendChild(summary);

      // Graduation estimate
      const last=planned.filter(p=>p.group!=='idle'&&p.group!=='break').pop();
      const grad=document.createElement('div');grad.className='term';grad.style.background='#f1f5f9';
      if(last){grad.innerHTML=`<b>üéì Estimated graduation:</b> <span class="ok">${new Date(+last.key.split('-')[0],+last.key.split('-')[1]-1,1).toLocaleString(undefined,{month:'short',year:'numeric'})}</span>`} else {grad.textContent='No plan generated.'}
      el.appendChild(grad);
    }

    function renderRow(item){
      if(item.group==='idle')return `<div class="tags"><span class="moduleTag">No eligible module</span></div>`;
      if(item.group==='break')return `<div class="tags"><span class="moduleTag break">Study break</span></div>`;
      const prefix=item.group==='foundation'?'üü¶':item.group==='options'?'üü•':item.group==='research'?'üü™':'‚¨õ';
      const extra=item.group==='synoptic'?' syn':'';
      return `<div class="tags"><span class="moduleTag${extra}">${prefix} ${item.module}</span></div>`;
    }

    function buildBaseline({award,startKey,pace,chosenOptions}){
      const req={...REQUIREMENTS[award]};
      const remaining={foundation:new Set(FOUNDATIONS),options:new Set(chosenOptions.length?chosenOptions:OPTIONS_LIST),research:new Set(RESEARCH),synoptic:new Set(SYNOPTIC)};
      let taken={foundation:0,options:0,research:0,synoptic:0};
      let planned=[];let skipEvery=(pace==='light')?3:0;let counter=0;occupiedKeys=new Set();
      const allKeys=keys.filter(k=>k>=startKey);const hard=addYears(startKey,6);const target=addYears(startKey,2);const iter=allKeys.filter(k=>k<=hard);
      for(const key of iter){counter++;const withinTarget=key<=target;const mods=schedule.get(key)||[];const autoBreak=(skipEvery && counter%skipEvery===0);if(autoBreak){planned.push({key,module:'Break',group:'break',withinTarget});continue;}
        const canSyn=(taken.research===2 && req.synoptic>0 && remaining.synoptic.size>0);
        let picked=null;
        if(taken.foundation<req.foundation){picked=mods.find(m=>remaining.foundation.has(m));if(picked){remaining.foundation.delete(picked);taken.foundation++;planned.push({key,module:picked,group:GROUP.FOUNDATION,withinTarget});continue;}}
        if(taken.options<req.options){picked=mods.find(m=>remaining.options.has(m));if(picked){remaining.options.delete(picked);taken.options++;planned.push({key,module:picked,group:GROUP.OPTIONS,withinTarget});continue;}}
        if(taken.research<req.research){picked=mods.find(m=>remaining.research.has(m));if(picked){remaining.research.delete(picked);taken.research++;planned.push({key,module:picked,group:GROUP.RESEARCH,withinTarget});continue;}}
        if(canSyn){const next=nextKey(key);planned.push({key,module:SYNOPTIC[0],group:GROUP.SYNOPTIC,withinTarget});planned.push({key:next,module:SYNOPTIC[0]+' (cont.)',group:GROUP.SYNOPTIC,withinTarget:next<=target});taken.synoptic++;occupiedKeys.add(next);continue;}
        planned.push({key,module:'‚Äî',group:'idle',withinTarget});
      }
      planned=trimAfterDone(planned,taken,req);
      return {planned,award,startKey};
    }

    function renderImpact(baseline,current){
      const el=document.getElementById('impactBody');if(!baseline||!current){el.textContent='';return}
      const last1=baseline.planned.filter(p=>p.group!=='idle'&&p.group!=='break').pop();
      const last2=current.planned.filter(p=>p.group!=='idle'&&p.group!=='break').pop();
      if(!last1||!last2){el.textContent='Generate a plan to see impact.';return}
      const fmt=k=>new Date(+k.split('-')[0],+k.split('-')[1]-1,1).toLocaleString(undefined,{month:'short',year:'numeric'});
      const monthsDiff=(a,b)=>{const [ay,am]=a.split('-').map(Number);const [by,bm]=b.split('-').map(Number);return (by-ay)*12+(bm-am)};
      const delta=monthsDiff(baseline.planned[baseline.planned.length-1].key,current.planned[current.planned.length-1].key);
      el.innerHTML=`Baseline finish: <b>${fmt(last1.key)}</b> ¬∑ Current finish: <b>${fmt(last2.key)}</b> ¬∑ Impact: <b>${delta>=0?"+"+delta:delta}</b> months`;
    }

    document.getElementById('generate').addEventListener('click', () => generatePlan(true));

    // Auto-generate baseline on load and populate breaks selector
    populateBreaksOptions();
    generatePlan();
  </script>
</body>
</html>
