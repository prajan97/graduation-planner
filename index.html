<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KCL PNOMH Graduation Planner — Modern Institutional</title>

<!-- Inter font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Tailwind via CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: { inter: ['Inter','system-ui','-apple-system','Segoe UI','Roboto','Helvetica','Arial','sans-serif'] },
      colors: {
        kcl: { red: '#c8102e', dark: '#9e0e26', tint: '#ffe7ea' }
      },
      boxShadow: {
        soft: '0 4px 20px rgba(0,0,0,0.06)',
        card: '0 8px 28px rgba(16,24,40,.08)'
      },
      borderRadius: { xl: '12px' }
    }
  }
}
</script>

<style>
/* ====== Global background: warm neutral with faint crimson tint ====== */
:root{ --bgA:#fff9f8; --bgB:#faf7f7; --bgC:#f5f7fa; }
body{
  background:
    radial-gradient(1400px 700px at 6% -10%, #fff2f4 0%, transparent 55%),
    radial-gradient(1200px 600px at 100% 0%, #fff6f7 0%, transparent 50%),
    linear-gradient(135deg, var(--bgA), var(--bgB) 40%, var(--bgC));
  font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:#1e293b;
  line-height:1.62;
}
.dark body{
  background: radial-gradient(1200px 600px at -5% -5%, #1a1014 0%, transparent 55%),
              linear-gradient(145deg,#0b0d14,#141827 70%, #0b0f1a);
  color:#e5e7eb;
}

/* ====== Header with subtle diagonal crimson stripe ====== */
header{
  position:relative; overflow:hidden;
  background:rgba(255,255,255,0.88);
  backdrop-filter:blur(10px);
  border-bottom:2px solid #c8102e;
  box-shadow:0 6px 18px rgba(16,24,40,.06);
}
header::before{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:linear-gradient(135deg,
    rgba(200,16,46,.08) 0%,
    rgba(200,16,46,.04) 40%,
    rgba(200,16,46,0) 100%);
}
.dark header{
  background:rgba(15,17,25,.86);
  border-bottom-color:#9e0e26;
}
.dark header::before{
  background:linear-gradient(135deg,
    rgba(156,17,36,.18) 0%,
    rgba(156,17,36,.08) 40%,
    rgba(156,17,36,0) 100%);
}

/* ====== Cards (glass) ====== */
.card{
  background:rgba(255,255,255,.78);
  border:1px solid rgba(16,24,40,.08);
  border-radius:12px;
  box-shadow:var(--tw-shadow),var(--tw-shadow-colored);
  backdrop-filter:blur(12px);
  transition:box-shadow .2s ease, transform .2s ease, border-color .2s ease, background .2s ease;
}
.card:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(16,24,40,.10); }
.dark .card{
  background:rgba(25,28,38,.72);
  border-color:rgba(255,255,255,.10);
  box-shadow:0 8px 30px rgba(0,0,0,.25);
}

/* ====== Typography ====== */
h1{ font-size:18px; font-weight:700; letter-spacing:.02em }
h3{ font-size:15px; font-weight:700; letter-spacing:.01em }
.muted{ color:#64748b } .dark .muted{ color:#9aa4b2 }

/* ====== Buttons ====== */
button{ border-radius:8px; font-size:14px; font-weight:600; padding:.45rem .9rem; transition:all .2s ease }
button:active{ transform:scale(.98) }
.btn-primary{ background:#c8102e; color:#fff }
.btn-primary:hover{ background:#9e0e26 }
.btn-ghost{ background:#f8fafc; color:#1e293b; border:1px solid #e5e7eb }
.btn-ghost:hover{ background:#f1f5f9 }
.dark .btn-ghost{ background:#1f2937; color:#e5e7eb; border-color:#334155 }
.dark .btn-ghost:hover{ background:#263244 }

/* ====== Dark-mode pill toggle ====== */
#darkToggle{
  border-radius:9999px; border:1px solid rgba(16,24,40,.12);
  padding:.45rem 1rem; font-size:13px; font-weight:600; color:#1f2937;
  background:linear-gradient(180deg,#ffffff,#f3f4f6);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
  transition:all .2s ease;
}
#darkToggle:hover{ transform:translateY(-1px); background:linear-gradient(180deg,#ffffff,#eceef1) }
.dark #darkToggle{
  color:#e5e7eb; border-color:#334155;
  background:linear-gradient(180deg,#1f2937,#0f172a);
}

/* ====== Options chips: compact & legible in both themes ====== */
#opts{
  display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
  gap:.5rem; max-width:520px;
}
.chip{
  font-size:13px; padding:.34rem .64rem; border-radius:10px;
  background:#f3f5f8; border:1px solid rgba(16,24,40,.10); color:#374151;
  transition:transform .12s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease;
}
.chip:hover{ background:#eef1f5; transform:translateY(-1px); box-shadow:0 4px 12px rgba(16,24,40,.06) }
.chip.on{
  background:#ffe7ea; border-color:#c8102e; color:#8f0f26; font-weight:600;
  box-shadow:inset 0 0 0 1px #c8102e33;
}
.dark .chip{ background:#2d2f37; border-color:#3a3f47; color:#e5e7eb }
.dark .chip.on{ background:#3a0d18; color:#ffb8c1; border-color:#c8102e }

/* ====== Study Plan term cards ====== */
.term-card{
  border:1px solid rgba(16,24,40,.10);
  border-radius:10px;
  background:rgba(255,255,255,.82);
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.term-card:hover{ border-color:#cfd6df; box-shadow:0 10px 22px rgba(16,24,40,.08) }
.dark .term-card{ background:rgba(14,18,28,.72); border-color:rgba(255,255,255,.10) }

/* ====== Progress bars ====== */
.prog-outer{ height:12px; border-radius:9999px; overflow:hidden; border:1px solid rgba(16,24,40,.10); background:#ffffffb0 }
.dark .prog-outer{ background:#0f172a; border-color:#334155 }
.prog-fill{ height:100%; background:linear-gradient(90deg,#c8102e,#d9273b); color:#fff; font-size:11px; display:flex; align-items:center; justify-content:center; transition:width .6s ease }

/* ====== KBD ====== */
.kbd{ border:1px solid rgba(16,24,40,.12); background:#f7f8fa; border-radius:6px; padding:.18rem .45rem; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px }
.dark .kbd{ background:#1f2937; border-color:#334155 }

/* ====== Animations ====== */
.fade-up{ opacity:0; transform:translateY(8px); animation:fadeUp .4s ease-out forwards }
@keyframes fadeUp{ from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>

<body class="min-h-full flex flex-col text-[15px]">

<!-- Header -->
<header>
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <!-- KCL logo: simple crimson square -->
      <svg width="28" height="28" viewBox="0 0 28 28" class="flex-none" aria-hidden="true">
        <defs>
          <linearGradient id="kclGrad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#d11a34"/><stop offset="100%" stop-color="#c8102e"/>
          </linearGradient>
        </defs>
        <rect width="28" height="28" rx="6" fill="url(#kclGrad)"/>
        <text x="50%" y="56%" text-anchor="middle" font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial" font-size="12" font-weight="700" fill="#ffffff">KCL</text>
      </svg>
      <div>
        <h1>King's College London — PNOMH Graduation Planner</h1>
        <p class="muted text-[13px] -mt-0.5">One module at a time · Foundations → Options → Research → Synoptic</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="darkToggle">Dark mode</button>
    </div>
  </div>
</header>

<!-- Main layout -->
<main class="max-w-6xl mx-auto px-4 py-5 grid md:grid-cols-3 gap-4 w-full">

  <!-- LEFT: Study Plan + Setup -->
  <section class="md:col-span-2 space-y-4 fade-up">
    <!-- Study Plan -->
    <div class="card p-0 shadow-card overflow-hidden">
      <div class="px-4 pt-3 pb-2 border-b border-slate-200/70 dark:border-white/10 bg-white/70 dark:bg-[#0b1220]/70">
        <h3>Study Plan</h3>
      </div>

      <div id="timeline" class="grid gap-2 max-h-[560px] overflow-y-auto p-4 pt-3"></div>

      <div class="px-4 pb-4 -mt-1">
        <div class="text-[14px] flex flex-wrap gap-2 items-center">
          <strong>Progress:</strong>
          <span class="kbd">Foundation <span id="pf">0</span>/<span id="rf">4</span></span>
          <span class="kbd">Options <span id="po">0</span>/<span id="ro">4</span></span>
          <span class="kbd">Research <span id="pr">0</span>/<span id="rr">2</span></span>
          <span class="kbd">Synoptic <span id="ps">0</span>/<span id="rs">1</span></span>
        </div>

        <div class="mt-3 prog-outer">
          <div id="progFill" class="prog-fill" style="width:0%">0%</div>
        </div>

        <div id="gradBox" class="hidden mt-3 p-3 rounded border-2 border-emerald-300 bg-emerald-50/80 dark:bg-[#0a1f17] dark:border-emerald-900 font-semibold text-[14px]">
          Estimated Graduation: <span id="gradTxt" class="ml-1 text-emerald-700 dark:text-emerald-300"></span>
        </div>

        <div id="impactBox" class="hidden mt-3 p-3 rounded border border-slate-200/70 dark:border-white/10 bg-white/70 dark:bg-white/5 text-[14px]">
          <strong>Impact:</strong>
          Baseline <span id="impBase" class="font-semibold"></span>
          → Your plan <span id="impPlan" class="font-semibold"></span>
          <span id="impDelta" class="ml-2 font-semibold"></span>
          <canvas id="impactChart" width="640" height="120" class="mt-3 w-full rounded-md border border-slate-200/70 dark:border-white/10 bg-white/80 dark:bg-[#0b1220]/70"></canvas>
        </div>
      </div>
    </div>

    <!-- Setup (compact) -->
    <div class="card p-3">
      <div class="flex items-start justify-between">
        <h3>Setup</h3>
        <div class="flex items-center gap-2">
          <button id="quickFillBtn" class="btn-primary">Quick Fill</button>
          <button id="resetBtn" class="btn-ghost">Reset</button>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 mt-3">
        <div>
          <label class="block text-[12px] muted mb-1">Award</label>
          <select id="award" class="w-full border rounded px-2 py-2 text-[14px] bg-white dark:bg-[#0f172a] border-slate-200/70 dark:border-white/10">
            <option value="PGCert">PG Cert (60c)</option>
            <option value="PGDip">PG Dip (120c)</option>
            <option value="MSc" selected>MSc (180c)</option>
          </select>
        </div>
        <div>
          <label class="block text-[12px] muted mb-1">Start</label>
          <select id="start" class="w-full border rounded px-2 py-2 text-[14px] bg-white dark:bg-[#0f172a] border-slate-200/70 dark:border-white/10"></select>
        </div>
      </div>
      <div id="phaseInfo" class="mt-3 rounded-md p-3 text-[14px] font-semibold bg-slate-50/80 dark:bg-[#0f172a]/60 border border-slate-200/70 dark:border-white/10"></div>
    </div>
  </section>

  <!-- RIGHT: Options + Analytics -->
  <aside class="space-y-4 fade-up">
    <!-- Options -->
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h3>Choose 4 Options</h3>
        <span class="text-[12px] text-slate-600 dark:text-slate-300"><span id="optCount">0</span>/4</span>
      </div>
      <div id="opts"></div>
      <div id="warnBox" class="hidden mt-3 text-[13px] text-amber-800 bg-amber-50/90 dark:bg-[#3a2b06] dark:text-amber-200 border border-amber-200 dark:border-amber-800 rounded p-2">
        Please select 4 option modules.
      </div>
    </div>

    <!-- Analytics (compact) -->
    <div class="card p-4">
      <h3 class="mb-3">Analytics</h3>
      <div class="grid grid-cols-2 gap-2">
        <div class="rounded-lg text-center text-white p-3" style="background:linear-gradient(135deg,#5b8def,#7a6bf2)">
          <div class="text-[12px] opacity-90">Duration</div>
          <div id="vDur" class="text-[20px] font-bold">—</div>
          <div class="text-[12px] opacity-90">months</div>
        </div>
        <div class="rounded-lg text-center text-white p-3" style="background:linear-gradient(135deg,#f093fb,#ef5a8f)">
          <div class="text-[12px] opacity-90">Breaks</div>
          <div id="vBrk" class="text-[20px] font-bold">0</div>
        </div>
        <div class="rounded-lg text-center text-white p-3" style="background:linear-gradient(135deg,#34b3f1,#20e3b2)">
          <div class="text-[12px] opacity-90">Progress</div>
          <div id="vPct" class="text-[20px] font-bold">0%</div>
        </div>
        <div class="rounded-lg text-center text-white p-3" style="background:linear-gradient(135deg,#43e97b,#38f9d7)">
          <div class="text-[12px] opacity-90">Graduation</div>
          <div id="vGrad" class="text-[20px] font-bold">—</div>
        </div>
      </div>
      <div class="my-3 prog-outer">
        <div id="progFillClone" class="prog-fill" style="width:0%">0%</div>
      </div>
      <div>
        <h4 class="text-[14px] font-semibold mb-2">Break Impact</h4>
        <div id="breakImpact" class="text-[13px] text-slate-600 dark:text-slate-300">Select modules to see impact</div>
      </div>
    </div>
  </aside>
</main>

<!-- Toasts -->
<div id="toast" class="fixed top-4 right-4 space-y-2 z-50"></div>

<script>
/* ============ Data ============ */
const F=['Biological Foundations of Mental Health','Techniques in Neuroscience','Psychological Foundations of Mental Health','Mental Health in the Community'];
const O=['Mindfulness: Neuroscience & Application','Global Mental Health','Psychology & Neuroscience of Addiction','Child & Adolescent Mental Health','Social, Genetic & Environmental Basis of Mental Health','Neuroscience in Society','Psychology & Neuroscience of Affective Disorders','Psychology & Neuroscience of Psychosis','Neuroimaging in Mental Health','Pharmacotherapies in Mental Health'];
const R=['Research Skills: From Reviewing & Critical Analysis to Research Ethics','Research Skills: From Methods & Procedures to Analysis & Reporting'];
const S=['Independent Synoptic Project'];
const REQ={PGCert:{f:4,o:0,r:0,s:0},PGDip:{f:4,o:4,r:0,s:0},MSc:{f:4,o:4,r:2,s:1}};
const SCH={"2023-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics"],"2023-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2023-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2023-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2023-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2023-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-01":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-03":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-05":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-06":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-09":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-10":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-01":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-03":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-05":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-06":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-09":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-10":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"]};
const keys=Object.keys(SCH).sort();

/* ============ State & helpers ============ */
const state={ award:'MSc', start:'2023-09', options:[], breaks:new Set(), taken:new Map(), dark:false };
const $=s=>document.querySelector(s);
const el=(t,c='',h='')=>{ const d=document.createElement(t); if(c)d.className=c; if(h)d.innerHTML=h; return d; };
const addY=(k,y)=>{ const [yr,m]=k.split('-').map(Number); return `${yr+y}-${String(m).padStart(2,'0')}`; }
const fmtD=k=>{ const [y,m]=k.split('-').map(Number); return new Date(y,m-1,1).toLocaleString('en-GB',{month:'short',year:'numeric'}); }
const getType=m=> F.includes(m)?'f':O.includes(m)?'o':R.includes(m)?'r':S.includes(m)?'s':'u';
const countTaken=()=>{ const c={f:0,o:0,r:0,s:0}; state.taken.forEach(v=>c[getType(v)]++); return c; };
const req=()=>({...REQ[state.award]});
let genTimer; const regen=()=>{ clearTimeout(genTimer); genTimer=setTimeout(gen,60); };

// persistence
function save(){ const payload={...state, breaks:[...state.breaks], taken:[...state.taken]}; localStorage.setItem('planner.kcl.final.v1', JSON.stringify(payload)); }
function load(){
  try{
    const raw=localStorage.getItem('planner.kcl.final.v1'); if(!raw) return;
    const obj=JSON.parse(raw);
    state.award=obj.award ?? state.award;
    state.start=obj.start ?? state.start;
    state.options=obj.options ?? [];
    state.breaks=new Set(obj.breaks ?? []);
    state.taken=new Map(obj.taken ?? []);
    state.dark=!!obj.dark;
  }catch{}
}
function toast(msg, kind='info'){
  const box=$("#toast");
  const tone = kind==='ok' ? 'border-emerald-300 bg-emerald-50/95 dark:bg-[#0a1f17] dark:border-emerald-900'
            : kind==='warn'? 'border-amber-300 bg-amber-50/95 dark:bg-[#3a2b06] dark:border-amber-900'
            : 'border-sky-300 bg-sky-50/95 dark:bg-[#0b1d2b] dark:border-sky-900';
  const n=el('div',`card px-3 py-2 text-sm border-2 ${tone}`); n.style.boxShadow='0 8px 20px rgba(16, 24, 40, .08)';
  n.textContent=msg; box.appendChild(n); setTimeout(()=>n.remove(),2200);
}

/* ============ Init ============ */
function init(){
  load();

  // dark mode
  if(state.dark) document.documentElement.classList.add('dark');
  $("#darkToggle").textContent = state.dark ? 'Light mode' : 'Dark mode';
  $("#darkToggle").addEventListener('click',()=>{
    state.dark=!state.dark;
    document.documentElement.classList.toggle('dark', state.dark);
    $("#darkToggle").textContent = state.dark ? 'Light mode' : 'Dark mode';
    save();
  });

  // start select
  const startS=$("#start");
  keys.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=fmtD(k); startS.appendChild(o); });
  startS.value=state.start; startS.addEventListener('change',e=>{ state.start=e.target.value; regen(); save(); });

  // award
  $("#award").value=state.award;
  $("#award").addEventListener('change',e=>{ state.award=e.target.value; regen(); save(); });

  // options chips
  const optsW=$("#opts"); optsW.innerHTML='';
  O.forEach(n=>{
    const b=el('button','chip'); b.dataset.name=n; b.textContent=n;
    if(state.options.includes(n)) b.classList.add('on');
    b.addEventListener('click',()=>{
      const on=b.classList.contains('on'); let selected=new Set(state.options);
      if(on){ selected.delete(n); } else { if(selected.size>=4){ toast('You can only select 4 options','warn'); return; } selected.add(n); }
      state.options=[...selected]; $("#optCount").textContent=state.options.length; b.classList.toggle('on'); regen(); save();
    });
    optsW.appendChild(b);
  });
  $("#optCount").textContent=state.options.length;

  // actions
  $("#quickFillBtn").addEventListener('click', quickFill);
  $("#resetBtn").addEventListener('click', resetPlan);

  gen();
}

/* ============ Render ============ */
function gen(){
  const r=req();
  const warnBox=$("#warnBox");
  if(r.o>0 && state.options.length<4) warnBox.classList.remove('hidden'); else warnBox.classList.add('hidden');

  renderPhase();
  renderTimeline();
  renderAnalytics();
  renderImpact();
  updateBreakImpact();
  save();
}
function renderPhase(){
  const r=req(); const tkn=countTaken(); const box=$("#phaseInfo");
  let txt='', cls='';
  if(tkn.f<r.f){ txt='Phase 1: Foundation Modules (complete all 4 first)'; cls='bg-blue-50/80 dark:bg-[#0c1b2a]/60 border border-blue-100/70 dark:border-blue-900/40'; }
  else if(tkn.o<r.o){ txt='Phase 2: Options (choose 4 from your selection)'; cls='bg-blue-50/80 dark:bg-[#0c1b2a]/60 border border-blue-100/70 dark:border-blue-900/40'; }
  else if(tkn.r<r.r){ txt='Phase 3: Research Skills'; cls='bg-teal-50/80 dark:bg-[#0a1f1c]/60 border border-teal-100/70 dark:border-teal-900/40'; }
  else if(tkn.s<r.s){ txt='Phase 4: Synoptic Project'; cls='bg-teal-50/80 dark:bg-[#0a1f1c]/60 border border-teal-100/70 dark:border-teal-900/40'; }
  else { txt='All Phases Complete'; cls='bg-emerald-50/80 dark:bg-[#0f2a1f]/60 border border-emerald-200/70 dark:border-emerald-900/40'; }
  box.className=`mt-3 rounded-md p-3 text-[14px] font-semibold ${cls}`;
  box.textContent=txt;
}
const yearFromKey=k=>k.split('-')[0];
function renderTimeline(){
  const tl=$("#timeline"); tl.innerHTML='';
  const horizonStop=addY(state.start,6);
  const span=keys.filter(k=>k>=state.start && k<=horizonStop);

  let currentYear='';
  span.forEach(k=>{
    const y=yearFromKey(k);
    if(y!==currentYear){ currentYear=y; tl.appendChild(el('div','mt-2 mb-1 text-[13px] font-bold text-slate-700 dark:text-slate-300', y)); }

    const isBreak=state.breaks.has(k);
    const tkMod=state.taken.get(k);
    const card=el('div','term-card p-3');

    // header controls
    const hdr=el('div','flex items-center justify-between mb-1');
    const ttl=el('div','text-[14px] font-semibold', fmtD(k));
    const ctrl=el('div','flex gap-1');
    if(isBreak){
      const b=el('button','btn-ghost text-[12px] py-1','Break'); b.addEventListener('click',()=>{ state.breaks.delete(k); regen(); }); ctrl.appendChild(b);
    } else if(tkMod){
      const t=el('button','text-[12px] border border-emerald-200/70 dark:border-emerald-900/40 rounded px-2 py-1 bg-emerald-50/80 dark:bg-[#0a1f17]','Taken');
      t.addEventListener('click',()=>{ state.taken.delete(k); regen(); });
      const b=el('button','btn-ghost text-[12px] py-1','Set Break'); b.addEventListener('click',()=>{ state.breaks.add(k); state.taken.delete(k); regen(); });
      ctrl.appendChild(t); ctrl.appendChild(b);
    } else {
      const b=el('button','btn-ghost text-[12px] py-1','Set Break'); b.addEventListener('click',()=>{ state.breaks.add(k); regen(); }); ctrl.appendChild(b);
    }
    hdr.appendChild(ttl); hdr.appendChild(ctrl); card.appendChild(hdr);

    // choices or taken
    if(!isBreak && !tkMod){
      const mds=SCH[k]||[]; const block=el('div','space-y-1'); const r=req(); const tkn=countTaken();
      if(tkn.f<r.f){
        renderChoices(block,k,mds.filter(m=>F.includes(m) && ![...state.taken.values()].includes(m)),'f');
      } else if(tkn.o<r.o){
        renderChoices(block,k,mds.filter(m=>state.options.includes(m) && ![...state.taken.values()].includes(m)),'o');
      } else if(tkn.r<r.r){
        renderChoices(block,k,mds.filter(m=>R.includes(m) && ![...state.taken.values()].includes(m)),'r');
      } else if(tkn.s<r.s){
        renderChoices(block,k,mds.filter(m=>S.includes(m)),'s');
      } else {
        card.appendChild(el('div','text-[13px] text-slate-600 dark:text-slate-400','All requirements complete'));
      }
      card.appendChild(block);
    } else if(tkMod){
      card.appendChild(el('div','mt-1 text-[13px] font-semibold rounded border border-emerald-200/70 dark:border-emerald-900/40 px-2 py-1 bg-emerald-50/80 dark:bg-[#0a1f17]', tkMod));
    }

    tl.appendChild(card);
  });

  // graduation
  const ge=$("#gradBox"); const lastK=[...state.taken.keys()].sort().pop(); const r=req(); const tkn=countTaken();
  const reqOK=tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s>=r.s;
  if(lastK && reqOK){ ge.classList.remove('hidden'); $("#gradTxt").textContent=fmtD(lastK); } else { ge.classList.add('hidden'); }
}
function renderChoices(container,k,list,stage){
  if(list.length===0){
    const msg = stage==='f' ? 'No eligible foundation modules'
              : stage==='o' ? 'No eligible options available'
              : stage==='r' ? 'Complete 4 foundations + 4 options first'
              : 'Complete research modules first';
    container.appendChild(el('div','text-[13px] text-slate-600 dark:text-slate-400', msg)); return;
  }
  list.forEach(m=>{
    const btn=el('button','w-full text-left text-[13px] border border-slate-200/70 dark:border-white/10 rounded px-2 py-1 bg-white/85 dark:bg-[#0f172a]/70 hover:bg-white dark:hover:bg-[#141a2a]');
    btn.textContent=m;
    btn.addEventListener('click',()=>{
      state.taken.set(k,m);
      if(stage==='s'){ const i=keys.indexOf(k); const nk=keys[i+1]; if(nk) state.taken.set(nk,m); }
      regen();
    });
    container.appendChild(btn);
  });
}
function renderAnalytics(){
  const r=req(); const tkn=countTaken(); const lastK=[...state.taken.keys()].sort().pop();

  if(lastK){
    const totalPeriods=keys.filter(k=>k>=state.start && k<=lastK).length;
    const studyPeriods=Math.max(0,totalPeriods - state.breaks.size);
    const months=studyPeriods*2; animateNumber($("#vDur"), months);
  } else { $("#vDur").textContent='—'; }

  animateNumber($("#vBrk"), state.breaks.size);

  const tot=r.f+r.o+r.r+r.s; const cur=tkn.f+tkn.o+tkn.r+tkn.s; const pct=tot?Math.round((cur/tot)*100):0;
  animateNumber($("#vPct"), pct, '%');
  const pf=$("#progFill"), pf2=$("#progFillClone"); pf.style.width=pct+'%'; pf.textContent=pct+'%'; pf2.style.width=pct+'%'; pf2.textContent=pct+'%';

  if(lastK){ $("#vGrad").innerHTML = fmtD(lastK).replace(' ','<br>'); } else { $("#vGrad").textContent='—'; }

  $("#pf").textContent=tkn.f; $("#rf").textContent=r.f;
  $("#po").textContent=tkn.o; $("#ro").textContent=r.o;
  $("#pr").textContent=tkn.r; $("#rr").textContent=r.r;
  $("#ps").textContent=tkn.s; $("#rs").textContent=r.s;
}
function renderImpact(){
  const box=$("#impactBox"); if(state.taken.size===0){ box.classList.add('hidden'); return; }
  const base=calcBaseline(); const lastK=[...state.taken.keys()].sort().pop(); if(!(base && lastK)){ box.classList.add('hidden'); return; }

  const bPeriods=keys.filter(k=>k>=state.start && k<=base).length;
  const cPeriods=keys.filter(k=>k>=state.start && k<=lastK).length;
  const delay=(cPeriods-bPeriods)*2 - state.breaks.size*2;

  $("#impBase").textContent=fmtD(base); $("#impPlan").textContent=fmtD(lastK);
  const d=$("#impDelta"); d.textContent=(delay>0?'+':'')+delay+' months';
  d.className='ml-2 font-semibold ' + (delay>0?'text-amber-700':'text-emerald-600');

  box.classList.remove('hidden');
  drawImpactChart('impactChart',{ baselinePeriods:bPeriods, currentPeriods:cPeriods, breaks:[...state.breaks].length });
}
function calcBaseline(){
  const r=req(); const taken2=new Map(); let tkn={f:0,o:0,r:0,s:0};
  const hs=addY(state.start,6); const itk=keys.filter(k=>k>=state.start && k<=hs);
  for(const k of itk){
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s>=r.s) break;
    const mds=SCH[k]||[];
    if(tkn.f<r.f){
      const m=mds.find(x=>F.includes(x) && ![...taken2.values()].includes(x));
      if(m){ taken2.set(k,m); tkn.f++; continue; }
    }
    if(tkn.f>=r.f && tkn.o<r.o){
      const m=mds.find(x=>state.options.includes(x) && ![...taken2.values()].includes(x));
      if(m){ taken2.set(k,m); tkn.o++; continue; }
    }
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r<r.r){
      const m=mds.find(x=>R.includes(x) && ![...taken2.values()].includes(x));
      if(m){ taken2.set(k,m); tkn.r++; continue; }
    }
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s<r.s){
      const m=mds.find(x=>S.includes(x));
      if(m){ taken2.set(k,m); const ni=itk.indexOf(k); if(ni>=0 && ni<itk.length-1) taken2.set(itk[ni+1],m); tkn.s++; break; }
    }
  }
  return [...taken2.keys()].sort().pop();
}

/* ============ Actions ============ */
function quickFill(){
  const r=req(); if(r.o>0 && state.options.length<4){ toast('Please select 4 option modules first','warn'); return; }
  const before=state.taken.size; const hs=addY(state.start,6); const itk=keys.filter(k=>k>=state.start && k<=hs); let tkn=countTaken();

  for(const k of itk){
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s>=r.s) break;
    if(state.taken.has(k) || state.breaks.has(k)) continue;
    const mds=SCH[k]||[];
    if(tkn.f<r.f){
      const m=mds.find(x=>F.includes(x) && ![...state.taken.values()].includes(x)); if(m){ state.taken.set(k,m); tkn.f++; continue; }
    }
    if(tkn.f>=r.f && tkn.o<r.o){
      const m=mds.find(x=>state.options.includes(x) && ![...state.taken.values()].includes(x)); if(m){ state.taken.set(k,m); tkn.o++; continue; }
    }
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r<r.r){
      const m=mds.find(x=>R.includes(x) && ![...state.taken.values()].includes(x)); if(m){ state.taken.set(k,m); tkn.r++; continue; }
    }
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s<r.s){
      const m=mds.find(x=>S.includes(x)); if(m){ state.taken.set(k,m); const ni=itk.indexOf(k); const nk=itk[ni+1]; if(nk) state.taken.set(nk,m); tkn.s++; break; }
    }
  }

  const added=state.taken.size-before; regen(); if(added>0) toast(`Added ${added} module${added>1?'s':''} to your plan`,'ok'); else toast('No suitable modules found to add','warn');
}
function resetPlan(){
  if(!confirm('Reset everything? This cannot be undone.')) return;
  state.taken.clear(); state.breaks.clear(); state.options=[]; state.award='MSc'; state.start=keys.find(k=>k>='2023-09')||keys[0];
  $("#award").value=state.award; $("#start").value=state.start;
  document.querySelectorAll('#opts .chip').forEach(c=>c.classList.remove('on')); $("#optCount").textContent='0';
  regen(); toast('Plan reset successfully','ok');
}

/* ============ Analytics helpers ============ */
function updateBreakImpact(){
  const el=$("#breakImpact"); const base=calcBaseline(); const lastK=[...state.taken.keys()].sort().pop();
  if(state.breaks.size===0){ el.textContent='No breaks selected'; return; }
  if(base && lastK){
    const bP=keys.filter(k=>k>=state.start && k<=base).length;
    const cP=keys.filter(k=>k>=state.start && k<=lastK).length;
    const delay=(cP-bP)*2;
    el.innerHTML=`${state.breaks.size} break(s) = <span class="${delay>0?'text-amber-700':'text-emerald-600'} font-semibold">${delay>0?'+':''}${delay} months</span>`;
  } else el.textContent = `${state.breaks.size} break(s) selected`;
}
function drawImpactChart(id,{baselinePeriods,currentPeriods,breaks}){
  const c=document.getElementById(id); const ctx=c.getContext('2d'); const w=c.width,h=c.height;
  ctx.clearRect(0,0,w,h);
  const pad=30; const maxX=Math.max(baselinePeriods,currentPeriods)||1; const maxY=maxX;
  ctx.strokeStyle='#9aa4b2'; ctx.globalAlpha=.55; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.moveTo(pad,h-pad); ctx.lineTo(pad,pad); ctx.stroke(); ctx.globalAlpha=1;
  const x=v=>pad+(w-2*pad)*(v/maxX); const y=v=>(h-pad)-(h-2*pad)*(v/maxY);
  ctx.strokeStyle='#3aa6e9'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x(0),y(0)); ctx.lineTo(x(baselinePeriods),y(baselinePeriods)); ctx.stroke();
  ctx.strokeStyle='#06b6d4'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x(0),y(0)); ctx.lineTo(x(currentPeriods),y(currentPeriods)); ctx.stroke();
  if(breaks>0){ ctx.fillStyle='#f59e0b'; for(let i=1;i<=breaks;i++){ const bx=x(currentPeriods*(i/(breaks+1))); const by=y(currentPeriods*(i/(breaks+1))); ctx.beginPath(); ctx.arc(bx,by,3,0,Math.PI*2); ctx.fill(); } }
  ctx.fillStyle='#9aa4b2'; ctx.font='10px Inter, system-ui, sans-serif'; ctx.fillText('Terms', w/2-14, h-8); ctx.save(); ctx.translate(12,h/2+20); ctx.rotate(-Math.PI/2); ctx.fillText('Cumulative terms',0,0); ctx.restore();
  ctx.fillStyle='#3aa6e9'; ctx.fillText('Baseline', w-90, 20); ctx.fillStyle='#06b6d4'; ctx.fillText('Your plan', w-90, 34); ctx.fillStyle='#f59e0b'; ctx.fillText('Breaks', w-90, 48);
}
function animateNumber(node,value,suffix=''){
  const target=Number(value); const curr=Number((node.textContent||'0').replace('%',''))||0;
  const steps=12; const delta=(target-curr)/steps; let i=0;
  const tick=()=>{ i++; const val=i<steps?Math.round(curr+delta*i):target; node.textContent=val+(suffix||''); if(i<steps) requestAnimationFrame(tick); };
  requestAnimationFrame(tick);
}

/* ============ Boot ============ */
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
