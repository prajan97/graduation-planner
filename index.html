<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KCL PNOMH Graduation Planner</title>
  <style>
    :root{--kcl-red:#d50032;--ink:#111827;--muted:#6b7280;--bg:#fafafa;--card:#fff;--line:#e5e7eb;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--chip:#f3f4f6}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,sans-serif;line-height:1.5}
    header{background:var(--kcl-red);color:#fff;padding:1.25rem}
    header h1{font-size:1.5rem;font-weight:700}
    header .sub{opacity:.9;font-size:.9rem;margin-top:.25rem}
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .grid{display:grid;gap:1rem;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:1rem}
    h3{font-size:1.1rem;margin-bottom:.75rem}
    label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:.35rem;font-weight:500}
    select,button{width:100%;padding:.6rem;border-radius:8px;border:1px solid var(--line);background:#fff;font-size:.9rem}
    button{cursor:pointer;font-weight:600}
    .btn{background:var(--kcl-red);color:#fff;border:none}
    .btn:hover{opacity:.9}
    .btn.secondary{background:#fff;color:var(--ink)}
    .btn.secondary:hover{background:#f9fafb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.75rem}
    .row-btns{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .tags{display:flex;gap:.4rem;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:.25rem .6rem;font-size:.75rem;cursor:pointer;user-select:none}
    .chip input{margin-right:.35rem}
    .timeline{display:grid;gap:.65rem}
    .term{border:1px solid var(--line);border-radius:8px;padding:.75rem;background:#fff;cursor:pointer;transition:all .2s}
    .term:hover{border-color:#cbd5e1;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .termHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem}
    .termTitle{font-weight:700;font-size:.95rem}
    .moduleTag{border:1px dashed #cbd5e1;background:#f8fafc;border-radius:8px;padding:.4rem .6rem;font-size:.8rem;display:inline-block}
    .syn{background:#fef2f2;border-color:#fecaca}
    .break{background:#fff7ed;border-color:#fed7aa}
    .kbd{border:1px solid var(--line);background:#f9fafb;border-radius:4px;font-size:.75rem;padding:.2rem .4rem;font-family:monospace}
    .ok{color:var(--ok);font-weight:600}
    .warn{color:var(--warn);font-weight:600}
    .bad{color:var(--bad);font-weight:600}
    .summary{margin-top:.5rem;padding:.75rem;background:#f9fafb;border-radius:8px;font-size:.85rem}
    .grad-box{background:#f0f9ff;border:2px solid #0ea5e9;border-radius:8px;padding:.75rem;margin-top:.65rem;font-weight:600}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>King's College London ‚Äî PNOMH Graduation Planner</h1>
      <div class="sub">Accurate 2024-2027 schedule with prerequisites and study break planning</div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <h3>1) Your Setup</h3>
      <div class="row">
        <div>
          <label for="award">Intended Award</label>
          <select id="award">
            <option value="PGCert">PG Cert (60 credits)</option>
            <option value="PGDip">PG Dip (120 credits)</option>
            <option value="MSc" selected>MSc (180 credits)</option>
          </select>
        </div>
        <div>
          <label for="start">Start Teaching Window</label>
          <select id="start"></select>
        </div>
      </div>
      <div>
        <label for="breaks">Study Breaks (optional - select multiple)</label>
        <select id="breaks" multiple style="height:80px"></select>
      </div>
      <div class="row-btns" style="margin-top:.75rem">
        <button id="generate" class="btn">Generate Plan</button>
        <button id="clearBreaks" class="btn secondary">Clear Breaks</button>
      </div>
    </section>

    <section class="card">
      <h3>2) Choose Your 4 Options</h3>
      <div class="tags" id="options"></div>
      <div id="warningBox" style="margin-top:.75rem;padding:.6rem;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;font-size:.85rem;display:none"></div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <h3>3) Your Study Plan</h3>
      <div class="tags" style="margin-bottom:.75rem">
        <span class="chip" style="background:#dbeafe;border-color:#93c5fd">üü¶ Foundation</span>
        <span class="chip" style="background:#fee2e2;border-color:#fca5a5">üü• Option</span>
        <span class="chip" style="background:#e9d5ff;border-color:#c084fc">üü™ Research</span>
        <span class="chip" style="background:#f3f4f6;border-color:#9ca3af">‚¨õ Synoptic (2 periods)</span>
        <span class="chip" style="background:#fef3c7;border-color:#fcd34d">‚è±Ô∏è 2-yr target</span>
        <span class="chip" style="background:#fee2e2;border-color:#f87171">üö´ 6-yr maximum</span>
      </div>
      <div id="timeline" class="timeline"></div>
      <div class="summary" id="summary"></div>
      <div id="graduation" class="grad-box" style="display:none"></div>
      <div id="impact" style="margin-top:.75rem;padding:.75rem;background:#f9fafb;border-radius:8px;font-size:.85rem"></div>
    </section>
  </main>

  <script>
    // ===== CORRECTED MODULE DATA =====
    const FOUNDATIONS = [
      'Biological Foundations of Mental Health',
      'Techniques in Neuroscience',
      'Psychological Foundations of Mental Health',
      'Mental Health in the Community'
    ];

    const OPTIONS_LIST = [
      'Mindfulness: Neuroscience & Application',
      'Global Mental Health',
      'Psychology & Neuroscience of Addiction',
      'Child & Adolescent Mental Health',
      'Social, Genetic & Environmental Basis of Mental Health',
      'Neuroscience in Society',
      'Psychology & Neuroscience of Affective Disorders',
      'Psychology & Neuroscience of Psychosis',
      'Neuroimaging in Mental Health',
      'Pharmacotherapies in Mental Health',
      'Contemporary Advances in Neuroscience',
      'Neurodevelopmental Disorders: from Bench to Bedside'
    ];

    const RESEARCH = [
      'Research Skills: From Reviewing & Critical Analysis to Research Ethics',
      'Research Skills: From Methods & Procedures to Analysis & Reporting'
    ];

    const SYNOPTIC = ['Independent Synoptic Project'];

    const GROUP = {
      FOUNDATION: 'foundation',
      OPTIONS: 'options',
      RESEARCH: 'research',
      SYNOPTIC: 'synoptic'
    };

    // ===== CORRECTED SCHEDULE DATA (2024-2027) =====
    const SCHEDULE = {
      '2024-09': ['Mental Health in the Community', 'Child & Adolescent Mental Health', 'Global Mental Health', 'Neurodevelopmental Disorders: from Bench to Bedside', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics'],
      '2024-10': ['Biological Foundations of Mental Health', 'Psychology & Neuroscience of Addiction', 'Mindfulness: Neuroscience & Application', 'Contemporary Advances in Neuroscience', 'Research Skills: From Methods & Procedures to Analysis & Reporting'],
      '2025-01': ['Techniques in Neuroscience', 'Psychology & Neuroscience of Affective Disorders', 'Neuroscience in Society', 'Social, Genetic & Environmental Basis of Mental Health', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2025-03': ['Psychological Foundations of Mental Health', 'Psychology & Neuroscience of Psychosis', 'Neuroimaging in Mental Health', 'Pharmacotherapies in Mental Health', 'Research Skills: From Methods & Procedures to Analysis & Reporting', 'Independent Synoptic Project'],
      '2025-05': ['Mental Health in the Community', 'Child & Adolescent Mental Health', 'Global Mental Health', 'Neurodevelopmental Disorders: from Bench to Bedside', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2025-06': ['Biological Foundations of Mental Health', 'Psychology & Neuroscience of Addiction', 'Mindfulness: Neuroscience & Application', 'Contemporary Advances in Neuroscience', 'Research Skills: From Methods & Procedures to Analysis & Reporting', 'Independent Synoptic Project'],
      '2025-09': ['Mental Health in the Community', 'Child & Adolescent Mental Health', 'Global Mental Health', 'Neurodevelopmental Disorders: from Bench to Bedside', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2025-10': ['Biological Foundations of Mental Health', 'Psychology & Neuroscience of Addiction', 'Mindfulness: Neuroscience & Application', 'Research Skills: From Methods & Procedures to Analysis & Reporting'],
      '2026-01': ['Techniques in Neuroscience', 'Psychology & Neuroscience of Affective Disorders', 'Neuroscience in Society', 'Social, Genetic & Environmental Basis of Mental Health', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2026-03': ['Psychological Foundations of Mental Health', 'Psychology & Neuroscience of Psychosis', 'Neuroimaging in Mental Health', 'Pharmacotherapies in Mental Health', 'Research Skills: From Methods & Procedures to Analysis & Reporting', 'Independent Synoptic Project'],
      '2026-05': ['Mental Health in the Community', 'Child & Adolescent Mental Health', 'Global Mental Health', 'Neurodevelopmental Disorders: from Bench to Bedside', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2026-06': ['Psychological Foundations of Mental Health', 'Psychology & Neuroscience of Psychosis', 'Neuroimaging in Mental Health', 'Research Skills: From Methods & Procedures to Analysis & Reporting', 'Independent Synoptic Project'],
      '2026-09': ['Techniques in Neuroscience', 'Psychology & Neuroscience of Affective Disorders', 'Neuroscience in Society', 'Social, Genetic & Environmental Basis of Mental Health', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2026-10': ['Psychological Foundations of Mental Health', 'Psychology & Neuroscience of Psychosis', 'Neuroimaging in Mental Health', 'Research Skills: From Methods & Procedures to Analysis & Reporting'],
      '2027-01': ['Techniques in Neuroscience', 'Psychology & Neuroscience of Affective Disorders', 'Neuroscience in Society', 'Social, Genetic & Environmental Basis of Mental Health', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2027-03': ['Psychological Foundations of Mental Health', 'Psychology & Neuroscience of Psychosis', 'Neuroimaging in Mental Health', 'Research Skills: From Methods & Procedures to Analysis & Reporting', 'Independent Synoptic Project'],
      '2027-05': ['Mental Health in the Community', 'Child & Adolescent Mental Health', 'Global Mental Health', 'Neurodevelopmental Disorders: from Bench to Bedside', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2027-06': ['Biological Foundations of Mental Health', 'Psychology & Neuroscience of Addiction', 'Mindfulness: Neuroscience & Application', 'Contemporary Advances in Neuroscience', 'Research Skills: From Methods & Procedures to Analysis & Reporting', 'Independent Synoptic Project'],
      '2027-09': ['Techniques in Neuroscience', 'Psychology & Neuroscience of Affective Disorders', 'Neuroscience in Society', 'Social, Genetic & Environmental Basis of Mental Health', 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Independent Synoptic Project'],
      '2027-10': ['Psychological Foundations of Mental Health', 'Psychology & Neuroscience of Psychosis', 'Neuroimaging in Mental Health', 'Research Skills: From Methods & Procedures to Analysis & Reporting']
    };

    const REQUIREMENTS = {
      PGCert: { foundation: 4, options: 0, research: 0, synoptic: 0 },
      PGDip: { foundation: 4, options: 4, research: 0, synoptic: 0 },
      MSc: { foundation: 4, options: 4, research: 2, synoptic: 1 }
    };

    const keys = Object.keys(SCHEDULE).sort();
    const selectedBreaks = new Set();

    // ===== POPULATE START SELECTOR =====
    const startSel = document.getElementById('start');
    keys.forEach(k => {
      const [y, m] = k.split('-').map(Number);
      const d = new Date(y, m - 1, 1);
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = d.toLocaleString('en-GB', { month: 'short', year: 'numeric' });
      startSel.appendChild(opt);
    });
    startSel.value = '2024-09';

    // ===== POPULATE OPTIONS CHECKBOXES =====
    const optsWrap = document.getElementById('options');
    OPTIONS_LIST.forEach(name => {
      const id = 'opt-' + name.replace(/[^a-z0-9]/gi, '');
      const lbl = document.createElement('label');
      lbl.className = 'chip';
      lbl.innerHTML = `<input type="checkbox" id="${id}" data-name="${name}">${name}`;
      optsWrap.appendChild(lbl);
    });

    function getSelectedOptions() {
      const checked = [...document.querySelectorAll('#options input:checked')].map(cb => cb.dataset.name);
      return checked.slice(0, 4);
    }

    // ===== POPULATE BREAKS SELECTOR =====
    const breaksSel = document.getElementById('breaks');
    function populateBreaksOptions() {
      breaksSel.innerHTML = '';
      const startKey = startSel.value;
      const hardStop = addYears(startKey, 6);
      const avail = keys.filter(k => k >= startKey && k <= hardStop);
      avail.forEach(k => {
        const [y, m] = k.split('-').map(Number);
        const d = new Date(y, m - 1, 1);
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = d.toLocaleString('en-GB', { month: 'short', year: 'numeric' });
        opt.selected = selectedBreaks.has(k);
        breaksSel.appendChild(opt);
      });
    }

    // ===== HELPERS =====
    function addYears(key, yrs) {
      const [y, m] = key.split('-').map(Number);
      return `${y + yrs}-${String(m).padStart(2, '0')}`;
    }

    function nextKey(key) {
      const order = ['01', '03', '05', '06', '09', '10'];
      const [y, m] = key.split('-');
      const i = order.indexOf(m);
      return i < order.length - 1 ? `${y}-${order[i + 1]}` : `${+y + 1}-${order[0]}`;
    }

    function formatDate(key) {
      const [y, m] = key.split('-').map(Number);
      return new Date(y, m - 1, 1).toLocaleString('en-GB', { month: 'short', year: 'numeric' });
    }

    function isDone(taken, req) {
      return taken.foundation >= req.foundation &&
             taken.options >= req.options &&
             taken.research >= req.research &&
             taken.synoptic >= req.synoptic;
    }

    // ===== CORE PLANNING LOGIC =====
    function generatePlan() {
      // Sync breaks
      [...breaksSel.options].forEach(o => {
        if (o.selected) selectedBreaks.add(o.value);
        else selectedBreaks.delete(o.value);
      });

      const award = document.getElementById('award').value;
      const startKey = startSel.value;
      const req = { ...REQUIREMENTS[award] };
      const chosenOpts = getSelectedOptions();

      // Validate options availability
      const warning = document.getElementById('warningBox');
      if (req.options > 0 && chosenOpts.length < 4) {
        warning.textContent = `‚ö†Ô∏è Please select 4 option modules for ${award}`;
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }

      const remaining = {
        foundation: new Set(FOUNDATIONS),
        options: new Set(chosenOpts.length ? chosenOpts : OPTIONS_LIST),
        research: new Set(RESEARCH),
        synoptic: new Set(SYNOPTIC)
      };

      let taken = { foundation: 0, options: 0, research: 0, synoptic: 0 };
      let planned = [];
      const hardStop = addYears(startKey, 6);
      const target = addYears(startKey, 2);
      const iterKeys = keys.filter(k => k >= startKey && k <= hardStop);

      for (const key of iterKeys) {
        if (isDone(taken, req)) break;

        const withinTarget = key <= target;
        const mods = SCHEDULE[key] || [];

        if (selectedBreaks.has(key)) {
          planned.push({ key, module: 'Study Break', group: 'break', withinTarget });
          continue;
        }

        const canSyn = taken.research === 2 && req.synoptic > 0 && remaining.synoptic.size > 0;

        // Priority: Foundation ‚Üí Options ‚Üí Research ‚Üí Synoptic
        let picked = null;

        if (taken.foundation < req.foundation) {
          picked = mods.find(m => remaining.foundation.has(m));
          if (picked) {
            remaining.foundation.delete(picked);
            taken.foundation++;
            planned.push({ key, module: picked, group: GROUP.FOUNDATION, withinTarget });
            continue;
          }
        }

        if (taken.options < req.options) {
          picked = mods.find(m => remaining.options.has(m));
          if (picked) {
            remaining.options.delete(picked);
            taken.options++;
            planned.push({ key, module: picked, group: GROUP.OPTIONS, withinTarget });
            continue;
          }
        }

        if (taken.research < req.research) {
          picked = mods.find(m => remaining.research.has(m));
          if (picked) {
            remaining.research.delete(picked);
            taken.research++;
            planned.push({ key, module: picked, group: GROUP.RESEARCH, withinTarget });
            continue;
          }
        }

        if (canSyn) {
          const next = nextKey(key);
          planned.push({ key, module: SYNOPTIC[0], group: GROUP.SYNOPTIC, withinTarget });
          planned.push({ key: next, module: SYNOPTIC[0] + ' (cont.)', group: GROUP.SYNOPTIC, withinTarget: next <= target });
          taken.synoptic++;
          continue;
        }

        planned.push({ key, module: 'No eligible module', group: 'idle', withinTarget });
      }

      renderTimeline(planned, startKey, target, hardStop, req, taken);
      
      // Calculate baseline for comparison
      const baseline = buildBaseline(award, startKey, chosenOpts);
      renderImpact(baseline, planned);
    }

    // ===== BASELINE (NO BREAKS) =====
    function buildBaseline(award, startKey, chosenOpts) {
      const req = { ...REQUIREMENTS[award] };
      const remaining = {
        foundation: new Set(FOUNDATIONS),
        options: new Set(chosenOpts.length ? chosenOpts : OPTIONS_LIST),
        research: new Set(RESEARCH),
        synoptic: new Set(SYNOPTIC)
      };
      let taken = { foundation: 0, options: 0, research: 0, synoptic: 0 };
      let planned = [];
      const hardStop = addYears(startKey, 6);
      const iterKeys = keys.filter(k => k >= startKey && k <= hardStop);

      for (const key of iterKeys) {
        if (isDone(taken, req)) break;
        const mods = SCHEDULE[key] || [];
        const canSyn = taken.research === 2 && req.synoptic > 0 && remaining.synoptic.size > 0;
        let picked = null;

        if (taken.foundation < req.foundation) {
          picked = mods.find(m => remaining.foundation.has(m));
          if (picked) {
            remaining.foundation.delete(picked);
            taken.foundation++;
            planned.push({ key, module: picked, group: GROUP.FOUNDATION });
            continue;
          }
        }

        if (taken.options < req.options) {
          picked = mods.find(m => remaining.options.has(m));
          if (picked) {
            remaining.options.delete(picked);
            taken.options++;
            planned.push({ key, module: picked, group: GROUP.OPTIONS });
            continue;
          }
        }

        if (taken.research < req.research) {
          picked = mods.find(m => remaining.research.has(m));
          if (picked) {
            remaining.research.delete(picked);
            taken.research++;
            planned.push({ key, module: picked, group: GROUP.RESEARCH });
            continue;
          }
        }

        if (canSyn) {
          const next = nextKey(key);
          planned.push({ key, module: SYNOPTIC[0], group: GROUP.SYNOPTIC });
          planned.push({ key: next, module: SYNOPTIC[0] + ' (cont.)', group: GROUP.SYNOPTIC });
          taken.synoptic++;
          continue;
        }

        planned.push({ key, module: 'No eligible module', group: 'idle' });
      }
      return planned;
    }

    // ===== RENDER TIMELINE =====
    function renderTimeline(planned, startKey, target, hardStop, req, taken) {
      const el = document.getElementById('timeline');
      el.innerHTML = '';

      planned.forEach(item => {
        const term = document.createElement('div');
        term.className = 'term';
        term.dataset.key = item.key;
        term.addEventListener('click', () => {
          if (selectedBreaks.has(item.key)) selectedBreaks.delete(item.key);
          else selectedBreaks.add(item.key);
          populateBreaksOptions();
          generatePlan();
        });

        const title = formatDate(item.key);
        const meta = [];
        if (item.key === target) meta.push('<span class="warn">‚è±Ô∏è 2-yr</span>');
        if (item.key === hardStop) meta.push('<span class="bad">üö´ 6-yr max</span>');

        let content = '';
        if (selectedBreaks.has(item.key)) {
          content = '<span class="moduleTag break">üìÖ Study Break</span>';
        } else if (item.group === 'idle') {
          content = '<span class="moduleTag">‚Äî</span>';
        } else if (item.group === 'break') {
          content = '<span class="moduleTag break">üìÖ Study Break</span>';
        } else {
          const icons = {
            foundation: 'üü¶',
            options: 'üü•',
            research: 'üü™',
            synoptic: '‚¨õ'
          };
          const cls = item.group === 'synoptic' ? 'moduleTag syn' : 'moduleTag';
          content = `<span class="${cls}">${icons[item.group]} ${item.module}</span>`;
        }

        term.innerHTML = `
          <div class="termHeader">
            <div class="termTitle">${title}</div>
            <div class="muted" style="font-size:.8rem">${meta.join(' ')}</div>
          </div>
          <div>${content}</div>
        `;
        el.appendChild(term);
      });

      // Summary
      const summaryEl = document.getElementById('summary');
      summaryEl.innerHTML = `
        <strong>Progress:</strong>
        <span class="kbd">Foundation ${taken.foundation}/${req.foundation}</span>
        <span class="kbd">Options ${taken.options}/${req.options}</span>
        <span class="kbd">Research ${taken.research}/${req.research}</span>
        <span class="kbd">Synoptic ${taken.synoptic}/${req.synoptic}</span>
      `;

      // Graduation
      const last = planned.filter(p => p.group !== 'idle' && p.group !== 'break').pop();
      const gradEl = document.getElementById('graduation');
      if (last && isDone(taken, req)) {
        gradEl.style.display = 'block';
        gradEl.innerHTML = `üéì <strong>Estimated Graduation:</strong> <span class="ok">${formatDate(last.key)}</span>`;
      } else if (last) {
        gradEl.style.display = 'block';
        gradEl.innerHTML = `‚ö†Ô∏è <strong>Incomplete plan</strong> - some requirements not met within 6 years`;
        gradEl.style.background = '#fef2f2';
        gradEl.style.borderColor = '#f87171';
      } else {
        gradEl.style.display = 'none';
      }
    }

    // ===== RENDER IMPACT =====
    function renderImpact(baseline, current) {
      const el = document.getElementById('impact');
      const lastBase = baseline.filter(p => p.group !== 'idle' && p.group !== 'break').pop();
      const lastCurr = current.filter(p => p.group !== 'idle' && p.group !== 'break').pop();

      if (!lastBase || !lastCurr) {
        el.innerHTML = '<strong>Impact Analysis:</strong> Generate a plan to see impact of study breaks';
        return;
      }

      const monthsDiff = (a, b) => {
        const [ay, am] = a.split('-').map(Number);
        const [by, bm] = b.split('-').map(Number);
        return (by - ay) * 12 + (bm - am);
      };

      const delta = monthsDiff(lastBase.key, lastCurr.key);
      const deltaText = delta === 0 ? 'No impact' : `${delta > 0 ? '+' : ''}${delta} months`;
      const color = delta === 0 ? 'var(--ok)' : delta > 0 ? 'var(--warn)' : 'var(--ok)';

      el.innerHTML = `
        <strong>Impact Analysis:</strong>
        Baseline: <strong>${formatDate(lastBase.key)}</strong> ¬∑
        Current: <strong>${formatDate(lastCurr.key)}</strong> ¬∑
        Impact: <strong style="color:${color}">${deltaText}</strong>
      `;
    }

    // ===== EVENT LISTENERS =====
    document.getElementById('generate').addEventListener('click', generatePlan);
    document.getElementById('clearBreaks').addEventListener('click', () => {
      selectedBreaks.clear();
      populateBreaksOptions();
      generatePlan();
    });
    startSel.addEventListener('change', () => {
      populateBreaksOptions();
      generatePlan();
    });

    // ===== INIT =====
    populateBreaksOptions();
    generatePlan();
  </script>
</body>
</html>
