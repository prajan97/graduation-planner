<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCL PNOMH Graduation Planner</title>
    <style>
        :root {
            --primary: #d50032;
            --primary-light: #ff5a5f;
            --secondary: #0055a4;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(213, 0, 50, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        .btn-secondary:hover {
            background-color: #004080;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }

        .btn-group .btn {
            flex: 1;
        }

        .module-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .module-tag {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background-color: #f1f3f4;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .module-tag:hover {
            background-color: #e8eaed;
        }

        .module-tag.selected {
            background-color: #e3f2fd;
            color: var(--secondary);
            font-weight: 600;
        }

        .module-tag input {
            margin: 0;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .analytics-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .analytics-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .analytics-label {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.85rem;
        }

        /* COMPACT TIMELINE STYLES */
        .timeline {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 10px;
        }

        .timeline-period {
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .period-header {
            background: #f8f9fa;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
        }

        .period-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .period-actions {
            display: flex;
            gap: 5px;
        }

        .period-modules {
            padding: 10px 15px;
            background: white;
        }

        .compact-module-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
        }

        .compact-module-item {
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid var(--info);
        }

        .compact-module-item:hover {
            background: #e9ecef;
        }

        .compact-module-item.option {
            border-left-color: var(--primary);
        }

        .compact-module-item.research {
            border-left-color: var(--warning);
        }

        .compact-module-item.synoptic {
            border-left-color: var(--success);
        }

        .compact-module-item.taken {
            background: #d4edda;
            font-weight: 600;
        }

        .compact-module-item.break {
            background: #fff3cd;
            border-left-color: var(--warning);
        }

        .compact-module-item.locked {
            background: #f8d7da;
            border-left-color: var(--danger);
            cursor: not-allowed;
        }

        .small-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        .phase-indicator {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .phase {
            padding: 10px;
            text-align: center;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--shadow);
        }

        .phase.active {
            background: var(--primary);
            color: white;
        }

        .phase.completed {
            background: var(--success);
            color: white;
        }

        .phase-title {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .phase-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .impact-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .impact-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .impact-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .scenario-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .scenario-card {
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .scenario-card:hover {
            transform: translateY(-5px);
        }

        .scenario-card.active {
            border: 2px solid var(--primary);
        }

        .scenario-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .scenario-date {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .scenario-delay {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-left: 4px solid var(--success);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .alert.warning {
            border-left-color: var(--warning);
        }

        .alert.error {
            border-left-color: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .close-alert {
            float: right;
            cursor: pointer;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div>
                        <h1>KCL PNOMH Graduation Planner</h1>
                        <div class="subtitle">Plan your part-time Psychology & Neuroscience of Mental Health degree</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="phase-indicator">
            <div class="phase completed">
                <div class="phase-title">Foundation</div>
                <div class="phase-subtitle">4 Modules</div>
            </div>
            <div class="phase active">
                <div class="phase-title">Options</div>
                <div class="phase-subtitle">Choose 4</div>
            </div>
            <div class="phase">
                <div class="phase-title">Research</div>
                <div class="phase-subtitle">2 Modules</div>
            </div>
            <div class="phase">
                <div class="phase-title">Synoptic</div>
                <div class="phase-subtitle">1 Project</div>
            </div>
        </div>

        <div class="main-content">
            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Program Setup</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="award">Select Award</label>
                        <select class="form-control" id="award">
                            <option value="PGCert">PG Cert (60 credits)</option>
                            <option value="PGDip">PG Dip (120 credits)</option>
                            <option value="MSc" selected>MSc (180 credits)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="start">Start Date</label>
                        <select class="form-control" id="start"></select>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="quickFill()">Quick Fill</button>
                        <button class="btn btn-outline" onclick="resetPlan()">Reset Plan</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Select Option Modules</div>
                        <div class="card-subtitle">Choose 4 of 10 available</div>
                    </div>
                    <div class="module-tags" id="opts"></div>
                    <div id="wbox" class="alert warning" style="display: none; position: static; margin-top: 15px;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Study Timeline</div>
                    </div>
                    <div id="phaseInfo"></div>
                    <div id="tl" class="timeline"></div>
                </div>
            </div>

            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Analytics Dashboard</div>
                    </div>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-label">Estimated Duration</div>
                            <div class="analytics-value" id="vDur">—</div>
                            <div class="analytics-label">months</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">Study Breaks</div>
                            <div class="analytics-value" id="vBrk">0</div>
                            <div class="analytics-label">taken</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">Progress</div>
                            <div class="analytics-value" id="vPct">0%</div>
                            <div class="analytics-label">completed</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">Graduation</div>
                            <div class="analytics-value" id="vGrad">—</div>
                            <div class="analytics-label">estimated</div>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span>Start</span>
                            <span id="progText">0% Complete</span>
                            <span>Graduation</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Break Impact Analysis</div>
                    </div>
                    <div class="impact-section">
                        <div class="impact-title">Current Break Impact</div>
                        <div class="impact-value" id="breakImpact">No breaks selected</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="addBreaksToYear(1)">Add Year 1 Breaks</button>
                        <button class="btn btn-outline" onclick="addBreaksToYear(2)">Add Year 2 Breaks</button>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="clearAllBreaks()">Clear All Breaks</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Graduation Scenarios</div>
                    </div>
                    <div class="scenario-cards" id="scenarioGrid"></div>
                    <button class="btn btn-outline" style="width: 100%; margin-top: 15px;" onclick="generateScenarios()">Show All Scenarios</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Optimal Study Path</div>
                    </div>
                    <div class="impact-section">
                        <div class="impact-title">Fastest Possible Graduation</div>
                        <div class="impact-value" id="optimalGraduation">—</div>
                    </div>
                    <button class="btn" style="width: 100%;" onclick="showOptimalPath()">Show Optimal Path</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Module definitions and schedule data
        const F = ['Biological Foundations of Mental Health', 'Techniques in Neuroscience', 'Psychological Foundations of Mental Health', 'Mental Health in the Community'];
        const O = ['Mindfulness: Neuroscience & Application', 'Global Mental Health', 'Psychology & Neuroscience of Addiction', 'Child & Adolescent Mental Health', 'Social, Genetic & Environmental Basis of Mental Health', 'Neuroscience in Society', 'Psychology & Neuroscience of Affective Disorders', 'Psychology & Neuroscience of Psychosis', 'Neuroimaging in Mental Health', 'Pharmacotherapies in Mental Health'];
        const R = ['Research Skills: From Reviewing & Critical Analysis to Research Ethics', 'Research Skills: From Methods & Procedures to Analysis & Reporting'];
        const S = ['Independent Synoptic Project'];
        
        // Complete schedule data
        const SCH = {
            "2023-01": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics"],
            "2023-03": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting"],
            "2023-05": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics"],
            "2023-06": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting"],
            "2023-09": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics"],
            "2023-10": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting"],
            "2024-01": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics"],
            "2024-03": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting"],
            "2024-05": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics"],
            "2024-06": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting"],
            "2024-09": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics"],
            "2024-10": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting"]
        };
        
        const REQ = {
            PGCert: { f: 4, o: 0, r: 0, s: 0 },
            PGDip: { f: 4, o: 4, r: 0, s: 0 },
            MSc: { f: 4, o: 4, r: 2, s: 1 }
        };
        
        const keys = Object.keys(SCH).sort();
        const brks = new Set();
        const taken = new Map();
        
        let isInitialized = false;
        
        // Initialize the planner
        function init() {
            if (isInitialized) return;
            isInitialized = true;
        
            // Initialize start date dropdown
            const startS = document.getElementById('start');
            if (!startS) return;
        
            startS.innerHTML = '';
            keys.forEach(k => {
                const [y, m] = k.split('-').map(Number);
                const d = new Date(y, m - 1, 1);
                const o = document.createElement('option');
                o.value = k;
                o.textContent = d.toLocaleString('en-GB', { month: 'short', year: 'numeric' });
                startS.appendChild(o);
            });
        
            startS.value = '2023-09';
            startS.addEventListener('change', gen);
            document.getElementById('award').addEventListener('change', gen);
        
            // Initialize option checkboxes
            const optsW = document.getElementById('opts');
            if (!optsW) return;
        
            optsW.innerHTML = '';
            O.forEach(n => {
                const id = 'o' + n.replace(/[^a-z0-9]/gi, '');
                const l = document.createElement('label');
                l.className = 'module-tag';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = id;
                checkbox.dataset.name = n;
                checkbox.addEventListener('change', function() {
                    const checkedBoxes = document.querySelectorAll('#opts input:checked');
                    if (checkedBoxes.length > 4) {
                        this.checked = false;
                        showAlert('You can only select 4 option modules', 'warning');
                        return;
                    }
        
                    // If deselecting, remove any taken modules that are no longer valid
                    if (!this.checked) {
                        const deselectedModule = this.dataset.name;
                        const toRemove = [];
                        taken.forEach((module, period) => {
                            if (module === deselectedModule) {
                                toRemove.push(period);
                            }
                        });
                        toRemove.forEach(period => taken.delete(period));
                    }
        
                    updateChipSelection();
                    gen();
                });
                l.appendChild(checkbox);
                l.appendChild(document.createTextNode(n));
                optsW.appendChild(l);
            });
            
            // Generate initial view
            gen();
            generateScenarios();
        }
        
        // Update chip selection styling
        function updateChipSelection() {
            const chips = document.querySelectorAll('#opts .module-tag');
            chips.forEach(chip => {
                const checkbox = chip.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
        }
        
        // Get selected options
        function getOpts() {
            return [...document.querySelectorAll('#opts input:checked')].map(c => c.dataset.name).slice(0, 4);
        }
        
        // Add years to a date key
        function addY(k, y) {
            const [yr, m] = k.split('-').map(Number);
            return `${yr + y}-${String(m).padStart(2, '0')}`;
        }
        
        // Format date key to readable format
        function fmtD(k) {
            const [y, m] = k.split('-').map(Number);
            const date = new Date(y, m - 1, 1);
            return date.toLocaleString('en-GB', { month: 'short', year: 'numeric' });
        }
        
        // Get module type
        function getType(m) {
            if (F.includes(m)) return 'foundation';
            if (O.includes(m)) return 'option';
            if (R.includes(m)) return 'research';
            if (S.includes(m)) return 'synoptic';
            return 'unknown';
        }
        
        // Get count of taken modules by type
        function getTkn() {
            let t = { f: 0, o: 0, r: 0, s: 0 };
            taken.forEach(v => {
                const ty = getType(v);
                if (ty === 'foundation') t.f++;
                else if (ty === 'option') t.o++;
                else if (ty === 'research') t.r++;
                else if (ty === 'synoptic') t.s++;
            });
            return t;
        }
        
        // Calculate actual completed modules (not just count)
        function getActualCompletion() {
            const completedFoundations = F.filter(f => [...taken.values()].includes(f)).length;
            const cho = getOpts();
            const completedOptions = cho.filter(o => [...taken.values()].includes(o)).length;
            const completedResearch = R.filter(r => [...taken.values()].includes(r)).length;
            const completedSynoptic = S.filter(s => [...taken.values()].includes(s)).length;
            
            return {
                foundations: completedFoundations,
                options: completedOptions,
                research: completedResearch,
                synoptic: completedSynoptic
            };
        }
        
        // Update phase indicator
        function updatePhaseIndicator(actualCompletion, rq) {
            const phases = document.querySelectorAll('.phase');
            phases[0].className = actualCompletion.foundations >= rq.f ? 'phase completed' : 'phase active';
            phases[1].className = actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o ? 'phase completed' : 
                             actualCompletion.foundations >= rq.f ? 'phase active' : 'phase';
            phases[2].className = actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r ? 'phase completed' : 
                             actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o ? 'phase active' : 'phase';
            phases[3].className = actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r && actualCompletion.synoptic >= rq.s ? 'phase completed' : 
                             actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r ? 'phase active' : 'phase';
        }
        
        // Generate the main view
        function gen() {
            const aw = document.getElementById('award').value || 'MSc';
            const st = document.getElementById('start').value || '2023-09';
            const rq = { ...REQ[aw] };
            const cho = getOpts();
            const tkn = getTkn();
            const actualCompletion = getActualCompletion();
            const wb = document.getElementById('wbox');
        
            if (wb) {
                if (rq.o > 0 && cho.length < 4) {
                    wb.textContent = `Please select 4 option modules (required for ${aw})`;
                    wb.style.display = 'block';
                } else {
                    wb.style.display = 'none';
                }
            }
        
            const hs = addY(st, 6);
            const itk = keys.filter(k => k >= st && k <= hs);
            render(itk, st, rq, tkn, cho, actualCompletion);
            vis(itk, tkn, rq, st, actualCompletion);
            updateBreakImpact();
            updateOptimalGraduation(st, rq, cho);
        }
        
        // Render the timeline - COMPACT VERSION
        function render(itk, st, rq, tkn, cho, actualCompletion) {
            const el = document.getElementById('tl');
            if (!el) return;

            el.innerHTML = '';
            
            // Update phase indicator
            updatePhaseIndicator(actualCompletion, rq);
            
            const pi = document.getElementById('phaseInfo');
            if (pi) {
                if (actualCompletion.foundations < rq.f) {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--info); margin-bottom: 10px;">
                        <strong>Current Phase:</strong> Complete ${rq.f - actualCompletion.foundations} more foundation modules
                    </div>`;
                } else if (actualCompletion.foundations >= rq.f && actualCompletion.options < rq.o) {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--primary); margin-bottom: 10px;">
                        <strong>Current Phase:</strong> Complete ${rq.o - actualCompletion.options} more option modules
                    </div>`;
                } else if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research < rq.r) {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--warning); margin-bottom: 10px;">
                        <strong>Current Phase:</strong> Complete ${rq.r - actualCompletion.research} more research modules
                    </div>`;
                } else if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r && actualCompletion.synoptic < rq.s) {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--success); margin-bottom: 10px;">
                        <strong>Current Phase:</strong> Complete the Synoptic Project
                    </div>`;
                } else {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--success); margin-bottom: 10px;">
                        <strong>All requirements complete!</strong>
                    </div>`;
                }
            }

            itk.forEach(k => {
                const period = document.createElement('div');
                period.className = 'timeline-period';
                
                const tkMod = taken.get(k);
                const isBreak = brks.has(k);
                
                const header = document.createElement('div');
                header.className = 'period-header';
                
                const title = document.createElement('div');
                title.className = 'period-title';
                title.textContent = fmtD(k);
                header.appendChild(title);
                
                const actions = document.createElement('div');
                actions.className = 'period-actions';
                
                if (isBreak) {
                    actions.innerHTML = `<button class="btn btn-outline small-btn" onclick="brks.delete('${k}'); gen();">Remove Break</button>`;
                } else if (tkMod) {
                    actions.innerHTML = `
                        <button class="btn btn-outline small-btn" onclick="taken.delete('${k}'); gen();">Remove</button>
                        <button class="btn btn-outline small-btn" onclick="brks.add('${k}'); taken.delete('${k}'); gen();">Break</button>
                    `;
                } else {
                    actions.innerHTML = `<button class="btn btn-outline small-btn" onclick="brks.add('${k}'); gen();">Set Break</button>`;
                }
                
                header.appendChild(actions);
                period.appendChild(header);
                
                const modules = document.createElement('div');
                modules.className = 'period-modules';
                
                if (!isBreak && !tkMod) {
                    const mds = SCH[k] || [];
                    let availableModules = [];
                    
                    // STRICT PREREQUISITE CHECKING
                    if (actualCompletion.foundations < rq.f) {
                        availableModules = mds.filter(m => F.includes(m) && ![...taken.values()].includes(m));
                    } else if (actualCompletion.foundations >= rq.f && actualCompletion.options < rq.o) {
                        availableModules = mds.filter(m => cho.includes(m) && ![...taken.values()].includes(m));
                    } else if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research < rq.r) {
                        availableModules = mds.filter(m => R.includes(m) && ![...taken.values()].includes(m));
                    } else if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r && actualCompletion.synoptic < rq.s) {
                        availableModules = mds.filter(m => S.includes(m));
                    }
                    
                    if (availableModules.length > 0) {
                        const moduleList = document.createElement('div');
                        moduleList.className = 'compact-module-list';
                        
                        availableModules.forEach(m => {
                            const moduleItem = document.createElement('div');
                            const type = getType(m);
                            moduleItem.className = `compact-module-item ${type}`;
                            moduleItem.textContent = m;
                            moduleItem.title = m;
                            moduleItem.addEventListener('click', () => {
                                taken.set(k, m);
                                gen();
                            });
                            moduleList.appendChild(moduleItem);
                        });
                        
                        modules.appendChild(moduleList);
                    } else {
                        let message = 'No available modules';
                        if (actualCompletion.foundations < rq.f) {
                            message = `Complete ${rq.f - actualCompletion.foundations} more foundation modules first`;
                        } else if (actualCompletion.foundations >= rq.f && actualCompletion.options < rq.o) {
                            message = `Complete ${rq.o - actualCompletion.options} more option modules first`;
                        }
                        
                        modules.innerHTML = `<div style="font-size: 0.8rem; color: var(--gray); text-align: center; padding: 10px;">${message}</div>`;
                    }
                } else if (tkMod) {
                    const moduleItem = document.createElement('div');
                    const type = getType(tkMod);
                    moduleItem.className = `compact-module-item ${type} taken`;
                    moduleItem.textContent = tkMod;
                    moduleItem.title = tkMod;
                    modules.appendChild(moduleItem);
                } else if (isBreak) {
                    modules.innerHTML = `<div style="font-size: 0.8rem; color: var(--warning); text-align: center; padding: 10px;">Study Break Period</div>`;
                }
                
                period.appendChild(modules);
                el.appendChild(period);
            });
        }
        
        // Update visualization
        function vis(itk, tkn, rq, st, actualCompletion) {
            const lastK = [...taken.keys()].sort().pop();
        
            const vDur = document.getElementById('vDur');
            if (vDur) {
                if (lastK) {
                    const brkCount = brks.size;
                    const totalPeriods = keys.filter(k => k >= st && k <= lastK).length;
                    const studyPeriods = Math.max(0, totalPeriods - brkCount);
                    const durMonths = studyPeriods * 2;
                    vDur.textContent = durMonths;
                } else {
                    vDur.textContent = '—';
                }
            }
        
            const vBrk = document.getElementById('vBrk');
            if (vBrk) {
                vBrk.textContent = brks.size;
            }
        
            const tot = rq.f + rq.o + rq.r + rq.s;
            const cur = actualCompletion.foundations + actualCompletion.options + actualCompletion.research + actualCompletion.synoptic;
            const pct = tot > 0 ? Math.round((cur / tot) * 100) : 0;
        
            const vPct = document.getElementById('vPct');
            if (vPct) {
                vPct.textContent = pct + '%';
            }
        
            const progF = document.getElementById('progFill');
            const progText = document.getElementById('progText');
            if (progF && progText) {
                progF.style.width = pct + '%';
                progText.textContent = pct + '% Complete';
            }
        
            const vGrad = document.getElementById('vGrad');
            if (vGrad) {
                if (lastK) {
                    vGrad.textContent = fmtD(lastK);
                } else {
                    vGrad.textContent = '—';
                }
            }
        }
        
        // Update break impact display
        function updateBreakImpact() {
            const aw = document.getElementById('award').value || 'MSc';
            const st = document.getElementById('start').value || '2023-09';
            const rq = { ...REQ[aw] };
            const cho = getOpts();
            const baseline = calcBaseline(st, rq, cho);
            const lastK = [...taken.keys()].sort().pop();
            const el = document.getElementById('breakImpact');
        
            if (!el) return;
        
            if (brks.size === 0) {
                el.textContent = 'No breaks selected';
                el.style.color = 'var(--success)';
            } else if (baseline && lastK) {
                const bPeriods = keys.filter(k => k >= st && k <= baseline).length;
                const cPeriods = keys.filter(k => k >= st && k <= lastK).length;
                const delay = (cPeriods - bPeriods) * 2;
                el.textContent = `${delay > 0 ? '+' : ''}${delay} months delay`;
                el.style.color = delay > 0 ? 'var(--warning)' : 'var(--success)';
            } else {
                el.textContent = `${brks.size} break(s) selected`;
                el.style.color = 'var(--gray)';
            }
        }
        
        // Update optimal graduation display
        function updateOptimalGraduation(st, rq, cho) {
            const optimal = calcBaseline(st, rq, cho);
            const el = document.getElementById('optimalGraduation');
            if (el && optimal) {
                el.textContent = fmtD(optimal);
            }
        }
        
        // Calculate baseline graduation date
        function calcBaseline(st, rq, cho) {
            const taken2 = new Map();
            let tkn = { f: 0, o: 0, r: 0, s: 0 };
            const hs = addY(st, 6);
            const itk = keys.filter(k => k >= st && k <= hs);
            const remF = new Set(F);
            const remO = new Set(cho.length >= 4 ? cho : O.slice(0, 4));
            const remR = new Set(R);
        
            for (const k of itk) {
                if (tkn.f >= rq.f && tkn.o >= rq.o && tkn.r >= rq.r && tkn.s >= rq.s) break;
                const mds = SCH[k] || [];
        
                if (tkn.f < rq.f) {
                    const m = mds.find(x => remF.has(x));
                    if (m) {
                        taken2.set(k, m);
                        remF.delete(m);
                        tkn.f++;
                        continue;
                    }
                }
                if (tkn.f >= rq.f && tkn.o < rq.o) {
                    const m = mds.find(x => remO.has(x));
                    if (m) {
                        taken2.set(k, m);
                        remO.delete(m);
                        tkn.o++;
                        continue;
                    }
                }
                if (tkn.f >= rq.f && tkn.o >= rq.o && tkn.r < rq.r) {
                    const m = mds.find(x => remR.has(x));
                    if (m) {
                        taken2.set(k, m);
                        remR.delete(m);
                        tkn.r++;
                        continue;
                    }
                }
                if (tkn.f >= rq.f && tkn.o >= rq.o && tkn.r >= rq.r && tkn.s < rq.s) {
                    const m = mds.find(x => S.includes(x));
                    if (m) {
                        taken2.set(k, m);
                        const ni = itk.indexOf(k);
                        if (ni >= 0 && ni < itk.length - 1) taken2.set(itk[ni + 1], m);
                        tkn.s++;
                        break;
                    }
                }
            }
            return [...taken2.keys()].sort().pop();
        }
        
        // Generate graduation scenarios
        function generateScenarios() {
            const aw = document.getElementById('award').value || 'MSc';
            const st = document.getElementById('start').value || '2023-09';
            const rq = { ...REQ[aw] };
            const cho = getOpts();
            
            if (rq.o > 0 && cho.length < 4) {
                showAlert('Please select 4 option modules first', 'warning');
                return;
            }
            
            const scenarioGrid = document.getElementById('scenarioGrid');
            
            if (!scenarioGrid) return;
            
            // Calculate different scenarios
            const optimal = calcBaseline(st, rq, cho);
            const withOneBreak = calcWithBreaks(st, rq, cho, 1);
            const withTwoBreaks = calcWithBreaks(st, rq, cho, 2);
            const maxDuration = calcWithBreaks(st, rq, cho, 6); // Maximum 6 years
            
            scenarioGrid.innerHTML = `
                <div class="scenario-card ${brks.size === 0 ? 'active' : ''}">
                    <div class="scenario-title">Fastest Path</div>
                    <div class="scenario-date">${optimal ? fmtD(optimal) : 'N/A'}</div>
                    <div class="scenario-delay">0 breaks</div>
                </div>
                <div class="scenario-card ${brks.size === 1 ? 'active' : ''}">
                    <div class="scenario-title">1 Break</div>
                    <div class="scenario-date">${withOneBreak ? fmtD(withOneBreak) : 'N/A'}</div>
                    <div class="scenario-delay">+2 months</div>
                </div>
                <div class="scenario-card ${brks.size === 2 ? 'active' : ''}">
                    <div class="scenario-title">2 Breaks</div>
                    <div class="scenario-date">${withTwoBreaks ? fmtD(withTwoBreaks) : 'N/A'}</div>
                    <div class="scenario-delay">+4 months</div>
                </div>
                <div class="scenario-card">
                    <div class="scenario-title">Maximum Duration</div>
                    <div class="scenario-date">${maxDuration ? fmtD(maxDuration) : 'N/A'}</div>
                    <div class="scenario-delay">6 years limit</div>
                </div>
            `;
        }
        
        // Calculate graduation with specified number of breaks
        function calcWithBreaks(st, rq, cho, breakCount) {
            const taken2 = new Map();
            let tkn = { f: 0, o: 0, r: 0, s: 0 };
            const hs = addY(st, 6);
            const itk = keys.filter(k => k >= st && k <= hs);
            const remF = new Set(F);
            const remO = new Set(cho.length >= 4 ? cho : O.slice(0, 4));
            const remR = new Set(R);
            
            // Add breaks at optimal points
            const breaks = new Set();
            const moduleCounts = {};
            
            itk.forEach(period => {
                const modules = SCH[period] || [];
                const requiredModules = modules.filter(m => 
                    F.includes(m) || (cho.includes(m) && O.includes(m)) || 
                    R.includes(m) || S.includes(m)
                );
                moduleCounts[period] = requiredModules.length;
            });
            
            const sortedPeriods = [...itk].sort((a, b) => moduleCounts[a] - moduleCounts[b]);
            for (let i = 0; i < breakCount && i < sortedPeriods.length; i++) {
                breaks.add(sortedPeriods[i]);
            }
            
            for (const k of itk) {
                if (tkn.f >= rq.f && tkn.o >= rq.o && tkn.r >= rq.r && tkn.s >= rq.s) break;
                if (breaks.has(k)) continue;
                
                const mds = SCH[k] || [];
                
                if (tkn.f < rq.f) {
                    const m = mds.find(x => remF.has(x));
                    if (m) {
                        taken2.set(k, m);
                        remF.delete(m);
                        tkn.f++;
                        continue;
                    }
                }
                if (tkn.f >= rq.f && tkn.o < rq.o) {
                    const m = mds.find(x => remO.has(x));
                    if (m) {
                        taken2.set(k, m);
                        remO.delete(m);
                        tkn.o++;
                        continue;
                    }
                }
                if (tkn.f >= rq.f && tkn.o >= rq.o && tkn.r < rq.r) {
                    const m = mds.find(x => remR.has(x));
                    if (m) {
                        taken2.set(k, m);
                        remR.delete(m);
                        tkn.r++;
                        continue;
                    }
                }
                if (tkn.f >= rq.f && tkn.o >= rq.o && tkn.r >= rq.r && tkn.s < rq.s) {
                    const m = mds.find(x => S.includes(x));
                    if (m) {
                        taken2.set(k, m);
                        const ni = itk.indexOf(k);
                        if (ni >= 0 && ni < itk.length - 1) taken2.set(itk[ni + 1], m);
                        tkn.s++;
                        break;
                    }
                }
            }
            
            return [...taken2.keys()].sort().pop();
        }
        
        // Quick fill function
        function quickFill() {
            const aw = document.getElementById('award').value || 'MSc';
            const st = document.getElementById('start').value || '2023-09';
            const rq = { ...REQ[aw] };
            const tkn = getTkn();
            const cho = getOpts();
        
            if (rq.o > 0 && cho.length < 4) {
                showAlert('Please select 4 option modules first', 'warning');
                return;
            }
            
            const actualCompletion = getActualCompletion();
            if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r && actualCompletion.synoptic >= rq.s) {
                showAlert('Your plan is already complete!', 'success');
                return;
            }
        
            const beforeCount = taken.size;
            const hs = addY(st, 6);
            const itk = keys.filter(k => k >= st && k <= hs);
            const remF = new Set(F.filter(m => ![...taken.values()].includes(m)));
            const remO = new Set((cho.length >= 4 ? cho : O.slice(0, 4)).filter(m => ![...taken.values()].includes(m)));
            const remR = new Set(R.filter(m => ![...taken.values()].includes(m)));
            
            let curFoundations = actualCompletion.foundations;
            let curOptions = actualCompletion.options;
            let curResearch = actualCompletion.research;
            let curSynoptic = actualCompletion.synoptic;
        
            for (const k of itk) {
                if (curFoundations >= rq.f && curOptions >= rq.o && curResearch >= rq.r && curSynoptic >= rq.s) break;
                if (taken.has(k) || brks.has(k)) continue;
                const mds = SCH[k] || [];
        
                // STRICT PREREQUISITE ENFORCEMENT
                if (curFoundations < rq.f) {
                    const m = mds.find(x => remF.has(x));
                    if (m) {
                        taken.set(k, m);
                        remF.delete(m);
                        curFoundations++;
                        continue;
                    }
                }
                if (curFoundations >= rq.f && curOptions < rq.o) {
                    const m = mds.find(x => remO.has(x));
                    if (m) {
                        taken.set(k, m);
                        remO.delete(m);
                        curOptions++;
                        continue;
                    }
                }
                if (curFoundations >= rq.f && curOptions >= rq.o && curResearch < rq.r) {
                    const m = mds.find(x => remR.has(x));
                    if (m) {
                        taken.set(k, m);
                        remR.delete(m);
                        curResearch++;
                        continue;
                    }
                }
                if (curFoundations >= rq.f && curOptions >= rq.o && curResearch >= rq.r && curSynoptic < rq.s) {
                    const m = mds.find(x => S.includes(x));
                    if (m) {
                        taken.set(k, m);
                        const ni = itk.indexOf(k);
                        if (ni >= 0 && ni < itk.length - 1) taken.set(itk[ni + 1], m);
                        curSynoptic++;
                        break;
                    }
                }
            }
        
            const afterCount = taken.size;
            const added = afterCount - beforeCount;
            gen();
        
            if (added > 0) {
                showAlert(`Added ${added} module${added > 1 ? 's' : ''} to your plan!`, 'success');
            } else {
                showAlert('No suitable modules found to add', 'warning');
            }
        }
        
        // Add breaks to a specific year
        function addBreaksToYear(year) {
            const st = document.getElementById('start').value || '2023-09';
            const startYear = parseInt(st.split('-')[0]);
            const targetYear = startYear + year - 1;
        
            let added = 0;
            keys.forEach(k => {
                const keyYear = parseInt(k.split('-')[0]);
                if (keyYear === targetYear && !taken.has(k) && !brks.has(k)) {
                    brks.add(k);
                    added++;
                }
            });
        
            gen();
            if (added > 0) {
                showAlert(`Added ${added} breaks to Year ${year}`, 'success');
            } else {
                showAlert(`No available periods in Year ${year} for breaks`, 'warning');
            }
        }
        
        // Clear all breaks
        function clearAllBreaks() {
            const count = brks.size;
            brks.clear();
            gen();
            if (count > 0) {
                showAlert(`Cleared ${count} breaks`, 'success');
            } else {
                showAlert('No breaks to clear', 'warning');
            }
        }
        
        // Show optimal path
        function showOptimalPath() {
            taken.clear();
            brks.clear();
            quickFill();
        }
        
        // Reset plan
        function resetPlan() {
            if (confirm('Reset everything? This cannot be undone.')) {
                taken.clear();
                brks.clear();
                const checkboxes = document.querySelectorAll('#opts input');
                checkboxes.forEach(i => i.checked = false);
                updateChipSelection();
                gen();
                showAlert('Plan reset successfully', 'success');
            }
        }
        
        // Show alert
        function showAlert(msg, type = 'success') {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
        
            const al = document.createElement('div');
            al.className = `alert ${type}`;
        
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close-alert';
            closeBtn.textContent = '×';
            closeBtn.addEventListener('click', function() {
                al.remove();
            });
        
            const msgDiv = document.createElement('div');
            msgDiv.style.paddingRight = '1.5rem';
            msgDiv.textContent = msg;
        
            al.appendChild(closeBtn);
            al.appendChild(msgDiv);
            document.body.appendChild(al);
        
            setTimeout(() => {
                if (al.parentNode) {
                    al.remove();
                }
            }, 3000);
        }
        
        // Expose functions to global scope
        window.quickFill = quickFill;
        window.resetPlan = resetPlan;
        window.addBreaksToYear = addBreaksToYear;
        window.clearAllBreaks = clearAllBreaks;
        window.showOptimalPath = showOptimalPath;
        window.generateScenarios = generateScenarios;
        
        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
