<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KCL PNOMH Graduation Planner</title>
<style>
:root{--r:#d50032;--ink:#111827;--mut:#6b7280;--bg:#fafafa;--line:#e5e7eb}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--ink);font-family:system-ui,sans-serif;line-height:1.4}
header{background:var(--r);color:#fff;padding:1rem}
h1{font-size:1.3rem;font-weight:700}
.sub{opacity:.9;font-size:.85rem;margin-top:.25rem}
.container{max-width:1200px;margin:0 auto;padding:1rem}
.topGrid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:1rem}
@media(max-width:768px){.topGrid{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid var(--line);border-radius:8px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,.04)}
h3{font-size:1rem;margin-bottom:.5rem}
label{display:block;font-size:.75rem;color:var(--mut);margin-bottom:.25rem;font-weight:500}
select,button{width:100%;padding:.5rem;border-radius:6px;border:1px solid var(--line);background:#fff;font-size:.85rem}
button{cursor:pointer;font-weight:600;transition:all .2s}
.btn{background:var(--r);color:#fff;border:none}
.btn:hover{opacity:.9}
.btn.sec{background:#fff;color:var(--ink)}
.btn.sec:hover{background:#f9fafb}
.btn.auto{background:#8b5cf6}
.row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.5rem}
.tags{display:flex;gap:.25rem;flex-wrap:wrap}
.chip{background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:.2rem .5rem;font-size:.7rem;cursor:pointer;user-select:none;transition:all .2s}
.chip:hover{background:#e5e7eb}
.chip.selected{background:#ddd6fe;border-color:#8b5cf6}
.chip input{margin-right:.25rem}
.timeline{display:grid;gap:.25rem;max-height:400px;overflow-y:auto;padding-right:.5rem}
.term{border:1px solid var(--line);border-radius:6px;padding:.5rem;background:#fff;transition:all .2s;position:relative}
.term:hover{border-color:#94a3b8}
.termHd{display:flex;justify-content:space-between;align-items:center;margin-bottom:.25rem}
.termTtl{font-weight:600;font-size:.8rem}
.termCtrl{display:flex;gap:.25rem}
.termBtn{padding:.15rem .4rem;font-size:.65rem;border:1px solid var(--line);background:#fff;border-radius:4px;cursor:pointer;transition:all .2s}
.termBtn:hover{background:#f3f4f6}
.termBtn.break{background:#fff7ed;border-color:#fed7aa}
.termBtn.taken{background:#dcfce7;border-color:#86efac}
.mod{border:1px solid #cbd5e1;background:#f8fafc;border-radius:4px;padding:.35rem;font-size:.75rem;display:flex;align-items:center;gap:.25rem;cursor:pointer;transition:all .2s;margin-bottom:.25rem}
.mod:hover{background:#e2e8f0;border-color:#94a3b8}
.mod.taken{background:#dcfce7;border-color:#86efac;font-weight:600}
.mod.locked{opacity:.5;cursor:not-allowed}
.modGrid{display:grid;gap:.25rem;grid-template-columns:1fr 1fr;font-size:.7rem}
.kbd{border:1px solid var(--line);background:#f9fafb;border-radius:4px;font-size:.7rem;padding:.15rem .3rem;font-family:monospace}
.sum{margin-top:.5rem;padding:.5rem;background:#f9fafb;border-radius:6px;font-size:.8rem}
.grad{background:#f0f9ff;border:2px solid #0ea5e9;border-radius:6px;padding:.5rem;margin-top:.5rem;font-weight:600;font-size:.8rem}
.warn{color:#f59e0b;font-weight:600}
.ok{color:#16a34a;font-weight:600}
.bad{color:#ef4444;font-weight:600}
.warnBox{margin-top:.5rem;padding:.5rem;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;font-size:.8rem}
.progBar{height:20px;background:#e5e7eb;border-radius:10px;overflow:hidden;margin:.5rem 0}
.progFill{height:100%;background:linear-gradient(90deg,#0ea5e9,#06b6d4);transition:width .5s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.7rem;font-weight:700}
.vis{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-top:.5rem}
.visCard{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:8px;padding:.75rem;color:#fff;text-align:center;box-shadow:0 2px 8px rgba(102,126,234,.25)}
.visCard.alt1{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
.visCard.alt2{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
.visCard.alt3{background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%)}
.visNum{font-size:1.5rem;font-weight:700;margin:.25rem 0}
.visLbl{font-size:.7rem;opacity:.9}
.phase{background:#f0f9ff;border-left:3px solid #0ea5e9;padding:.4rem;margin:.5rem 0;border-radius:3px;font-size:.8rem;font-weight:600}
.phase.complete{background:#f0fdf4;border-color:#16a34a}
.alert{position:fixed;top:20px;right:20px;background:#fff;border:2px solid #0ea5e9;border-radius:8px;padding:.75rem;box-shadow:0 6px 20px rgba(0,0,0,.15);z-index:1000;max-width:300px;animation:slideIn .3s ease}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.alert.success{border-color:#16a34a;background:#f0fdf4}
.alert.warning{border-color:#f59e0b;background:#fffbeb}
.closeAlert{float:right;cursor:pointer;font-weight:700;font-size:1rem;opacity:.5}
.closeAlert:hover{opacity:1}
.mainGrid{display:grid;grid-template-columns:2fr 1fr;gap:1rem}
@media(max-width:768px){.mainGrid{grid-template-columns:1fr}}
.impact{margin-top:.5rem;padding:.5rem;background:#f9fafb;border-radius:6px;font-size:.75rem}
</style>
</head>
<body>
<header>
<div class="container">
<h1>King's College London â€” PNOMH Graduation Planner</h1>
<div class="sub">Optimized layout: Foundation â†’ Options â†’ Research â†’ Synoptic</div>
</div>
</header>
<main class="container">
<div class="topGrid">
<section class="card">
<h3>Setup</h3>
<div class="row">
<div><label for="award">Award</label>
<select id="award">
<option value="PGCert">PG Cert (60c)</option>
<option value="PGDip">PG Dip (120c)</option>
<option value="MSc" selected>MSc (180c)</option>
</select></div>
<div><label for="start">Start</label>
<select id="start"></select></div>
</div>
<div style="display:grid;gap:.25rem">
<button onclick="quickFill()" class="btn auto">âœ¨ Quick Fill</button>
<button onclick="resetPlan()" class="btn sec">ðŸ”„ Reset</button>
</div>
</section>

<section class="card">
<h3>Choose 4 Options</h3>
<div class="tags" id="opts"></div>
<div id="wbox" class="warnBox" style="display:none"></div>
</section>

<section class="card">
<h3>Analytics</h3>
<div class="vis">
<div class="visCard"><div class="visLbl">Duration</div><div class="visNum" id="vDur">â€”</div><div class="visLbl">months</div></div>
<div class="visCard alt1"><div class="visLbl">Breaks</div><div class="visNum" id="vBrk">0</div></div>
<div class="visCard alt2"><div class="visLbl">Progress</div><div class="visNum" id="vPct">0%</div></div>
<div class="visCard alt3"><div class="visLbl">Graduation</div><div class="visNum" id="vGrad">â€”</div></div>
</div>
<div class="progBar"><div class="progFill" id="progFill" style="width:0%">0%</div></div>
</section>
</div>

<div class="mainGrid">
<section class="card">
<h3>Study Plan</h3>
<div id="phaseInfo"></div>
<div id="tl" class="timeline"></div>
<div class="sum" id="sum"></div>
<div id="grad" class="grad" style="display:none"></div>
<div id="impact" class="impact" style="display:none"></div>
</section>

<section class="card">
<h3>Quick Actions</h3>
<p style="font-size:.75rem;color:var(--mut);margin-bottom:.5rem">Click buttons to quickly modify your plan:</p>
<div style="display:grid;gap:.25rem">
<button onclick="addBreaksToYear(1)" class="btn sec">Add breaks to Year 1</button>
<button onclick="addBreaksToYear(2)" class="btn sec">Add breaks to Year 2</button>
<button onclick="clearAllBreaks()" class="btn sec">Clear all breaks</button>
<button onclick="showOptimalPath()" class="btn">Show optimal path</button>
</div>
<div style="margin-top:.75rem">
<h4 style="font-size:.85rem;margin-bottom:.25rem">Break Impact</h4>
<div id="breakImpact" style="font-size:.75rem;color:var(--mut)">Select modules to see impact</div>
</div>
</section>
</div>
</main>

<script>
const F=['Biological Foundations of Mental Health','Techniques in Neuroscience','Psychological Foundations of Mental Health','Mental Health in the Community'];
const O=['Mindfulness: Neuroscience & Application','Global Mental Health','Psychology & Neuroscience of Addiction','Child & Adolescent Mental Health','Social, Genetic & Environmental Basis of Mental Health','Neuroscience in Society','Psychology & Neuroscience of Affective Disorders','Psychology & Neuroscience of Psychosis','Neuroimaging in Mental Health','Pharmacotherapies in Mental Health'];
const R=['Research Skills: From Reviewing & Critical Analysis to Research Ethics','Research Skills: From Methods & Procedures to Analysis & Reporting'];
const S=['Independent Synoptic Project'];
const SCH={"2023-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics"],"2023-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2023-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2023-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2023-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2023-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-01":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-03":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-05":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-06":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-09":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-10":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-01":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-03":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-05":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-06":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-09":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-10":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"]};
const REQ={PGCert:{f:4,o:0,r:0,s:0},PGDip:{f:4,o:4,r:0,s:0},MSc:{f:4,o:4,r:2,s:1}};
const keys=Object.keys(SCH).sort();
const brks=new Set();
const taken=new Map();

let isInitialized = false;

function init(){
if (isInitialized) return;
isInitialized = true;

const startS=document.getElementById('start');
if (!startS) return;

startS.innerHTML = '';
keys.forEach(k=>{
try {
const[y,m]=k.split('-').map(Number);
if (isNaN(y) || isNaN(m)) return;
const d=new Date(y,m-1,1);
if (isNaN(d.getTime())) return;
const o=document.createElement('option');
o.value=k;
o.textContent=d.toLocaleString('en-GB',{month:'short',year:'numeric'});
startS.appendChild(o);
} catch (error) {
console.error('Error processing date:', k, error);
}
});

startS.value='2023-09';
startS.addEventListener('change',gen);
document.getElementById('award').addEventListener('change',gen);

const optsW=document.getElementById('opts');
if (!optsW) return;

optsW.innerHTML = '';
O.forEach(n=>{
try {
const id='o'+n.replace(/[^a-z0-9]/gi,'');
const l=document.createElement('label');
l.className='chip';
const checkbox = document.createElement('input');
checkbox.type = 'checkbox';
checkbox.id = id;
checkbox.dataset.name = n;
checkbox.addEventListener('change', function() {
const checkedBoxes = document.querySelectorAll('#opts input:checked');
if (checkedBoxes.length > 4) {
this.checked = false;
showAlert('You can only select 4 option modules', 'warning');
return;
}

// If deselecting, remove any taken modules that are no longer valid
if (!this.checked) {
const deselectedModule = this.dataset.name;
const toRemove = [];
taken.forEach((module, period) => {
if (module === deselectedModule) {
toRemove.push(period);
}
});
toRemove.forEach(period => taken.delete(period));
}

updateChipSelection();
gen();
});
l.appendChild(checkbox);
l.appendChild(document.createTextNode(n));
optsW.appendChild(l);
} catch (error) {
console.error('Error creating option chip:', n, error);
}
});
gen();
}

function updateChipSelection() {
try {
const chips = document.querySelectorAll('#opts .chip');
chips.forEach(chip => {
const checkbox = chip.querySelector('input[type="checkbox"]');
if (checkbox && checkbox.checked) {
chip.classList.add('selected');
} else {
chip.classList.remove('selected');
}
});
} catch (error) {
console.error('Error updating chip selection:', error);
}
}

function getOpts(){
try {
return [...document.querySelectorAll('#opts input:checked')].map(c=>c.dataset.name).slice(0,4);
} catch (error) {
return [];
}
}

function addY(k,y){
try {
const[yr,m]=k.split('-').map(Number);
if (isNaN(yr) || isNaN(m)) return k;
return `${yr+y}-${String(m).padStart(2,'0')}`;
} catch (error) {
return k;
}
}

function fmtD(k){
try {
const[y,m]=k.split('-').map(Number);
if (isNaN(y) || isNaN(m)) return k;
const date = new Date(y,m-1,1);
if (isNaN(date.getTime())) return k;
return date.toLocaleString('en-GB',{month:'short',year:'numeric'});
} catch (error) {
return k;
}
}

function getType(m){
if(F.includes(m))return'f';
if(O.includes(m))return'o';
if(R.includes(m))return'r';
if(S.includes(m))return's';
return'u';
}

function getTkn(){
try {
let t={f:0,o:0,r:0,s:0};
taken.forEach(v=>{
const ty=getType(v);
if(ty==='f')t.f++;
else if(ty==='o')t.o++;
else if(ty==='r')t.r++;
else if(ty==='s')t.s++;
});
return t;
} catch (error) {
return {f:0,o:0,r:0,s:0};
}
}

function gen(){
try {
const aw=document.getElementById('award')?.value || 'MSc';
const st=document.getElementById('start')?.value || '2023-09';
const rq={...REQ[aw]};
const cho=getOpts();
const tkn=getTkn();
const wb=document.getElementById('wbox');

if(wb) {
if(rq.o>0&&cho.length<4){
wb.textContent=`Please select 4 option modules (required for ${aw})`;
wb.style.display='block';
} else {
wb.style.display='none';
}
}

const hs=addY(st,6);
const itk=keys.filter(k=>k>=st&&k<=hs);
render(itk,st,rq,tkn,cho);
vis(itk,tkn,rq,st);
updateBreakImpact();
} catch (error) {
console.error('Error in gen:', error);
}
}

function render(itk,st,rq,tkn,cho){
try {
const el=document.getElementById('tl');
if (!el) return;

el.innerHTML='';
const pi=document.getElementById('phaseInfo');
if (pi) {
if(tkn.f<rq.f){
pi.innerHTML='<div class="phase">ðŸ“˜ Phase 1: Foundation Modules (Complete all 4 first)</div>';
} else if(tkn.f>=rq.f&&tkn.o<rq.o){
pi.innerHTML='<div class="phase complete">âœ… Phase 1 Complete</div><div class="phase">ðŸ“• Phase 2: Option Modules (Choose 4 from selected options)</div>';
} else if(tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r<rq.r){
pi.innerHTML='<div class="phase complete">âœ… Phases 1 & 2 Complete</div><div class="phase">ðŸ“— Phase 3: Research Skills (Prerequisites: 4 foundations + 4 options)</div>';
} else if(tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r>=rq.r&&tkn.s<rq.s){
pi.innerHTML='<div class="phase complete">âœ… Phases 1-3 Complete</div><div class="phase">ðŸ““ Phase 4: Synoptic Project (Prerequisites: All previous phases)</div>';
} else {
pi.innerHTML='<div class="phase complete">âœ… All Phases Complete!</div>';
}
}

itk.forEach(k=>{
const term=document.createElement('div');
term.className='term';
const ttl=fmtD(k);
const tkMod=taken.get(k);
const isBreak=brks.has(k);

const hdr=document.createElement('div');
hdr.className='termHd';
hdr.innerHTML=`<div class="termTtl">${ttl}</div>`;

const ctrl=document.createElement('div');
ctrl.className='termCtrl';

if(isBreak){
const removeBtn=document.createElement('button');
removeBtn.className='termBtn break';
removeBtn.textContent='ðŸ“… Break';
removeBtn.addEventListener('click',()=>{brks.delete(k);gen();});
ctrl.appendChild(removeBtn);
} else if(tkMod){
const removeBtn=document.createElement('button');
removeBtn.className='termBtn taken';
removeBtn.textContent='âœ“ Taken';
removeBtn.addEventListener('click',()=>{taken.delete(k);gen();});
ctrl.appendChild(removeBtn);

const breakBtn=document.createElement('button');
breakBtn.className='termBtn';
breakBtn.textContent='Take Break';
breakBtn.addEventListener('click',()=>{brks.add(k);taken.delete(k);gen();});
ctrl.appendChild(breakBtn);
} else {
const breakBtn=document.createElement('button');
breakBtn.className='termBtn';
breakBtn.textContent='Set Break';
breakBtn.addEventListener('click',()=>{brks.add(k);gen();});
ctrl.appendChild(breakBtn);
}

hdr.appendChild(ctrl);
term.appendChild(hdr);

if(!isBreak && !tkMod){
const mds=SCH[k]||[];
if(tkn.f<rq.f){
const avail=mds.filter(m=>F.includes(m)&&![...taken.values()].includes(m));
avail.forEach(m=>{
const d=document.createElement('div');
d.className='mod';
d.innerHTML=`<span>ðŸŸ¦</span><span>${m}</span>`;
d.addEventListener('click', function() {
taken.set(k,m);
gen();
});
term.appendChild(d);
});
if(avail.length===0){
const d=document.createElement('div');
d.className='mod locked';
d.innerHTML='<span>ðŸ”’</span><span>No eligible foundation modules</span>';
term.appendChild(d);
}
} else if(tkn.f>=rq.f&&tkn.o<rq.o){
const avail=mds.filter(m=>cho.includes(m)&&![...taken.values()].includes(m));
const grid=document.createElement('div');
grid.className='modGrid';
avail.forEach(m=>{
const d=document.createElement('div');
d.className='mod';
d.innerHTML=`<span>ðŸŸ¥</span><span>${m}</span>`;
d.addEventListener('click', function() {
taken.set(k,m);
gen();
});
grid.appendChild(d);
});
if(avail.length===0){
const d=document.createElement('div');
d.className='mod locked';
d.innerHTML='<span>ðŸ”’</span><span>No eligible options available</span>';
grid.appendChild(d);
}
term.appendChild(grid);
} else if(tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r<rq.r){
const avail=mds.filter(m=>R.includes(m)&&![...taken.values()].includes(m));
avail.forEach(m=>{
const d=document.createElement('div');
d.className='mod';
d.innerHTML=`<span>ðŸŸª</span><span>${m}</span>`;
d.addEventListener('click', function() {
taken.set(k,m);
gen();
});
term.appendChild(d);
});
if(avail.length===0){
const d=document.createElement('div');
d.className='mod locked';
d.innerHTML='<span>ðŸ”’</span><span>Complete 4 foundations + 4 options first</span>';
term.appendChild(d);
}
} else if(tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r>=rq.r&&tkn.s<rq.s){
const avail=mds.filter(m=>S.includes(m));
if(avail.length>0){
const d=document.createElement('div');
d.className='mod';
d.innerHTML='<span>â¬›</span><span>Independent Synoptic Project (spans 2 periods)</span>';
d.addEventListener('click', function() {
taken.set(k,S[0]);
const ni=keys.indexOf(k);
if(ni>=0&&ni<keys.length-1)taken.set(keys[ni+1],S[0]);
gen();
});
term.appendChild(d);
} else {
const d=document.createElement('div');
d.className='mod locked';
d.innerHTML='<span>ðŸ”’</span><span>Complete research modules first</span>';
term.appendChild(d);
}
} else {
const d=document.createElement('div');
d.className='mod locked';
d.innerHTML='<span>âœ…</span><span>All requirements complete</span>';
term.appendChild(d);
}
} else if(tkMod){
const d=document.createElement('div');
d.className='mod taken';
const ic={'f':'ðŸŸ¦','o':'ðŸŸ¥','r':'ðŸŸª','s':'â¬›'};
const ty=getType(tkMod);
d.innerHTML=`<span>${ic[ty] || 'â¬œ'}</span><span><strong>${tkMod}</strong></span>`;
term.appendChild(d);
}

el.appendChild(term);
});

const se=document.getElementById('sum');
if (se) {
se.innerHTML=`<strong>Progress:</strong> <span class="kbd">Foundation ${tkn.f}/${rq.f}</span> <span class="kbd">Options ${tkn.o}/${rq.o}</span> <span class="kbd">Research ${tkn.r}/${rq.r}</span> <span class="kbd">Synoptic ${tkn.s}/${rq.s}</span>`;
}

const ge=document.getElementById('grad');
if (ge) {
const lastK=[...taken.keys()].sort().pop();
if(lastK&&tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r>=rq.r&&tkn.s>=rq.s){
ge.style.display='block';
ge.innerHTML=`ðŸŽ“ <strong>Estimated Graduation:</strong> <span class="ok">${fmtD(lastK)}</span>`;
} else {
ge.style.display='none';
}
}
} catch (error) {
console.error('Error in render:', error);
}
}

function vis(itk,tkn,rq,st){
try {
const lastK=[...taken.keys()].sort().pop();

const vDur = document.getElementById('vDur');
if (vDur) {
if(lastK){
const brkCount=brks.size;
const totalPeriods=keys.filter(k=>k>=st&&k<=lastK).length;
const studyPeriods=Math.max(0, totalPeriods-brkCount);
const durMonths=studyPeriods*2;
vDur.textContent=durMonths;
} else {
vDur.textContent='â€”';
}
}

const vBrk = document.getElementById('vBrk');
if (vBrk) {
vBrk.textContent=brks.size;
}

const tot=rq.f+rq.o+rq.r+rq.s;
const cur=tkn.f+tkn.o+tkn.r+tkn.s;
const pct=tot>0?Math.round((cur/tot)*100):0;

const vPct = document.getElementById('vPct');
if (vPct) {
vPct.textContent=pct+'%';
}

const progF=document.getElementById('progFill');
if (progF) {
progF.style.width=pct+'%';
progF.textContent=pct+'%';
}

const vGrad = document.getElementById('vGrad');
if (vGrad) {
if(lastK){
const fd=fmtD(lastK).split(' ');
if (fd.length >= 2) {
vGrad.innerHTML=fd[0]+'<br>'+fd[1];
} else {
vGrad.textContent=fmtD(lastK);
}
} else {
vGrad.textContent='â€”';
}
}

const imp=document.getElementById('impact');
if (imp && taken.size>0){
const baseline=calcBaseline(st,rq,getOpts());
if(baseline&&lastK){
const bPeriods=keys.filter(k=>k>=st&&k<=baseline).length;
const cPeriods=keys.filter(k=>k>=st&&k<=lastK).length;
const bMonths=bPeriods*2;
const cMonths=Math.max(0, (cPeriods-brks.size)*2);
const diff=cMonths-bMonths;
const diffTxt=diff===0?'No delay':(diff>0?`+${diff} months delay`:`${Math.abs(diff)} months faster`);
const cl=diff===0?'ok':(diff>0?'warn':'ok');
imp.innerHTML=`<strong>Impact:</strong> Baseline: <strong>${fmtD(baseline)}</strong> (${bMonths} months) Â· Your plan: <strong>${fmtD(lastK)}</strong> (${cMonths} months) Â· <span class="${cl}">${diffTxt}</span>`;
imp.style.display='block';
} else {
imp.style.display='none';
}
} else if (imp) {
imp.style.display='none';
}
} catch (error) {
console.error('Error in vis:', error);
}
}

function calcBaseline(st,rq,cho){
try {
const taken2=new Map();
let tkn={f:0,o:0,r:0,s:0};
const hs=addY(st,6);
const itk=keys.filter(k=>k>=st&&k<=hs);
const remF=new Set(F);
const remO=new Set(cho.length>=4?cho:O.slice(0,4));
const remR=new Set(R);

for(const k of itk){
if(tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r>=rq.r&&tkn.s>=rq.s)break;
const mds=SCH[k]||[];

if(tkn.f<rq.f){
const m=mds.find(x=>remF.has(x));
if(m){
taken2.set(k,m);
remF.delete(m);
tkn.f++;
continue;
}
}
if(tkn.f>=rq.f&&tkn.o<rq.o){
const m=mds.find(x=>remO.has(x));
if(m){
taken2.set(k,m);
remO.delete(m);
tkn.o++;
continue;
}
}
if(tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r<rq.r){
const m=mds.find(x=>remR.has(x));
if(m){
taken2.set(k,m);
remR.delete(m);
tkn.r++;
continue;
}
}
if(tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r>=rq.r&&tkn.s<rq.s){
const m=mds.find(x=>S.includes(x));
if(m){
taken2.set(k,m);
const ni=itk.indexOf(k);
if(ni>=0&&ni<itk.length-1)taken2.set(itk[ni+1],m);
tkn.s++;
break;
}
}
}
return [...taken2.keys()].sort().pop();
} catch (error) {
console.error('Error in calcBaseline:', error);
return null;
}
}

function updateBreakImpact(){
try {
const aw=document.getElementById('award')?.value || 'MSc';
const st=document.getElementById('start')?.value || '2023-09';
const rq={...REQ[aw]};
const cho=getOpts();
const baseline=calcBaseline(st,rq,cho);
const lastK=[...taken.keys()].sort().pop();
const el=document.getElementById('breakImpact');

if(!el) return;

if(brks.size===0){
el.textContent='No breaks selected';
} else if(baseline&&lastK){
const bPeriods=keys.filter(k=>k>=st&&k<=baseline).length;
const cPeriods=keys.filter(k=>k>=st&&k<=lastK).length;
const delay=(cPeriods-bPeriods)*2;
el.innerHTML=`${brks.size} break(s) = <span class="${delay>0?'warn':'ok'}">${delay>0?'+':''}${delay} months</span>`;
} else {
el.textContent=`${brks.size} break(s) selected`;
}
} catch (error) {
console.error('Error updating break impact:', error);
}
}

function quickFill(){
try {
const aw=document.getElementById('award')?.value || 'MSc';
const st=document.getElementById('start')?.value || '2023-09';
const rq={...REQ[aw]};
const tkn=getTkn();
const cho=getOpts();

if(rq.o>0&&cho.length<4){
showAlert('Please select 4 option modules first','warning');
return;
}
if(tkn.f>=rq.f&&tkn.o>=rq.o&&tkn.r>=rq.r&&tkn.s>=rq.s){
showAlert('Your plan is already complete!','success');
return;
}

const beforeCount=taken.size;
const hs=addY(st,6);
const itk=keys.filter(k=>k>=st&&k<=hs);
const remF=new Set(F.filter(m=>![...taken.values()].includes(m)));
const remO=new Set((cho.length>=4?cho:O.slice(0,4)).filter(m=>![...taken.values()].includes(m)));
const remR=new Set(R.filter(m=>![...taken.values()].includes(m)));
let curTkn={...tkn};

for(const k of itk){
if(curTkn.f>=rq.f&&curTkn.o>=rq.o&&curTkn.r>=rq.r&&curTkn.s>=rq.s)break;
if(taken.has(k)||brks.has(k))continue;
const mds=SCH[k]||[];

if(curTkn.f<rq.f){
const m=mds.find(x=>remF.has(x));
if(m){
taken.set(k,m);
remF.delete(m);
curTkn.f++;
continue;
}
}
if(curTkn.f>=rq.f&&curTkn.o<rq.o){
const m=mds.find(x=>remO.has(x));
if(m){
taken.set(k,m);
remO.delete(m);
curTkn.o++;
continue;
}
}
if(curTkn.f>=rq.f&&curTkn.o>=rq.o&&curTkn.r<rq.r){
const m=mds.find(x=>remR.has(x));
if(m){
taken.set(k,m);
remR.delete(m);
curTkn.r++;
continue;
}
}
if(curTkn.f>=rq.f&&curTkn.o>=rq.o&&curTkn.r>=rq.r&&curTkn.s<rq.s){
const m=mds.find(x=>S.includes(x));
if(m){
taken.set(k,m);
const ni=itk.indexOf(k);
if(ni>=0&&ni<itk.length-1)taken.set(itk[ni+1],m);
curTkn.s++;
break;
}
}
}

const afterCount=taken.size;
const added=afterCount-beforeCount;
gen();

if(added>0){
showAlert(`Added ${added} module${added>1?'s':''} to your plan!`,'success');
} else {
showAlert('No suitable modules found to add','warning');
}
} catch (error) {
console.error('Error in quickFill:', error);
showAlert('Error occurred during quick fill', 'warning');
}
}

function addBreaksToYear(year){
try {
const st=document.getElementById('start')?.value || '2023-09';
const startYear=parseInt(st.split('-')[0]);
const targetYear=startYear+year-1;

let added=0;
keys.forEach(k=>{
const keyYear=parseInt(k.split('-')[0]);
if(keyYear===targetYear&&!taken.has(k)&&!brks.has(k)){
brks.add(k);
added++;
}
});

gen();
if(added>0){
showAlert(`Added ${added} breaks to Year ${year}`,'success');
} else {
showAlert(`No available periods in Year ${year} for breaks`,'warning');
}
} catch (error) {
console.error('Error adding breaks:', error);
}
}

function clearAllBreaks(){
try {
const count=brks.size;
brks.clear();
gen();
if(count>0){
showAlert(`Cleared ${count} breaks`,'success');
} else {
showAlert('No breaks to clear','warning');
}
} catch (error) {
console.error('Error clearing breaks:', error);
}
}

function showOptimalPath(){
try {
taken.clear();
brks.clear();
quickFill();
} catch (error) {
console.error('Error showing optimal path:', error);
}
}

function resetPlan(){
try {
if(confirm('Reset everything? This cannot be undone.')){
taken.clear();
brks.clear();
const checkboxes = document.querySelectorAll('#opts input');
checkboxes.forEach(i=>i.checked=false);
updateChipSelection();
gen();
showAlert('Plan reset successfully', 'success');
}
} catch (error) {
console.error('Error in resetPlan:', error);
showAlert('Error occurred during reset', 'warning');
}
}

function showAlert(msg,type='success'){
try {
const existingAlerts = document.querySelectorAll('.alert');
existingAlerts.forEach(alert => alert.remove());

const al=document.createElement('div');
al.className=`alert ${type}`;

const closeBtn = document.createElement('span');
closeBtn.className = 'closeAlert';
closeBtn.textContent = 'Ã—';
closeBtn.addEventListener('click', function() {
al.remove();
});

const msgDiv = document.createElement('div');
msgDiv.style.paddingRight = '1.5rem';
msgDiv.textContent = msg;

al.appendChild(closeBtn);
al.appendChild(msgDiv);
document.body.appendChild(al);

setTimeout(()=>{
if (al.parentNode) {
al.remove();
}
}, 3000);
} catch (error) {
console.error('Error showing alert:', error);
}
}

window.quickFill = quickFill;
window.resetPlan = resetPlan;
window.addBreaksToYear = addBreaksToYear;
window.clearAllBreaks = clearAllBreaks;
window.showOptimalPath = showOptimalPath;

if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', init);
} else {
init();
}
</script>
</body>
</html>
