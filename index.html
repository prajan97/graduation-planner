<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KCL Study Planner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      /* Light Theme (Institutional) */
      --primary: #d50032;           /* KCL Crimson */
      --primary-light: #ff5a5f;
      --primary-dark: #9b0026;
      --secondary: #0055a4;
      --secondary-light: #4d8bc8;
      --secondary-dark: #003a75;
      --accent: #ffab00;
      --accent-light: #ffdd4b;
      --accent-dark: #c67c00;

      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #eceff3;      /* slightly warmer than default */
      --bg-card: #ffffff;

      --text-primary: #212529;
      --text-secondary: #3a3f45;
      --text-muted: #6c757d;

      --border: #dee2e6;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);

      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;

      --border-radius: 12px;
      --border-radius-sm: 8px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --font-size-base: 14px;
    }

    [data-theme="dark"] {
      /* Dark Theme */
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-tertiary: #2a2d31;
      --bg-card: #252525;

      --text-primary: #f8f9fa;
      --text-secondary: #e9ecef;
      --text-muted: #adb5bd;

      --border: #444;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.4);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.55;
      font-size: var(--font-size-base);
      transition: var(--transition);
    }

    .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      padding: 1.1rem 0;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      overflow: hidden;
    }
    header::before{
      content:'';
      position:absolute; inset:0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>') no-repeat center/cover;
      opacity:.12;
      pointer-events:none;
    }
    .header-content{ display:flex; justify-content:space-between; align-items:center; position:relative; z-index:1; gap:16px; }
    .logo { display:flex; align-items:center; gap:12px; }
    .kcl-logo {
      width:30px; height:30px; border-radius:6px;
      background: linear-gradient(135deg,#e21a3a,#d50032);
      display:flex; align-items:center; justify-content:center; font-weight:800; font-size:.8rem;
      letter-spacing:.02em;
    }
    .kcl-logo span { color:#fff; }
    .logo h1{ font-size:1.35rem; font-weight:700; margin-bottom:2px; }
    .logo .subtitle{ font-size:.85rem; opacity:.95; font-weight:400; }

    .header-actions{ display:flex; gap:10px; align-items:center; }
    .theme-toggle{
      background: rgba(255,255,255,0.22);
      border:none; border-radius:50%; width:38px; height:38px;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      transition: var(--transition); color: #fff; font-size:1rem;
    }
    .theme-toggle:hover{ background: rgba(255,255,255,0.3); transform: rotate(10deg); }

    /* Grid layout */
    .main-content{
      display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin:24px 0;
    }
    @media (max-width:1200px){ .main-content{ grid-template-columns:1fr; } }

    /* Cards */
    .card{
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 1.3rem;
      border: 1px solid transparent;
      transition: var(--transition);
    }
    .card:hover{ box-shadow: var(--shadow-hover); transform: translateY(-2px); }
    .card-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom: 1rem; padding-bottom:.6rem; border-bottom:1px solid var(--border);
    }
    .card-title{ font-size:1.15rem; font-weight:600; display:flex; align-items:center; gap:8px; }
    .card-title i{ color: var(--primary); font-size:1rem; }
    .card-subtitle{ font-size:.9rem; color: var(--text-muted); }

    /* Form */
    .form-group{ margin-bottom: 1.1rem; }
    .form-label{ display:block; margin-bottom:.5rem; font-weight:500; color:var(--text-secondary); font-size:.95rem; }
    .form-control{
      width:100%; padding:.7rem .9rem; border:1px solid var(--border); border-radius: var(--border-radius-sm);
      background: var(--bg-primary); color: var(--text-primary); font-size:.92rem; transition: var(--transition);
    }
    .form-control:focus{ outline:none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(213,0,50,0.15); }

    /* Buttons */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:.7rem 1.1rem; background: var(--primary); color:#fff; border:none; border-radius: var(--border-radius-sm);
      font-size:.92rem; font-weight:600; cursor:pointer; transition: var(--transition);
    }
    .btn:hover{ background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(213,0,50,.3); }
    .btn:active{ transform: translateY(0); }
    .btn-outline{
      background: transparent; color: var(--primary); border:2px solid var(--primary);
    }
    .btn-outline:hover{ background: var(--primary); color:#fff; }
    .btn-secondary{ background: var(--secondary); }
    .btn-secondary:hover{ background: var(--secondary-light); box-shadow: 0 4px 12px rgba(0,85,164,.3); }
    .small-btn{ padding:6px 10px; font-size:.78rem; border-radius:6px; }

    /* Tags (Options) */
    .module-tags{ display:flex; flex-wrap: wrap; gap:8px; margin-top:10px; }
    .module-tag{
      display:flex; align-items:center; gap:6px; padding:8px 12px; background: var(--bg-secondary);
      border-radius:30px; font-size:.86rem; cursor:pointer; transition: var(--transition); border:1px solid transparent;
    }
    .module-tag:hover{ background: var(--bg-tertiary); transform: translateY(-1px); }
    .module-tag.selected{ background: rgba(213,0,50,0.08); color: var(--primary); font-weight:600; border-color: var(--primary); }
    .module-tag input{ margin:0; }

    /* Analytics */
    .compact-analytics{ display:grid; grid-template-columns: 1fr; gap:14px; }
    .compact-analytics-card{
      padding:14px; background: var(--bg-card); border-radius: var(--border-radius);
      box-shadow: var(--shadow); text-align:center; transition: var(--transition); border-top:4px solid var(--secondary);
    }
    .compact-analytics-card:hover{ transform: translateY(-2px); box-shadow: var(--shadow-hover); }
    .compact-analytics-value{ font-size:1.45rem; font-weight:700; margin:6px 0; color: var(--secondary); }
    .compact-analytics-label{ font-size:.82rem; color: var(--text-muted); font-weight:500; }

    /* Progress */
    .progress-container{ margin:16px 0; }
    .progress-bar{
      height:12px; background: var(--bg-tertiary); border-radius:6px; overflow:hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,.08);
    }
    .progress-fill{
      height:100%; background: linear-gradient(90deg, var(--primary), var(--primary-light));
      border-radius:6px; transition: width .7s cubic-bezier(0.22, 0.61, 0.36, 1); position:relative; overflow:hidden;
    }
    .progress-fill::after{
      content:''; position:absolute; inset:0; background: linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer{ 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
    .progress-text{ display:flex; justify-content:space-between; margin-top:6px; font-size:.85rem; font-weight:500; }

    /* Timeline */
    .timeline{
      margin-top: 12px; max-height: 640px; overflow-y:auto;
      border:1px solid var(--border); border-radius: var(--border-radius); padding:12px; background: var(--bg-secondary);
    }
    .timeline-period{ margin-bottom:14px; border:1px solid var(--border); border-radius: var(--border-radius); overflow:hidden; transition: var(--transition); }
    .timeline-period:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .period-header{
      background: var(--bg-tertiary); padding:10px 14px; display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid var(--border);
    }
    .period-title{ font-weight:600; font-size:.92rem; }
    .period-actions{ display:flex; gap:6px; }
    .period-modules{ padding:10px 14px; background: var(--bg-card); }
    .compact-module-list{ display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:8px; }
    .compact-module-item{
      padding:8px 10px; background: var(--bg-secondary); border-radius: var(--border-radius-sm); font-size:.82rem;
      cursor:pointer; transition: var(--transition); border-left:4px solid var(--info); position:relative;
    }
    .compact-module-item:hover{ background: var(--bg-tertiary); transform: translateY(-1px); }
    .compact-module-item.option{ border-left-color: var(--primary); }
    .compact-module-item.research{ border-left-color: var(--warning); }
    .compact-module-item.synoptic{ border-left-color: var(--success); }
    .compact-module-item.taken{ background: rgba(40,167,69,.08); font-weight:600; }
    .compact-module-item.break{ background: rgba(255,193,7,.1); border-left-color: var(--warning); }
    .compact-module-item.locked{ background: rgba(220,53,69,.08); border-left-color: var(--danger); cursor:not-allowed; }

    /* Module info popup */
    .module-info-popup{
      position:absolute; bottom:100%; left:0; background: var(--bg-card); border:1px solid var(--border);
      border-radius: var(--border-radius); padding:10px; box-shadow: var(--shadow-hover); z-index: 10;
      width:250px; font-size:.75rem; display:none; color: var(--text-primary);
    }
    .compact-module-item:hover .module-info-popup{ display:block; animation: fadeIn .25s ease; }
    @keyframes fadeIn{ from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

    /* Phase Indicator */
    .phase-indicator{ display:grid; grid-template-columns: repeat(4,1fr); gap:8px; margin: 0 0 16px 0; }
    .phase{
      padding:10px 8px; text-align:center; border-radius: var(--border-radius); background: var(--bg-card);
      box-shadow: var(--shadow); transition: var(--transition); position:relative; overflow:hidden;
    }
    .phase::before{ content:''; position:absolute; top:0; left:0; right:0; height:3px; background: var(--border); }
    .phase.active{ background: var(--primary); color:#fff; transform: translateY(-1px); box-shadow: 0 6px 15px rgba(213,0,50,.25); }
    .phase.active::before{ background: var(--primary-light); }
    .phase.completed{ background: var(--success); color:#fff; }
    .phase.completed::before{ background: var(--success); }
    .phase-title{ font-weight:600; font-size:.86rem; margin-bottom:3px; }
    .phase-subtitle{ font-size:.76rem; opacity:.95; }

    /* Alerts / Toasts */
    .alert{
      position: fixed; top: 15px; right: 15px; padding: 12px 14px; background: var(--bg-card);
      border-left: 4px solid var(--success); border-radius: var(--border-radius); box-shadow: var(--shadow-hover);
      z-index: 1000; max-width: 320px; display:flex; gap:10px; align-items:center; animation: slideIn .35s ease;
    }
    .alert.warning{ border-left-color: var(--warning); }
    .alert.error{ border-left-color: var(--danger); }
    .alert.info{ border-left-color: var(--info); }
    .close-alert{ cursor:pointer; font-weight:700; opacity:.7; transition: var(--transition); margin-left:auto; font-size:.9rem; }
    .close-alert:hover{ opacity:1; }
    @keyframes slideIn{ from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }

    /* Conflict Warning (inline) */
    .conflict-warning{
      background: rgba(255,193,7,.1); border:1px solid var(--warning);
      border-radius: var(--border-radius); padding: 12px; margin: 12px 0;
      font-size:.86rem; border-left:4px solid var(--warning);
    }

    /* Scrollbar */
    ::-webkit-scrollbar{ width:6px; }
    ::-webkit-scrollbar-track{ background: var(--bg-secondary); border-radius:3px; }
    ::-webkit-scrollbar-thumb{ background: var(--border); border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover{ background: var(--text-muted); }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <div class="kcl-logo"><span>KCL</span></div>
          <div>
            <h1>KCL Study Planner</h1>
            <div class="subtitle">Plan your part-time Psychology & Neuroscience of Mental Health programme</div>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-outline" onclick="savePlan()"><i class="fas fa-save"></i> Save</button>
          <button class="btn btn-outline" onclick="loadPlan()"><i class="fas fa-folder-open"></i> Load</button>
          <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme"><i class="fas fa-moon"></i></button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Phase indicator -->
    <div class="phase-indicator">
      <div class="phase" id="phaseFnd">
        <div class="phase-title">Foundation</div>
        <div class="phase-subtitle">4 Modules</div>
      </div>
      <div class="phase" id="phaseOpt">
        <div class="phase-title">Options</div>
        <div class="phase-subtitle">Choose 4</div>
      </div>
      <div class="phase" id="phaseRes">
        <div class="phase-title">Research</div>
        <div class="phase-subtitle">2 Modules</div>
      </div>
      <div class="phase" id="phaseSyn">
        <div class="phase-title">Synoptic</div>
        <div class="phase-subtitle">Project</div>
      </div>
    </div>

    <div class="main-content">
      <!-- LEFT: Study Timeline + Program Setup -->
      <div>
        <!-- Study Timeline -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-calendar-alt"></i> Study Timeline</div>
            <div>
              <span id="notificationCount" class="notification-badge" style="display:none;">0</span>
              <button class="btn btn-outline small-btn" onclick="showNotifications()"><i class="fas fa-bell"></i> Notifications</button>
            </div>
          </div>
          <div id="phaseInfo" class="card-subtitle"></div>
          <div id="conflictWarning" class="conflict-warning" style="display:none;"></div>
          <div id="tl" class="timeline"></div>
        </div>

        <!-- Program Setup -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-cog"></i> Program Setup</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="award">Select Award</label>
            <select class="form-control" id="award">
              <option value="PGCert">PG Cert (60 credits)</option>
              <option value="PGDip">PG Dip (120 credits)</option>
              <option value="MSc" selected>MSc (180 credits)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="start">Start Date</label>
            <select class="form-control" id="start"></select>
          </div>
          <div class="btn-group" style="display:flex; gap:10px; margin-top:.5rem;">
            <button class="btn" onclick="quickFill()"><i class="fas fa-bolt"></i> Quick Fill</button>
            <button class="btn btn-outline" onclick="resetPlan()"><i class="fas fa-redo"></i> Reset</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Options + Analytics -->
      <div>
        <!-- Select Option Modules -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-tasks"></i> Select Option Modules</div>
            <div class="card-subtitle">Choose 4 of 10 available</div>
          </div>
          <div class="module-tags" id="opts"></div>
          <div id="wbox" class="alert warning" style="display:none; position:static; margin-top:12px;"></div>
        </div>

        <!-- Graduation Plan / Analytics -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><i class="fas fa-graduation-cap"></i> Graduation Plan</div>
          </div>
          <div class="compact-analytics">
            <div class="compact-analytics-card">
              <div class="compact-analytics-label">Estimated Graduation</div>
              <div class="compact-analytics-value" id="vGrad">—</div>
              <div class="compact-analytics-label">with current plan</div>
            </div>
            <div class="compact-analytics-card">
              <div class="compact-analytics-label">Study Duration</div>
              <div class="compact-analytics-value" id="vDur">—</div>
              <div class="compact-analytics-label">months</div>
            </div>
            <div class="compact-analytics-card">
              <div class="compact-analytics-label">Progress</div>
              <div class="compact-analytics-value" id="vPct">0%</div>
              <div class="compact-analytics-label">completed</div>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-bar"><div class="progress-fill" id="progFill" style="width:0%"></div></div>
            <div class="progress-text"><span>Start</span><span id="progText">0% Complete</span><span>Graduation</span></div>
          </div>
          <div class="export-options" style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-outline" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
            <button class="btn btn-outline" onclick="exportToCalendar()"><i class="fas fa-calendar-plus"></i> Export Calendar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* Theme toggle */
    const themeToggle = document.getElementById('themeToggle');
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const currentTheme = localStorage.getItem('theme') || (prefersDarkScheme.matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', currentTheme);
    updateThemeIcon(currentTheme);
    themeToggle.addEventListener('click', () => {
      const theme = document.documentElement.getAttribute('data-theme');
      const next = theme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeIcon(next);
    });
    function updateThemeIcon(theme){ themeToggle.querySelector('i').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; }

    /* Modules (with info) */
    const MODULES = {
      foundation: [
        { name:'Biological Foundations of Mental Health', credits:15, description:'Core biological principles underlying mental health disorders.' },
        { name:'Techniques in Neuroscience', credits:15, description:'Methodologies and techniques used in neuroscience research.' },
        { name:'Psychological Foundations of Mental Health', credits:15, description:'Psychological theories and models of mental health.' },
        { name:'Mental Health in the Community', credits:15, description:'Community-based approaches to mental health care.' }
      ],
      options: [
        { name:'Mindfulness: Neuroscience & Application', credits:15, description:'Neuroscientific basis and practical applications of mindfulness.' },
        { name:'Global Mental Health', credits:15, description:'Mental health challenges and solutions in a global context.' },
        { name:'Psychology & Neuroscience of Addiction', credits:15, description:'Biological and psychological aspects of addiction.' },
        { name:'Child & Adolescent Mental Health', credits:15, description:'Developmental perspectives on youth mental health.' },
        { name:'Social, Genetic & Environmental Basis of Mental Health', credits:15, description:'Interplay of social, genetic and environmental factors.' },
        { name:'Neuroscience in Society', credits:15, description:'Ethical and societal implications of neuroscience.' },
        { name:'Psychology & Neuroscience of Affective Disorders', credits:15, description:'Mood disorders from psych & neuro perspectives.' },
        { name:'Psychology & Neuroscience of Psychosis', credits:15, description:'Understanding psychosis through multiple lenses.' },
        { name:'Neuroimaging in Mental Health', credits:15, description:'Neuroimaging techniques in mental health research.' },
        { name:'Pharmacotherapies in Mental Health', credits:15, description:'Pharmacological treatments for mental health conditions.' }
      ],
      research: [
        { name:'Research Skills: From Reviewing & Critical Analysis to Research Ethics', credits:15, description:'Fundamental research skills and ethical considerations.' },
        { name:'Research Skills: From Methods & Procedures to Analysis & Reporting', credits:15, description:'Advanced methodologies and analytical techniques.' }
      ],
      synoptic: [
        { name:'Independent Synoptic Project', credits:60, description:'Comprehensive research project integrating programme learning.' }
      ]
    };
    const F = MODULES.foundation.map(m=>m.name);
    const O = MODULES.options.map(m=>m.name);
    const R = MODULES.research.map(m=>m.name);
    const S = MODULES.synoptic.map(m=>m.name);

    /* Schedule */
    const SCH = {
      "2023-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2023-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2023-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2023-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2023-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2023-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2024-01":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2024-03":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2024-05":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2024-06":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2024-09":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2024-10":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2025-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2025-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2025-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2025-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2025-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2025-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2026-01":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2026-03":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2026-05":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2026-06":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2026-09":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2026-10":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2027-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2027-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],
      "2027-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],
      "2027-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"]
    };

    const REQ = {
      PGCert:{f:4,o:0,r:0,s:0},
      PGDip:{f:4,o:4,r:0,s:0},
      MSc:{f:4,o:4,r:2,s:1}
    };

    const keys = Object.keys(SCH).sort();
    const brks = new Set();
    const taken = new Map();

    /* Utils */
    const addY = (k,y)=>{ const [yr,m]=k.split('-').map(Number); return `${yr+y}-${String(m).padStart(2,'0')}`; }
    const fmtD = k => { const [y,m]=k.split('-').map(Number); return new Date(y,m-1,1).toLocaleString('en-GB',{month:'short',year:'numeric'}); }
    const getType = m => F.includes(m)?'foundation': O.includes(m)?'option': R.includes(m)?'research': S.includes(m)?'synoptic':'unknown';
    function getOpts(){ return [...document.querySelectorAll('#opts input:checked')].map(c=>c.dataset.name).slice(0,4); }

    function getTkn(){
      let t={f:0,o:0,r:0,s:0};
      taken.forEach(v=>{
        const ty=getType(v);
        if(ty==='foundation') t.f++;
        else if(ty==='option') t.o++;
        else if(ty==='research') t.r++;
        else if(ty==='synoptic') t.s++;
      });
      return t;
    }
    function getActualCompletion(){
      const completedFoundations = F.filter(f => [...taken.values()].includes(f)).length;
      const cho=getOpts();
      const completedOptions = cho.filter(o => [...taken.values()].includes(o)).length;
      const completedResearch = R.filter(r => [...taken.values()].includes(r)).length;
      const completedSynoptic = S.filter(s => [...taken.values()].includes(s)).length;
      return { foundations:completedFoundations, options:completedOptions, research:completedResearch, synoptic:completedSynoptic };
    }

    function updatePhaseIndicator(actual,rq){
      const Fnd=document.getElementById('phaseFnd');
      const Opt=document.getElementById('phaseOpt');
      const Res=document.getElementById('phaseRes');
      const Syn=document.getElementById('phaseSyn');

      Fnd.className = actual.foundations>=rq.f ? 'phase completed' : 'phase active';
      Opt.className = (actual.foundations>=rq.f && actual.options>=rq.o) ? 'phase completed'
                   : (actual.foundations>=rq.f ? 'phase active' : 'phase');
      Res.className = (actual.foundations>=rq.f && actual.options>=rq.o && actual.research>=rq.r) ? 'phase completed'
                   : (actual.foundations>=rq.f && actual.options>=rq.o ? 'phase active' : 'phase');
      Syn.className = (actual.foundations>=rq.f && actual.options>=rq.o && actual.research>=rq.r && actual.synoptic>=rq.s) ? 'phase completed'
                   : (actual.foundations>=rq.f && actual.options>=rq.o && actual.research>=rq.r ? 'phase active' : 'phase');
    }

    /* Init */
    let isInitialized=false;
    function init(){
      if(isInitialized) return; isInitialized=true;

      const startS=document.getElementById('start');
      startS.innerHTML='';
      keys.forEach(k=>{
        const [y,m]=k.split('-').map(Number);
        const d=new Date(y,m-1,1);
        const o=document.createElement('option'); o.value=k; o.textContent=d.toLocaleString('en-GB',{month:'short',year:'numeric'});
        startS.appendChild(o);
      });
      startS.value='2023-09';
      startS.addEventListener('change', gen);
      document.getElementById('award').addEventListener('change', gen);

      /* Options */
      const optsW=document.getElementById('opts');
      optsW.innerHTML='';
      MODULES.options.forEach(module=>{
        const id='o'+module.name.replace(/[^a-z0-9]/gi,'');
        const label=document.createElement('label');
        label.className='module-tag';
        const checkbox=document.createElement('input');
        checkbox.type='checkbox'; checkbox.id=id; checkbox.dataset.name=module.name;
        checkbox.addEventListener('change', function(){
          const checked=[...document.querySelectorAll('#opts input:checked')];
          if(checked.length>4){ this.checked=false; showAlert('You can only select 4 option modules','warning'); return; }
          if(!this.checked){
            const deselected=this.dataset.name; const toRemove=[];
            taken.forEach((mod,period)=>{ if(mod===deselected) toRemove.push(period); });
            toRemove.forEach(p=>taken.delete(p));
          }
          label.classList.toggle('selected', this.checked);
          gen();
        });
        label.appendChild(checkbox);
        const text=document.createElement('span'); text.textContent=module.name; label.appendChild(text);

        const info=document.createElement('div');
        info.className='module-info-popup';
        info.innerHTML=`<strong>${module.name}</strong><br/><em>${module.credits} credits</em><br/>${module.description}`;
        label.appendChild(info);
        optsW.appendChild(label);
      });

      // Load saved plan (optional)
      const saved=localStorage.getItem('kclGraduationPlan');
      if(saved){ try{ const p=JSON.parse(saved); if(p.start) startS.value=p.start; }catch{} }

      gen();
    }

    /* Render */
    function gen(){
      const aw=document.getElementById('award').value || 'MSc';
      const st=document.getElementById('start').value || '2023-09';
      const rq={...REQ[aw]};
      const cho=getOpts();
      const tkn=getTkn();
      const actual=getActualCompletion();

      const wb=document.getElementById('wbox');
      if(rq.o>0 && cho.length<4){ wb.textContent=`Please select 4 option modules (required for ${aw})`; wb.style.display='block'; } else { wb.style.display='none'; }

      const hs=addY(st,8);
      const itk=keys.filter(k=>k>=st && k<=hs);
      renderTimeline(itk, st, rq, tkn, cho, actual);
      vis(itk, tkn, rq, st, actual);
      updateConflictWarnings();
      checkNotifications();
    }

    function renderTimeline(itk, st, rq, tkn, cho, actual){
      const el=document.getElementById('tl'); el.innerHTML='';

      // Phase status banner
      const pi=document.getElementById('phaseInfo');
      if(actual.foundations<rq.f) pi.textContent=`Current Phase: Complete ${rq.f-actual.foundations} more foundation module(s)`;
      else if(actual.options<rq.o) pi.textContent=`Current Phase: Complete ${rq.o-actual.options} more option module(s)`;
      else if(actual.research<rq.r) pi.textContent=`Current Phase: Complete ${rq.r-actual.research} more research module(s)`;
      else if(actual.synoptic<rq.s) pi.textContent=`Current Phase: Complete the Synoptic Project`;
      else pi.textContent='All requirements complete';

      updatePhaseIndicator(actual, rq);

      itk.forEach(k=>{
        const period=document.createElement('div'); period.className='timeline-period';
        const header=document.createElement('div'); header.className='period-header';
        const title=document.createElement('div'); title.className='period-title'; title.textContent=fmtD(k);
        const actions=document.createElement('div'); actions.className='period-actions';

        const tkMod=taken.get(k); const isBreak=brks.has(k);

        if(isBreak){
          const btn=document.createElement('button'); btn.className='btn btn-outline small-btn'; btn.textContent='Remove Break';
          btn.onclick=()=>{ brks.delete(k); gen(); }; actions.appendChild(btn);
        } else if(tkMod){
          const rm=document.createElement('button'); rm.className='btn btn-outline small-btn'; rm.textContent='Remove';
          rm.onclick=()=>{ taken.delete(k); gen(); }; actions.appendChild(rm);
          const br=document.createElement('button'); br.className='btn btn-outline small-btn'; br.textContent='Break';
          br.onclick=()=>{ brks.add(k); taken.delete(k); gen(); }; actions.appendChild(br);
        } else {
          const br=document.createElement('button'); br.className='btn btn-outline small-btn'; br.textContent='Set Break';
          br.onclick=()=>{ brks.add(k); gen(); }; actions.appendChild(br);
        }

        header.appendChild(title); header.appendChild(actions); period.appendChild(header);

        const modules=document.createElement('div'); modules.className='period-modules';

        if(!isBreak && !tkMod){
          const mds=SCH[k]||[]; let available=[];
          if(actual.foundations<rq.f){
            available=mds.filter(m=>F.includes(m) && ![...taken.values()].includes(m));
          } else if(actual.options<rq.o){
            available=mds.filter(m=>cho.includes(m) && ![...taken.values()].includes(m));
          } else if(actual.research<rq.r){
            available=mds.filter(m=>R.includes(m) && ![...taken.values()].includes(m));
          } else if(actual.synoptic<rq.s){
            available=mds.filter(m=>S.includes(m));
          }

          if(available.length>0){
            const list=document.createElement('div'); list.className='compact-module-list';
            available.forEach(m=>{
              const type=getType(m);
              const item=document.createElement('div');
              item.className=`compact-module-item ${type}`;
              item.textContent=m; item.title=m;

              // info popup
              let data;
              if(type==='foundation') data=MODULES.foundation.find(x=>x.name===m);
              else if(type==='option') data=MODULES.options.find(x=>x.name===m);
              else if(type==='research') data=MODULES.research.find(x=>x.name===m);
              else if(type==='synoptic') data=MODULES.synoptic.find(x=>x.name===m);

              if(data){
                const info=document.createElement('div');
                info.className='module-info-popup';
                info.innerHTML=`<strong>${data.name}</strong><br/><em>${data.credits} credits</em><br/>${data.description}`;
                item.appendChild(info);
              }

              item.addEventListener('click', ()=>{
                if(type==='synoptic'){
                  taken.set(k,m);
                  const i=keys.indexOf(k); if(i<keys.length-1) taken.set(keys[i+1], m);
                } else { taken.set(k,m); }
                gen();
              });

              list.appendChild(item);
            });
            modules.appendChild(list);
          } else {
            let msg='No available modules';
            if(actual.foundations<rq.f) msg=`Complete ${rq.f-actual.foundations} more foundation module(s) first`;
            else if(actual.options<rq.o) msg=`Complete ${rq.o-actual.options} more option module(s) first`;
            modules.innerHTML=`<div style="font-size:.82rem;color:var(--text-muted);text-align:center;padding:8px;">${msg}</div>`;
          }
        } else if(tkMod){
          const type=getType(tkMod);
          const item=document.createElement('div'); item.className=`compact-module-item ${type} taken`; item.textContent=tkMod; item.title=tkMod;
          modules.appendChild(item);
        } else if(isBreak){
          modules.innerHTML=`<div style="font-size:.82rem;color:var(--warning);text-align:center;padding:8px;">Study Break Period</div>`;
        }

        period.appendChild(modules);
        el.appendChild(period);
      });
    }

    function vis(itk, tkn, rq, st, actual){
      const lastK=[...taken.keys()].sort().pop();
      const vDur=document.getElementById('vDur');
      if(vDur){
        if(lastK){
          const brkCount=brks.size;
          const total=keys.filter(k=>k>=st && k<=lastK).length;
          const studyPeriods=Math.max(0,total-brkCount);
          vDur.textContent=studyPeriods*2;
        } else vDur.textContent='—';
      }

      const tot=rq.f+rq.o+rq.r+rq.s;
      const cur=actual.foundations+actual.options+actual.research+actual.synoptic;
      const pct=tot?Math.round((cur/tot)*100):0;
      const vPct=document.getElementById('vPct'); if(vPct) vPct.textContent=pct+'%';
      const bar=document.getElementById('progFill'); const txt=document.getElementById('progText');
      if(bar && txt){ bar.style.width=pct+'%'; txt.textContent=pct+'% Complete'; }

      const vGrad=document.getElementById('vGrad');
      if(vGrad){
        if(lastK){
          const [y,m]=lastK.split('-').map(Number);
          let gradM=m+2, gradY=y; if(gradM>12){ gradM-=12; gradY+=1; }
          vGrad.textContent=new Date(gradY,gradM-1,1).toLocaleString('en-GB',{month:'short',year:'numeric'});
        } else vGrad.textContent='—';
      }
    }

    /* Actions */
    function quickFill(){
      const aw=document.getElementById('award').value || 'MSc';
      const st=document.getElementById('start').value || '2023-09';
      const rq={...REQ[aw]};
      const cho=getOpts();
      if(rq.o>0 && cho.length<4){ showAlert('Please select 4 option modules first','warning'); return; }
      const actual=getActualCompletion();
      if(actual.foundations>=rq.f && actual.options>=rq.o && actual.research>=rq.r && actual.synoptic>=rq.s){
        showAlert('Your plan is already complete!','success'); return;
      }
      const before=taken.size; const hs=addY(st,8); const itk=keys.filter(k=>k>=st && k<=hs);
      const remF=new Set(F.filter(m=>![...taken.values()].includes(m)));
      const remO=new Set((cho.length>=4?cho:O.slice(0,4)).filter(m=>![...taken.values()].includes(m)));
      const remR=new Set(R.filter(m=>![...taken.values()].includes(m)));

      let cF=actual.foundations, cO=actual.options, cR=actual.research, cS=actual.synoptic;

      for(const k of itk){
        if(cF>=rq.f && cO>=rq.o && cR>=rq.r && cS>=rq.s) break;
        if(taken.has(k) || brks.has(k)) continue;
        const mds=SCH[k]||[];

        if(cF<rq.f){
          const m=mds.find(x=>remF.has(x)); if(m){ taken.set(k,m); remF.delete(m); cF++; continue; }
        }
        if(cF>=rq.f && cO<rq.o){
          const m=mds.find(x=>remO.has(x)); if(m){ taken.set(k,m); remO.delete(m); cO++; continue; }
        }
        if(cF>=rq.f && cO>=rq.o && cR<rq.r){
          const m=mds.find(x=>remR.has(x)); if(m){ taken.set(k,m); remR.delete(m); cR++; continue; }
        }
        if(cF>=rq.f && cO>=rq.o && cR>=rq.r && cS<rq.s){
          const m=mds.find(x=>S.includes(x));
          if(m){ taken.set(k,m); const i=itk.indexOf(k); if(i>=0 && i<itk.length-1) taken.set(itk[i+1],m); cS++; break; }
        }
      }
      const added=taken.size-before; gen();
      if(added>0) showAlert(`Added ${added} module${added>1?'s':''} to your plan!`,'success');
      else showAlert('No suitable modules found to add','warning');
    }

    function resetPlan(){
      if(!confirm('Reset everything? This cannot be undone.')) return;
      taken.clear(); brks.clear();
      document.querySelectorAll('#opts input').forEach(i=>i.checked=false);
      gen(); showAlert('Plan reset successfully','success');
    }

    /* Alerts */
    function showAlert(msg,type='success'){
      document.querySelectorAll('.alert').forEach(a=>a.remove());
      const el=document.createElement('div'); el.className=`alert ${type}`;
      const close=document.createElement('span'); close.className='close-alert'; close.textContent='×'; close.onclick=()=>el.remove();
      const txt=document.createElement('div'); txt.style.paddingRight='1.2rem'; txt.textContent=msg;
      el.appendChild(close); el.appendChild(txt); document.body.appendChild(el);
      setTimeout(()=>{ if(el.parentNode) el.remove(); }, 3800);
    }

    /* Save / Load */
    function savePlan(){
      const plan={
        award: document.getElementById('award').value,
        start: document.getElementById('start').value,
        selectedOptions: getOpts(),
        taken: Array.from(taken.entries()),
        breaks: Array.from(brks),
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('kclGraduationPlan', JSON.stringify(plan));
      showAlert('Plan saved successfully!','success');
    }
    function loadPlan(){
      const raw=localStorage.getItem('kclGraduationPlan');
      if(!raw){ showAlert('No saved plan found','warning'); return; }
      try{
        const plan=JSON.parse(raw);
        document.getElementById('award').value=plan.award;
        document.getElementById('start').value=plan.start;

        document.querySelectorAll('#opts input').forEach(c=>{
          c.checked = plan.selectedOptions.includes(c.dataset.name);
        });

        taken.clear(); brks.clear();
        plan.taken.forEach(([p,m])=>taken.set(p,m));
        plan.breaks.forEach(b=>brks.add(b));

        gen(); showAlert('Plan loaded successfully!','success');
      }catch(e){ console.error(e); showAlert('Error loading saved plan','error'); }
    }

    /* Export placeholders */
    function exportToPDF(){ showAlert('PDF export would be generated here','info'); }
    function exportToCalendar(){ showAlert('Calendar export would be generated here','info'); }

    /* Conflicts / Notifications */
    function detectConflicts(){
      const conflicts=[];
      const aw=document.getElementById('award').value || 'MSc';
      const rq={...REQ[aw]};
      const actual=getActualCompletion();
      const selectedOptions=getOpts();
      const takenOptions=[...taken.values()].filter(m=>O.includes(m));

      takenOptions.forEach(m=>{ if(!selectedOptions.includes(m)) conflicts.push(`Module "${m}" is scheduled but not selected in your options.`); });

      const tks=[...taken.keys()].sort();
      let fDone=false, oDone=false, rDone=false;
      tks.forEach(period=>{
        const m=taken.get(period); const ty=getType(m);
        if(ty==='option' && !fDone) conflicts.push(`Option "${m}" scheduled before completing all foundation modules.`);
        if(ty==='research' && (!fDone || !oDone)) conflicts.push(`Research "${m}" scheduled before completing foundation + options.`);
        if(ty==='synoptic' && (!fDone || !oDone || !rDone)) conflicts.push(`Synoptic scheduled before completing all prerequisites.`);
        if(ty==='foundation' && actual.foundations>=rq.f) fDone=true;
        if(ty==='option' && actual.options>=rq.o) oDone=true;
        if(ty==='research' && actual.research>=rq.r) rDone=true;
      });
      return conflicts;
    }
    function updateConflictWarnings(){
      const c=detectConflicts(); const box=document.getElementById('conflictWarning');
      if(c.length>0){ box.innerHTML=`<strong>Planning Conflicts Detected:</strong><ul>${c.map(x=>`<li>${x}</li>`).join('')}</ul>`; box.style.display='block'; }
      else { box.style.display='none'; }
    }

    function checkNotifications(){
      const notes=[];
      const aw=document.getElementById('award').value || 'MSc';
      const st=document.getElementById('start').value || '2023-09';
      const rq={...REQ[aw]};
      const actual=getActualCompletion();

      const now=new Date();
      const upcoming=keys.filter(k=>{
        const [y,m]=k.split('-').map(Number); const d=new Date(y,m-1,1);
        const days=(d-now)/(1000*60*60*24); return days>0 && days<60;
      });
      if(upcoming.length>0) notes.push(`Registration deadline approaching for ${fmtD(upcoming[0])}`);

      if(actual.foundations<rq.f) notes.push(`Complete ${rq.f-actual.foundations} more foundation module(s)`);
      else if(actual.options<rq.o) notes.push(`Complete ${rq.o-actual.options} more option module(s)`);
      else if(actual.research<rq.r) notes.push(`Complete ${rq.r-actual.research} more research module(s)`);
      else if(actual.synoptic<rq.s) notes.push(`Complete the synoptic project`);

      const badge=document.getElementById('notificationCount');
      if(notes.length>0){ badge.textContent=notes.length; badge.className='notification-badge'; }
      else { badge.style.display='none'; }
      return notes;
    }
    function showNotifications(){
      const n=checkNotifications();
      if(n.length===0) showAlert('No notifications at this time','info');
      else showAlert(`Notifications:\n\n${n.map((x,i)=>`${i+1}. ${x}`).join('\n')}`,'info');
    }

    /* Boot */
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  </script>
</body>
</html>
