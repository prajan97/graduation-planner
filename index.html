<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCL PNOMH Graduation Planner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Light Theme Colors */
            --primary: #d50032;
            --primary-light: #ff5a5f;
            --primary-dark: #9b0026;
            --secondary: #0055a4;
            --secondary-light: #4d8bc8;
            --secondary-dark: #003a75;
            --accent: #ffab00;
            --accent-light: #ffdd4b;
            --accent-dark: #c67c00;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-card: #ffffff;
            
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            
            --border: #dee2e6;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --font-size-base: 14px;
        }

        [data-theme="dark"] {
            /* Dark Theme Colors */
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --bg-card: #252525;
            
            --text-primary: #f8f9fa;
            --text-secondary: #e9ecef;
            --text-muted: #adb5bd;
            
            --border: #444;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: var(--font-size-base);
            transition: var(--transition);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles - Updated to solid KCL red */
        header {
            background: #d50032; /* Solid KCL red */
            color: white;
            padding: 1.2rem 0;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }

        .logo .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: white;
            font-size: 1rem;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg);
        }

        /* Main Content Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 25px 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles */
        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 20px;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: var(--primary);
            font-size: 1rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 0.9rem;
            border: 1px solid var(--border);
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(213, 0, 50, 0.15);
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0.75rem 1.2rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(213, 0, 50, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-light);
            box-shadow: 0 4px 12px rgba(0, 85, 164, 0.3);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-accent {
            background-color: var(--accent);
            color: #212529;
        }

        .btn-accent:hover {
            background-color: var(--accent-light);
            box-shadow: 0 4px 12px rgba(255, 171, 0, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 1.2rem;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Module Tags */
        .module-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .module-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background-color: var(--bg-secondary);
            border-radius: 30px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .module-tag:hover {
            background-color: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .module-tag.selected {
            background-color: rgba(213, 0, 50, 0.1);
            color: var(--primary);
            font-weight: 600;
            border-color: var(--primary);
        }

        .module-tag input {
            margin: 0;
        }

        /* Analytics Cards */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .analytics-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border-left: 4px solid var(--primary);
        }

        .analytics-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .analytics-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 8px 0;
            color: var(--primary);
        }

        .analytics-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            height: 12px;
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 6px;
            transition: width 0.7s cubic-bezier(0.22, 0.61, 0.36, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Timeline Styles */
        .timeline {
            margin-top: 15px;
            max-height: 650px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 12px;
            background: var(--bg-secondary);
        }

        .timeline-period {
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
        }

        .timeline-period:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .period-header {
            background: var(--bg-tertiary);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .period-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .period-actions {
            display: flex;
            gap: 5px;
        }

        .period-modules {
            padding: 10px 15px;
            background: var(--bg-card);
        }

        .compact-module-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
        }

        .compact-module-item {
            padding: 8px 10px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid var(--info);
            position: relative;
        }

        .compact-module-item:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .compact-module-item.option {
            border-left-color: var(--primary);
        }

        .compact-module-item.research {
            border-left-color: var(--warning);
        }

        .compact-module-item.synoptic {
            border-left-color: var(--success);
        }

        .compact-module-item.taken {
            background: rgba(40, 167, 69, 0.1);
            font-weight: 600;
        }

        .compact-module-item.break {
            background: rgba(255, 193, 7, 0.1);
            border-left-color: var(--warning);
        }

        .compact-module-item.locked {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: var(--danger);
            cursor: not-allowed;
        }

        .small-btn {
            padding: 5px 8px;
            font-size: 0.75rem;
            border-radius: 5px;
        }

        /* Phase Indicator - Compact Style */
        .phase-indicator {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 0 0 15px 0;
        }

        .phase {
            padding: 10px 8px;
            text-align: center;
            border-radius: var(--border-radius);
            background: var(--bg-card);
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .phase::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border);
        }

        .phase.active {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(213, 0, 50, 0.3);
        }

        .phase.active::before {
            background: var(--primary-light);
        }

        .phase.completed {
            background: var(--success);
            color: white;
        }

        .phase.completed::before {
            background: var(--success);
        }

        .phase-title {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }

        .phase-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        /* Impact Section */
        .impact-section {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--accent);
        }

        .impact-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .impact-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Alert Styles */
        .alert {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 15px 18px;
            background: var(--bg-card);
            border-left: 4px solid var(--success);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            z-index: 1000;
            max-width: 320px;
            animation: slideIn 0.4s cubic-bezier(0.22, 0.61, 0.36, 1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.warning {
            border-left-color: var(--warning);
        }

        .alert.error {
            border-left-color: var(--danger);
        }

        .alert.info {
            border-left-color: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .close-alert {
            cursor: pointer;
            font-weight: 700;
            opacity: 0.7;
            transition: var(--transition);
            margin-left: auto;
            font-size: 0.9rem;
        }

        .close-alert:hover {
            opacity: 1;
        }

        /* Compact Analytics */
        .compact-analytics {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .compact-analytics-card {
            padding: 15px;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border-top: 4px solid var(--secondary);
        }

        .compact-analytics-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .compact-analytics-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 6px 0;
            color: var(--secondary);
        }

        .compact-analytics-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Notification Badge */
        .notification-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-left: 6px;
        }

        /* Module Info Popup */
        .module-info-popup {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: var(--shadow-hover);
            z-index: 100;
            width: 250px;
            font-size: 0.75rem;
            display: none;
            color: var(--text-primary);
        }

        .compact-module-item:hover .module-info-popup {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Export Options */
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-options .btn {
            flex: 1;
        }

        /* Conflict Warning */
        .conflict-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--warning);
            border-radius: var(--border-radius);
            padding: 12px;
            margin: 12px 0;
            font-size: 0.85rem;
            border-left: 4px solid var(--warning);
        }

        /* Focus states for accessibility */
        button:focus, input:focus, select:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div>
                        <h1>KCL PNOMH Graduation Planner</h1>
                        <div class="subtitle">Plan your part-time Psychology & Neuroscience of Mental Health degree</div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="savePlan()">
                        <i class="fas fa-save"></i> Save Plan
                    </button>
                    <button class="btn btn-outline" onclick="loadPlan()">
                        <i class="fas fa-folder-open"></i> Load Plan
                    </button>
                    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Phase Indicator - Now above the main content -->
        <div class="phase-indicator">
            <div class="phase completed">
                <div class="phase-title">Foundation</div>
                <div class="phase-subtitle">4 Modules</div>
            </div>
            <div class="phase active">
                <div class="phase-title">Options</div>
                <div class="phase-subtitle">Choose 4</div>
            </div>
            <div class="phase">
                <div class="phase-title">Research</div>
                <div class="phase-subtitle">2 Modules</div>
            </div>
            <div class="phase">
                <div class="phase-title">Synoptic</div>
                <div class="phase-subtitle">1 Project (4 months)</div>
            </div>
        </div>

        <div class="main-content">
            <!-- Left Column: Study Timeline & Program Setup -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-calendar-alt"></i>
                            Study Timeline
                        </div>
                        <div>
                            <span id="notificationCount" class="notification-badge" style="display: none;">0</span>
                            <button class="btn btn-outline small-btn" onclick="showNotifications()">
                                <i class="fas fa-bell"></i> Notifications
                            </button>
                        </div>
                    </div>
                    <div id="phaseInfo"></div>
                    <div id="conflictWarning" class="conflict-warning" style="display: none;"></div>
                    <div id="tl" class="timeline"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-cog"></i>
                            Program Setup
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="award">Select Award</label>
                        <select class="form-control" id="award">
                            <option value="PGCert">PG Cert (60 credits)</option>
                            <option value="PGDip">PG Dip (120 credits)</option>
                            <option value="MSc" selected>MSc (180 credits)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="start">Start Date</label>
                        <select class="form-control" id="start"></select>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="quickFill()">
                            <i class="fas fa-bolt"></i> Quick Fill
                        </button>
                        <button class="btn btn-outline" onclick="resetPlan()">
                            <i class="fas fa-redo"></i> Reset Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Option Modules & Graduation Plan -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-tasks"></i>
                            Select Option Modules
                        </div>
                        <div class="card-subtitle">Choose 4 of 10 available</div>
                    </div>
                    <div class="module-tags" id="opts"></div>
                    <div id="wbox" class="alert warning" style="display: none; position: static; margin-top: 12px;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-graduation-cap"></i>
                            Graduation Plan
                        </div>
                    </div>
                    <div class="compact-analytics">
                        <div class="compact-analytics-card">
                            <div class="compact-analytics-label">Estimated Graduation</div>
                            <div class="compact-analytics-value" id="vGrad">—</div>
                            <div class="compact-analytics-label">with current plan</div>
                        </div>
                        <div class="compact-analytics-card">
                            <div class="compact-analytics-label">Study Duration</div>
                            <div class="compact-analytics-value" id="vDur">—</div>
                            <div class="compact-analytics-label">months</div>
                        </div>
                        <div class="compact-analytics-card">
                            <div class="compact-analytics-label">Progress</div>
                            <div class="compact-analytics-value" id="vPct">0%</div>
                            <div class="compact-analytics-label">completed</div>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span>Start</span>
                            <span id="progText">0% Complete</span>
                            <span>Graduation</span>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div class="export-options">
                        <button class="btn btn-outline" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button class="btn btn-outline" onclick="exportToCalendar()">
                            <i class="fas fa-calendar-plus"></i> Export Calendar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle Functionality
        const themeToggle = document.getElementById('themeToggle');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        
        // Check for saved theme or prefered scheme
        const currentTheme = localStorage.getItem('theme') || 
                           (prefersDarkScheme.matches ? 'dark' : 'light');
        
        // Set the theme
        document.documentElement.setAttribute('data-theme', currentTheme);
        
        // Update button icon
        updateThemeIcon(currentTheme);
        
        // Toggle theme function
        themeToggle.addEventListener('click', function() {
            let theme = document.documentElement.getAttribute('data-theme');
            let newTheme = theme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            updateThemeIcon(newTheme);
        });
        
        function updateThemeIcon(theme) {
            const icon = themeToggle.querySelector('i');
            if (theme === 'dark') {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
        }

        // Enhanced module definitions with additional information
        const MODULES = {
            foundation: [
                { name: 'Biological Foundations of Mental Health', credits: 15, description: 'Core biological principles underlying mental health disorders' },
                { name: 'Techniques in Neuroscience', credits: 15, description: 'Methodologies and techniques used in neuroscience research' },
                { name: 'Psychological Foundations of Mental Health', credits: 15, description: 'Psychological theories and models of mental health' },
                { name: 'Mental Health in the Community', credits: 15, description: 'Community-based approaches to mental health care' }
            ],
            options: [
                { name: 'Mindfulness: Neuroscience & Application', credits: 15, description: 'Neuroscientific basis and practical applications of mindfulness' },
                { name: 'Global Mental Health', credits: 15, description: 'Mental health challenges and solutions in global context' },
                { name: 'Psychology & Neuroscience of Addiction', credits: 15, description: 'Biological and psychological aspects of addictive behaviors' },
                { name: 'Child & Adolescent Mental Health', credits: 15, description: 'Developmental perspectives on mental health in young people' },
                { name: 'Social, Genetic & Environmental Basis of Mental Health', credits: 15, description: 'Interplay between social, genetic and environmental factors' },
                { name: 'Neuroscience in Society', credits: 15, description: 'Ethical and societal implications of neuroscience research' },
                { name: 'Psychology & Neuroscience of Affective Disorders', credits: 15, description: 'Mood disorders from psychological and neuroscientific perspectives' },
                { name: 'Psychology & Neuroscience of Psychosis', credits: 15, description: 'Understanding psychotic disorders through multiple lenses' },
                { name: 'Neuroimaging in Mental Health', credits: 15, description: 'Application of neuroimaging techniques in mental health research' },
                { name: 'Pharmacotherapies in Mental Health', credits: 15, description: 'Pharmacological treatments for mental health conditions' }
            ],
            research: [
                { name: 'Research Skills: From Reviewing & Critical Analysis to Research Ethics', credits: 15, description: 'Fundamental research skills and ethical considerations' },
                { name: 'Research Skills: From Methods & Procedures to Analysis & Reporting', credits: 15, description: 'Advanced research methodologies and analytical techniques' }
            ],
            synoptic: [
                { name: 'Independent Synoptic Project', credits: 60, description: 'Comprehensive research project integrating knowledge from all modules' }
            ]
        };

        // Extract module names for compatibility
        const F = MODULES.foundation.map(m => m.name);
        const O = MODULES.options.map(m => m.name);
        const R = MODULES.research.map(m => m.name);
        const S = MODULES.synoptic.map(m => m.name);

        // Extended schedule data - Now goes all the way to 2027
        const SCH = {
            "2023-01": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2023-03": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2023-05": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2023-06": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2023-09": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2023-10": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2024-01": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2024-03": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2024-05": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2024-06": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2024-09": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2024-10": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2025-01": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2025-03": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2025-05": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2025-06": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2025-09": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2025-10": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2026-01": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2026-03": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2026-05": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2026-06": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2026-09": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2026-10": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2027-01": ["Techniques in Neuroscience", "Psychology & Neuroscience of Affective Disorders", "Neuroscience in Society", "Social, Genetic & Environmental Basis of Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2027-03": ["Psychological Foundations of Mental Health", "Psychology & Neuroscience of Psychosis", "Neuroimaging in Mental Health", "Pharmacotherapies in Mental Health", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"],
            "2027-05": ["Mental Health in the Community", "Child & Adolescent Mental Health", "Global Mental Health", "Research Skills: From Reviewing & Critical Analysis to Research Ethics", "Independent Synoptic Project"],
            "2027-06": ["Biological Foundations of Mental Health", "Psychology & Neuroscience of Addiction", "Mindfulness: Neuroscience & Application", "Research Skills: From Methods & Procedures to Analysis & Reporting", "Independent Synoptic Project"]
        };
        
        const REQ = {
            PGCert: { f: 4, o: 0, r: 0, s: 0 },
            PGDip: { f: 4, o: 4, r: 0, s: 0 },
            MSc: { f: 4, o: 4, r: 2, s: 1 }
        };
        
        const keys = Object.keys(SCH).sort();
        const brks = new Set();
        const taken = new Map();
        
        let isInitialized = false;
        
        // Initialize the planner
        function init() {
            if (isInitialized) return;
            isInitialized = true;
        
            // Initialize start date dropdown
            const startS = document.getElementById('start');
            if (!startS) return;
        
            startS.innerHTML = '';
            keys.forEach(k => {
                const [y, m] = k.split('-').map(Number);
                const d = new Date(y, m - 1, 1);
                const o = document.createElement('option');
                o.value = k;
                o.textContent = d.toLocaleString('en-GB', { month: 'short', year: 'numeric' });
                startS.appendChild(o);
            });
        
            startS.value = '2023-09';
            startS.addEventListener('change', gen);
            document.getElementById('award').addEventListener('change', gen);
        
            // Initialize option checkboxes with enhanced info
            const optsW = document.getElementById('opts');
            if (!optsW) return;
        
            optsW.innerHTML = '';
            MODULES.options.forEach(module => {
                const id = 'o' + module.name.replace(/[^a-z0-9]/gi, '');
                const l = document.createElement('label');
                l.className = 'module-tag';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = id;
                checkbox.dataset.name = module.name;
                checkbox.addEventListener('change', function() {
                    const checkedBoxes = document.querySelectorAll('#opts input:checked');
                    if (checkedBoxes.length > 4) {
                        this.checked = false;
                        showAlert('You can only select 4 option modules', 'warning');
                        return;
                    }
        
                    // If deselecting, remove any taken modules that are no longer valid
                    if (!this.checked) {
                        const deselectedModule = this.dataset.name;
                        const toRemove = [];
                        taken.forEach((module, period) => {
                            if (module === deselectedModule) {
                                toRemove.push(period);
                            }
                        });
                        toRemove.forEach(period => taken.delete(period));
                    }
        
                    updateChipSelection();
                    gen();
                });
                l.appendChild(checkbox);
                
                const textSpan = document.createElement('span');
                textSpan.textContent = module.name;
                l.appendChild(textSpan);
                
                // Add info popup
                const infoPopup = document.createElement('div');
                infoPopup.className = 'module-info-popup';
                infoPopup.innerHTML = `
                    <strong>${module.name}</strong><br>
                    <em>${module.credits} credits</em><br>
                    ${module.description}
                `;
                l.appendChild(infoPopup);
                
                optsW.appendChild(l);
            });
            
            // Just generate initial view without asking to load saved plan
            gen();
        }
        
        // Update chip selection styling
        function updateChipSelection() {
            const chips = document.querySelectorAll('#opts .module-tag');
            chips.forEach(chip => {
                const checkbox = chip.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
        }
        
        // Get selected options
        function getOpts() {
            return [...document.querySelectorAll('#opts input:checked')].map(c => c.dataset.name).slice(0, 4);
        }
        
        // Add years to a date key
        function addY(k, y) {
            const [yr, m] = k.split('-').map(Number);
            return `${yr + y}-${String(m).padStart(2, '0')}`;
        }
        
        // Format date key to readable format
        function fmtD(k) {
            const [y, m] = k.split('-').map(Number);
            const date = new Date(y, m - 1, 1);
            return date.toLocaleString('en-GB', { month: 'short', year: 'numeric' });
        }
        
        // Get module type
        function getType(m) {
            if (F.includes(m)) return 'foundation';
            if (O.includes(m)) return 'option';
            if (R.includes(m)) return 'research';
            if (S.includes(m)) return 'synoptic';
            return 'unknown';
        }
        
        // Get count of taken modules by type
        function getTkn() {
            let t = { f: 0, o: 0, r: 0, s: 0 };
            taken.forEach(v => {
                const ty = getType(v);
                if (ty === 'foundation') t.f++;
                else if (ty === 'option') t.o++;
                else if (ty === 'research') t.r++;
                else if (ty === 'synoptic') t.s++;
            });
            return t;
        }
        
        // Calculate actual completed modules (not just count)
        function getActualCompletion() {
            const completedFoundations = F.filter(f => [...taken.values()].includes(f)).length;
            const cho = getOpts();
            const completedOptions = cho.filter(o => [...taken.values()].includes(o)).length;
            const completedResearch = R.filter(r => [...taken.values()].includes(r)).length;
            const completedSynoptic = S.filter(s => [...taken.values()].includes(s)).length;
            
            return {
                foundations: completedFoundations,
                options: completedOptions,
                research: completedResearch,
                synoptic: completedSynoptic
            };
        }
        
        // Update phase indicator
        function updatePhaseIndicator(actualCompletion, rq) {
            const phases = document.querySelectorAll('.phase');
            phases[0].className = actualCompletion.foundations >= rq.f ? 'phase completed' : 'phase active';
            phases[1].className = actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o ? 'phase completed' : 
                             actualCompletion.foundations >= rq.f ? 'phase active' : 'phase';
            phases[2].className = actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r ? 'phase completed' : 
                             actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o ? 'phase active' : 'phase';
            phases[3].className = actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r && actualCompletion.synoptic >= rq.s ? 'phase completed' : 
                             actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r ? 'phase active' : 'phase';
        }
        
        // Generate the main view
        function gen() {
            const aw = document.getElementById('award').value || 'MSc';
            const st = document.getElementById('start').value || '2023-09';
            const rq = { ...REQ[aw] };
            const cho = getOpts();
            const tkn = getTkn();
            const actualCompletion = getActualCompletion();
            const wb = document.getElementById('wbox');
        
            if (wb) {
                if (rq.o > 0 && cho.length < 4) {
                    wb.textContent = `Please select 4 option modules (required for ${aw})`;
                    wb.style.display = 'block';
                } else {
                    wb.style.display = 'none';
                }
            }
        
            const hs = addY(st, 8);
            const itk = keys.filter(k => k >= st && k <= hs);
            render(itk, st, rq, tkn, cho, actualCompletion);
            vis(itk, tkn, rq, st, actualCompletion);
            
            // Update conflict warnings
            updateConflictWarnings();
            
            // Update notifications
            checkNotifications();
        }
        
        // Update conflict warnings
        function updateConflictWarnings() {
            const conflicts = detectConflicts();
            const warningEl = document.getElementById('conflictWarning');
            
            if (conflicts.length > 0) {
                warningEl.innerHTML = `
                    <strong>Planning Conflicts Detected:</strong>
                    <ul>
                        ${conflicts.map(c => `<li>${c}</li>`).join('')}
                    </ul>
                `;
                warningEl.style.display = 'block';
            } else {
                warningEl.style.display = 'none';
            }
        }
        
        // Render the timeline - FIXED: Research modules only appear in future intakes after prerequisites
        function render(itk, st, rq, tkn, cho, actualCompletion) {
            const el = document.getElementById('tl');
            if (!el) return;

            el.innerHTML = '';
            
            // Update phase indicator
            updatePhaseIndicator(actualCompletion, rq);
            
            const pi = document.getElementById('phaseInfo');
            if (pi) {
                if (actualCompletion.foundations < rq.f) {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--info); margin-bottom: 8px;">
                        <strong>Current Phase:</strong> Complete ${rq.f - actualCompletion.foundations} more foundation modules
                    </div>`;
                } else if (actualCompletion.foundations >= rq.f && actualCompletion.options < rq.o) {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--primary); margin-bottom: 8px;">
                        <strong>Current Phase:</strong> Complete ${rq.o - actualCompletion.options} more option modules
                    </div>`;
                } else if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research < rq.r) {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--warning); margin-bottom: 8px;">
                        <strong>Current Phase:</strong> Complete ${rq.r - actualCompletion.research} more research modules
                    </div>`;
                } else if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r && actualCompletion.synoptic < rq.s) {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--success); margin-bottom: 8px;">
                        <strong>Current Phase:</strong> Complete the Synoptic Project (spans 4 months)
                    </div>`;
                } else {
                    pi.innerHTML = `<div style="font-size: 0.85rem; color: var(--success); margin-bottom: 8px;">
                        <strong>All requirements complete!</strong>
                    </div>`;
                }
            }

            itk.forEach(k => {
                const period = document.createElement('div');
                period.className = 'timeline-period';
                
                const tkMod = taken.get(k);
                const isBreak = brks.has(k);
                
                const header = document.createElement('div');
                header.className = 'period-header';
                
                const title = document.createElement('div');
                title.className = 'period-title';
                title.textContent = fmtD(k);
                header.appendChild(title);
                
                const actions = document.createElement('div');
                actions.className = 'period-actions';
                
                if (isBreak) {
                    actions.innerHTML = `<button class="btn btn-outline small-btn" onclick="brks.delete('${k}'); gen();">Remove Break</button>`;
                } else if (tkMod) {
                    actions.innerHTML = `
                        <button class="btn btn-outline small-btn" onclick="taken.delete('${k}'); gen();">Remove</button>
                        <button class="btn btn-outline small-btn" onclick="brks.add('${k}'); taken.delete('${k}'); gen();">Break</button>
                    `;
                } else {
                    actions.innerHTML = `<button class="btn btn-outline small-btn" onclick="brks.add('${k}'); gen();">Set Break</button>`;
                }
                
                header.appendChild(actions);
                period.appendChild(header);
                
                const modules = document.createElement('div');
                modules.className = 'period-modules';
                
                if (!isBreak && !tkMod) {
                    const mds = SCH[k] || [];
                    let availableModules = [];
                    
                    // FIXED LOGIC: Research modules only appear in future intakes after prerequisites
                    const completedModules = [...taken.values()];
                    
                    const foundationsDone = actualCompletion.foundations >= rq.f;
                    const optionsDone = actualCompletion.options >= rq.o;
                    const researchDone = actualCompletion.research >= rq.r;
                    
                    // Filter out completed modules first
                    const allAvailable = mds.filter(m => !completedModules.includes(m));
                    
                    // Check if this is a future intake (not in the past)
                    const currentDate = new Date();
                    const [periodYear, periodMonth] = k.split('-').map(Number);
                    const periodDate = new Date(periodYear, periodMonth - 1, 1);
                    const isFutureIntake = periodDate >= currentDate;
                    
                    // STRICTER PHASE PROGRESSION: Only show current phase modules
                    if (!foundationsDone) {
                        // Only show foundation modules (hide options, research, synoptic)
                        availableModules = allAvailable.filter(m => F.includes(m));
                    } else if (!optionsDone) {
                        // Only show selected option modules (hide foundation, research, synoptic)
                        availableModules = allAvailable.filter(m => cho.includes(m) && O.includes(m));
                    } else if (!researchDone) {
                        // Only show research modules in FUTURE intakes (hide foundation, options, synoptic)
                        if (isFutureIntake) {
                            availableModules = allAvailable.filter(m => R.includes(m));
                        } else {
                            availableModules = []; // Don't show research modules in past intakes
                        }
                    } else if (actualCompletion.synoptic < rq.s) {
                        // Only show synoptic project in FUTURE intakes (hide all others)
                        if (isFutureIntake) {
                            availableModules = allAvailable.filter(m => S.includes(m));
                        } else {
                            availableModules = []; // Don't show synoptic in past intakes
                        }
                    } else {
                        // All requirements complete
                        availableModules = [];
                    }
                    
                    if (availableModules.length > 0) {
                        const moduleList = document.createElement('div');
                        moduleList.className = 'compact-module-list';
                        
                        availableModules.forEach(m => {
                            const moduleItem = document.createElement('div');
                            const type = getType(m);
                            moduleItem.className = `compact-module-item ${type}`;
                            moduleItem.textContent = m;
                            moduleItem.title = m;
                            
                            // Add enhanced module info
                            let moduleData;
                            if (type === 'foundation') moduleData = MODULES.foundation.find(mod => mod.name === m);
                            else if (type === 'option') moduleData = MODULES.options.find(mod => mod.name === m);
                            else if (type === 'research') moduleData = MODULES.research.find(mod => mod.name === m);
                            else if (type === 'synoptic') moduleData = MODULES.synoptic.find(mod => mod.name === m);
                            
                            if (moduleData) {
                                const infoPopup = document.createElement('div');
                                infoPopup.className = 'module-info-popup';
                                infoPopup.innerHTML = `
                                    <strong>${moduleData.name}</strong><br>
                                    <em>${moduleData.credits} credits</em><br>
                                    ${moduleData.description}
                                `;
                                moduleItem.appendChild(infoPopup);
                            }
                            
                            moduleItem.addEventListener('click', () => {
                                // Special handling for Synoptic Project (spans 2 periods = 4 months)
                                if (type === 'synoptic') {
                                    taken.set(k, m);
                                    const currentIndex = keys.indexOf(k);
                                    // Add the next period for synoptic project
                                    if (currentIndex < keys.length - 1) {
                                        taken.set(keys[currentIndex + 1], m);
                                    }
                                } else {
                                    taken.set(k, m);
                                }
                                gen();
                            });
                            moduleList.appendChild(moduleItem);
                        });
                        
                        modules.appendChild(moduleList);
                    } else {
                        let message = 'No available modules';
                        if (actualCompletion.foundations < rq.f) {
                            message = `Complete ${rq.f - actualCompletion.foundations} more foundation modules first`;
                        } else if (actualCompletion.foundations >= rq.f && actualCompletion.options < rq.o) {
                            message = `Complete ${rq.o - actualCompletion.options} more option modules first`;
                        } else if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r && actualCompletion.synoptic >= rq.s) {
                            message = 'All requirements completed!';
                        } else if (!isFutureIntake && (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o)) {
                            message = 'Research modules only available in future intakes';
                        }
                        
                        modules.innerHTML = `<div style="font-size: 0.8rem; color: var(--text-muted); text-align: center; padding: 8px;">${message}</div>`;
                    }
                } else if (tkMod) {
                    const moduleItem = document.createElement('div');
                    const type = getType(tkMod);
                    moduleItem.className = `compact-module-item ${type} taken`;
                    moduleItem.textContent = tkMod;
                    moduleItem.title = tkMod;
                    modules.appendChild(moduleItem);
                } else if (isBreak) {
                    modules.innerHTML = `<div style="font-size: 0.8rem; color: var(--warning); text-align: center; padding: 8px;">Study Break Period</div>`;
                }
                
                period.appendChild(modules);
                el.appendChild(period);
            });
        }
        
        // Update visualization
        function vis(itk, tkn, rq, st, actualCompletion) {
            const lastK = [...taken.keys()].sort().pop();
        
            const vDur = document.getElementById('vDur');
            if (vDur) {
                if (lastK) {
                    const brkCount = brks.size;
                    const totalPeriods = keys.filter(k => k >= st && k <= lastK).length;
                    const studyPeriods = Math.max(0, totalPeriods - brkCount);
                    const durMonths = studyPeriods * 2;
                    vDur.textContent = durMonths;
                } else {
                    vDur.textContent = '—';
                }
            }
        
            const tot = rq.f + rq.o + rq.r + rq.s;
            const cur = actualCompletion.foundations + actualCompletion.options + actualCompletion.research + actualCompletion.synoptic;
            const pct = tot > 0 ? Math.round((cur / tot) * 100) : 0;
        
            const vPct = document.getElementById('vPct');
            if (vPct) {
                vPct.textContent = pct + '%';
            }
        
            const progF = document.getElementById('progFill');
            const progText = document.getElementById('progText');
            if (progF && progText) {
                progF.style.width = pct + '%';
                progText.textContent = pct + '% Complete';
            }
        
            const vGrad = document.getElementById('vGrad');
            if (vGrad) {
                if (lastK) {
                    // For synoptic project, graduation is 2 months after the last period
                    const [y, m] = lastK.split('-').map(Number);
                    let gradMonth = m + 2;
                    let gradYear = y;
                    if (gradMonth > 12) {
                        gradMonth -= 12;
                        gradYear += 1;
                    }
                    vGrad.textContent = new Date(gradYear, gradMonth - 1, 1).toLocaleString('en-GB', { month: 'short', year: 'numeric' });
                } else {
                    vGrad.textContent = '—';
                }
            }
        }
        
        // Quick fill function
        function quickFill() {
            const aw = document.getElementById('award').value || 'MSc';
            const st = document.getElementById('start').value || '2023-09';
            const rq = { ...REQ[aw] };
            const tkn = getTkn();
            const cho = getOpts();
        
            if (rq.o > 0 && cho.length < 4) {
                showAlert('Please select 4 option modules first', 'warning');
                return;
            }
            
            const actualCompletion = getActualCompletion();
            if (actualCompletion.foundations >= rq.f && actualCompletion.options >= rq.o && actualCompletion.research >= rq.r && actualCompletion.synoptic >= rq.s) {
                showAlert('Your plan is already complete!', 'success');
                return;
            }
        
            const beforeCount = taken.size;
            const hs = addY(st, 8);
            const itk = keys.filter(k => k >= st && k <= hs);
            const remF = new Set(F.filter(m => ![...taken.values()].includes(m)));
            const remO = new Set((cho.length >= 4 ? cho : O.slice(0, 4)).filter(m => ![...taken.values()].includes(m)));
            const remR = new Set(R.filter(m => ![...taken.values()].includes(m)));
            
            let curFoundations = actualCompletion.foundations;
            let curOptions = actualCompletion.options;
            let curResearch = actualCompletion.research;
            let curSynoptic = actualCompletion.synoptic;
        
            for (const k of itk) {
                if (curFoundations >= rq.f && curOptions >= rq.o && curResearch >= rq.r && curSynoptic >= rq.s) break;
                if (taken.has(k) || brks.has(k)) continue;
                const mds = SCH[k] || [];
        
                // STRICT PREREQUISITE ENFORCEMENT
                if (curFoundations < rq.f) {
                    const m = mds.find(x => remF.has(x));
                    if (m) {
                        taken.set(k, m);
                        remF.delete(m);
                        curFoundations++;
                        continue;
                    }
                }
                if (curFoundations >= rq.f && curOptions < rq.o) {
                    const m = mds.find(x => remO.has(x));
                    if (m) {
                        taken.set(k, m);
                        remO.delete(m);
                        curOptions++;
                        continue;
                    }
                }
                if (curFoundations >= rq.f && curOptions >= rq.o && curResearch < rq.r) {
                    // Only schedule research modules in future intakes
                    const currentDate = new Date();
                    const [periodYear, periodMonth] = k.split('-').map(Number);
                    const periodDate = new Date(periodYear, periodMonth - 1, 1);
                    const isFutureIntake = periodDate >= currentDate;
                    
                    if (isFutureIntake) {
                        const m = mds.find(x => remR.has(x));
                        if (m) {
                            taken.set(k, m);
                            remR.delete(m);
                            curResearch++;
                            continue;
                        }
                    }
                }
                if (curFoundations >= rq.f && curOptions >= rq.o && curResearch >= rq.r && curSynoptic < rq.s) {
                    // Only schedule synoptic in future intakes
                    const currentDate = new Date();
                    const [periodYear, periodMonth] = k.split('-').map(Number);
                    const periodDate = new Date(periodYear, periodMonth - 1, 1);
                    const isFutureIntake = periodDate >= currentDate;
                    
                    if (isFutureIntake) {
                        const m = mds.find(x => S.includes(x));
                        if (m) {
                            taken.set(k, m);
                            const ni = itk.indexOf(k);
                            // Add next period for synoptic project (4 months total)
                            if (ni >= 0 && ni < itk.length - 1) taken.set(itk[ni + 1], m);
                            curSynoptic++;
                            break;
                        }
                    }
                }
            }
        
            const afterCount = taken.size;
            const added = afterCount - beforeCount;
            gen();
        
            if (added > 0) {
                showAlert(`Added ${added} module${added > 1 ? 's' : ''} to your plan!`, 'success');
            } else {
                showAlert('No suitable modules found to add', 'warning');
            }
        }
        
        // Reset plan
        function resetPlan() {
            if (confirm('Reset everything? This cannot be undone.')) {
                taken.clear();
                brks.clear();
                const checkboxes = document.querySelectorAll('#opts input');
                checkboxes.forEach(i => i.checked = false);
                updateChipSelection();
                gen();
                showAlert('Plan reset successfully', 'success');
            }
        }
        
        // Show alert
        function showAlert(msg, type = 'success') {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
        
            const al = document.createElement('div');
            al.className = `alert ${type}`;
        
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close-alert';
            closeBtn.textContent = '×';
            closeBtn.addEventListener('click', function() {
                al.remove();
            });
        
            const msgDiv = document.createElement('div');
            msgDiv.style.paddingRight = '1.5rem';
            msgDiv.textContent = msg;
        
            al.appendChild(closeBtn);
            al.appendChild(msgDiv);
            document.body.appendChild(al);
        
            setTimeout(() => {
                if (al.parentNode) {
                    al.remove();
                }
            }, 4000);
        }

        // Data persistence functions
        function savePlan() {
            const plan = {
                award: document.getElementById('award').value,
                start: document.getElementById('start').value,
                selectedOptions: getOpts(),
                taken: Array.from(taken.entries()),
                breaks: Array.from(brks),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('kclGraduationPlan', JSON.stringify(plan));
            showAlert('Plan saved successfully!', 'success');
        }
        
        function loadPlan() {
            const saved = localStorage.getItem('kclGraduationPlan');
            if (!saved) {
                showAlert('No saved plan found', 'warning');
                return;
            }
            
            try {
                const plan = JSON.parse(saved);
                
                // Restore basic settings
                document.getElementById('award').value = plan.award;
                document.getElementById('start').value = plan.start;
                
                // Restore option selections
                const checkboxes = document.querySelectorAll('#opts input');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = plan.selectedOptions.includes(checkbox.dataset.name);
                });
                updateChipSelection();
                
                // Restore taken modules and breaks
                taken.clear();
                brks.clear();
                
                plan.taken.forEach(([period, module]) => {
                    taken.set(period, module);
                });
                
                plan.breaks.forEach(breakPeriod => {
                    brks.add(breakPeriod);
                });
                
                gen();
                showAlert('Plan loaded successfully!', 'success');
            } catch (e) {
                showAlert('Error loading saved plan', 'error');
                console.error(e);
            }
        }
        
        // Export functions
        function exportToPDF() {
            showAlert('PDF export would be generated here', 'info');
        }
        
        function exportToCalendar() {
            showAlert('Calendar export would be generated here', 'info');
        }
        
        // Conflict detection
        function detectConflicts() {
            const conflicts = [];
            const aw = document.getElementById('award').value || 'MSc';
            const rq = { ...REQ[aw] };
            const actualCompletion = getActualCompletion();
            
            // Check if selected options match taken options
            const selectedOptions = getOpts();
            const takenOptions = [...taken.values()].filter(m => O.includes(m));
            
            takenOptions.forEach(takenOpt => {
                if (!selectedOptions.includes(takenOpt)) {
                    conflicts.push(`Module "${takenOpt}" is scheduled but not selected in your options`);
                }
            });
            
            // Check prerequisite violations
            const takenKeys = [...taken.keys()].sort();
            let foundationCompleted = false;
            let optionsCompleted = false;
            let researchCompleted = false;
            
            takenKeys.forEach(period => {
                const module = taken.get(period);
                const type = getType(module);
                
                if (type === 'option' && !foundationCompleted) {
                    conflicts.push(`Option module "${module}" scheduled before completing all foundation modules`);
                }
                
                if (type === 'research' && (!foundationCompleted || !optionsCompleted)) {
                    conflicts.push(`Research module "${module}" scheduled before completing foundation and option modules`);
                }
                
                if (type === 'synoptic' && (!foundationCompleted || !optionsCompleted || !researchCompleted)) {
                    conflicts.push(`Synoptic project scheduled before completing all prerequisite modules`);
                }
                
                // Update completion status
                if (type === 'foundation' && actualCompletion.foundations >= rq.f) {
                    foundationCompleted = true;
                }
                if (type === 'option' && actualCompletion.options >= rq.o) {
                    optionsCompleted = true;
                }
                if (type === 'research' && actualCompletion.research >= rq.r) {
                    researchCompleted = true;
                }
            });
            
            return conflicts;
        }
        
        // Notification system
        function checkNotifications() {
            const notifications = [];
            const aw = document.getElementById('award').value || 'MSc';
            const st = document.getElementById('start').value || '2023-09';
            const rq = { ...REQ[aw] };
            const actualCompletion = getActualCompletion();
            
            // Check for upcoming registration deadlines
            const currentDate = new Date();
            const upcomingPeriods = keys.filter(k => {
                const [y, m] = k.split('-').map(Number);
                const periodDate = new Date(y, m - 1, 1);
                const timeDiff = periodDate - currentDate;
                const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
                return daysDiff > 0 && daysDiff < 60; // Within next 60 days
            });
            
            if (upcomingPeriods.length > 0) {
                notifications.push(`Registration deadline approaching for ${fmtD(upcomingPeriods[0])}`);
            }
            
            // Check module completion status
            if (actualCompletion.foundations < rq.f) {
                notifications.push(`Complete ${rq.f - actualCompletion.foundations} more foundation modules`);
            } else if (actualCompletion.options < rq.o) {
                notifications.push(`Complete ${rq.o - actualCompletion.options} more option modules`);
            } else if (actualCompletion.research < rq.r) {
                notifications.push(`Complete ${rq.r - actualCompletion.research} more research modules`);
            } else if (actualCompletion.synoptic < rq.s) {
                notifications.push(`Complete the synoptic project`);
            }
            
            // Update notification badge
            const badge = document.getElementById('notificationCount');
            if (badge) {
                if (notifications.length > 0) {
                    badge.textContent = notifications.length;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            return notifications;
        }
        
        function showNotifications() {
            const notifications = checkNotifications();
            if (notifications.length === 0) {
                showAlert('No notifications at this time', 'info');
            } else {
                const notificationText = notifications.map((n, i) => `${i+1}. ${n}`).join('\n');
                showAlert(`Notifications:\n\n${notificationText}`, 'info');
            }
        }
        
        // Expose functions to global scope
        window.quickFill = quickFill;
        window.resetPlan = resetPlan;
        window.savePlan = savePlan;
        window.loadPlan = loadPlan;
        window.exportToPDF = exportToPDF;
        window.exportToCalendar = exportToCalendar;
        window.showNotifications = showNotifications;
        
        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
