<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KCL PNOMH Graduation Planner ‚Äî Excellence Edition</title>

<!-- Tailwind via CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: { kcl: { red: '#d50032' } },
        boxShadow: { soft: '0 6px 24px rgba(0,0,0,.08)' }
      }
    }
  }
</script>

<style>
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
  .card.dark { background:#0b1220; border-color:#1f2937; box-shadow:0 2px 8px rgba(0,0,0,.3); }
  .chip { border:1px solid #e5e7eb; border-radius:9999px; padding:.35rem .7rem; font-size:.75rem; cursor:pointer; user-select:none; transition:all .15s ease; background:#f8fafc; }
  .chip:hover { background:#f1f5f9; }
  .chip.on { background:#ede9fe; border-color:#c4b5fd; color:#5b21b6; }
  .kbd { border:1px solid #e5e7eb; background:#f8fafc; border-radius:6px; padding:.15rem .35rem; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,'Liberation Mono','Courier New', monospace; font-size:.75rem; }
  .toast { animation: toastIn .18s ease; }
  @keyframes toastIn { from { transform: translateY(-6px); opacity:0 } to { transform:translateY(0); opacity:1 } }
  .term-card { transition:border-color .15s ease, background .15s ease; }
  .term-card:hover { border-color:#94a3b8; }
  .grad-pulse { animation: pulse 1.2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:.95} 50%{opacity:.65} }

  /* Dark mode tweaks */
  .dark .card { background:#0b1220; border-color:#1f2937; }
  .dark .chip { background:#0f172a; border-color:#1f2937; color:#e5e7eb; }
  .dark .chip:hover { background:#111827; }
  .dark .chip.on { background:#312e81; border-color:#4338ca; color:#c7d2fe; }
  .dark .kbd { background:#0f172a; border-color:#1f2937; color:#e5e7eb; }
  .dark .border-slate-200 { border-color:#263043 !important; }
  .dark .bg-slate-50 { background:#0b1220 !important; }
  .dark .bg-white { background:#0b1220 !important; }
</style>
</head>

<body class="bg-gray-50 dark:bg-[#070b14] text-slate-900 dark:text-slate-100 min-h-full flex flex-col">

<!-- Header (scrolls away naturally) -->
<header class="bg-kcl-red text-white">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
    <div>
      <h1 class="text-xl font-bold">King's College London ‚Äî PNOMH Graduation Planner</h1>
      <p class="opacity-90 text-sm">One module at a time ¬∑ Foundations ‚Üí Options ‚Üí Research ‚Üí Synoptic</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="darkToggle" class="px-3 py-2 rounded-md bg-white/15 hover:bg-white/25 text-white text-sm font-semibold">üåô Dark</button>
      <a id="downloadBtn" class="px-3 py-2 rounded-md bg-white/15 hover:bg-white/25 text-white text-sm font-semibold cursor-pointer">‚¨áÔ∏è Download Plan</a>
    </div>
  </div>
</header>

<!-- Main (Study Plan prioritized on the left) -->
<main class="max-w-6xl mx-auto px-4 py-4 grid md:grid-cols-3 gap-4 w-full">

  <!-- LEFT COLUMN: Study Plan first, then Phase & Options -->
  <section class="md:col-span-2 space-y-4">
    <!-- STUDY PLAN (Top Priority) -->
    <div class="card p-0 overflow-hidden">
      <div class="sticky top-0 z-10 px-4 py-3 border-b bg-white/90 backdrop-blur dark:bg-[#0b1220]/90">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold">Study Plan</h3>
          <div class="flex items-center gap-2">
            <div class="text-xs text-slate-500 dark:text-slate-400">Progress</div>
            <div class="my-0 h-2 w-44 bg-slate-200 rounded-full overflow-hidden">
              <div id="progFill" class="h-2 bg-sky-500 text-[10px] leading-3 transition-all" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="timeline" class="grid gap-2 max-h-[580px] overflow-y-auto p-4 pt-3"></div>

      <div class="px-4 pb-4 -mt-1">
        <div class="text-sm flex flex-wrap gap-2 items-center">
          <strong>Progress:</strong>
          <span class="kbd">Foundation <span id="pf">0</span>/<span id="rf">4</span></span>
          <span class="kbd">Options <span id="po">0</span>/<span id="ro">4</span></span>
          <span class="kbd">Research <span id="pr">0</span>/<span id="rr">2</span></span>
          <span class="kbd">Synoptic <span id="ps">0</span>/<span id="rs">1</span></span>
        </div>

        <div id="gradBox" class="hidden mt-3 p-3 rounded border-2 border-sky-300 bg-sky-50 dark:bg-[#0d2230] dark:border-sky-900 font-semibold text-sm flex items-center gap-2">
          üéì <strong>Estimated Graduation:</strong> <span id="gradTxt" class="text-emerald-700 dark:text-emerald-300 grad-pulse"></span>
        </div>

        <div id="impactBox" class="hidden mt-3 p-3 rounded border bg-slate-50 dark:bg-[#0f172a] dark:border-[#263043] text-sm">
          <strong>Impact:</strong>
          Baseline <span id="impBase" class="font-semibold"></span>
          ‚Üí Your plan <span id="impPlan" class="font-semibold"></span>
          <span id="impDelta" class="ml-2 font-semibold"></span>
          <canvas id="impactChart" width="640" height="120" class="mt-3 w-full rounded-md bg-white dark:bg-[#0b1220] border border-slate-200 dark:border-[#263043]"></canvas>
        </div>
      </div>
    </div>

    <!-- PHASE INFO -->
    <div id="phaseInfo" class="card p-3 text-sm font-semibold"></div>

    <!-- OPTIONS -->
    <div class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-semibold">Choose 4 Options</h3>
        <span class="text-xs text-slate-500 dark:text-slate-400"><span id="optCount">0</span>/4</span>
      </div>
      <div id="opts" class="flex flex-wrap gap-2"></div>
      <div id="warnBox" class="hidden mt-3 text-sm text-amber-700 bg-amber-50 dark:bg-[#3a2b06] dark:text-amber-200 border border-amber-200 dark:border-amber-800 rounded p-2">
        Please select 4 option modules.
      </div>
    </div>
  </section>

  <!-- RIGHT COLUMN: Compact Setup, then Analytics -->
  <aside class="space-y-4">

    <!-- COMPACT SETUP CARD (with Add Breaks) -->
    <div class="card p-3">
      <div class="flex items-start justify-between">
        <h3 class="text-sm font-semibold">Setup</h3>
        <div class="flex items-center gap-2">
          <button id="quickFillBtn" class="px-2.5 py-1.5 rounded-md bg-kcl-red text-white text-xs font-semibold hover:opacity-90">‚ú® Quick Fill</button>
          <button id="resetBtn" class="text-xs px-2.5 py-1.5 rounded-md border border-slate-200 hover:bg-slate-50 dark:hover:bg-[#0f172a]">Reset</button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-2">
        <div>
          <label class="block text-[11px] text-slate-500 dark:text-slate-400 mb-1">Award</label>
          <select id="award" class="w-full border rounded px-2 py-1.5 text-xs bg-white dark:bg-[#0f172a] border-slate-200 dark:border-[#263043]">
            <option value="PGCert">PG Cert (60c)</option>
            <option value="PGDip">PG Dip (120c)</option>
            <option value="MSc" selected>MSc (180c)</option>
          </select>
        </div>
        <div>
          <label class="block text-[11px] text-slate-500 dark:text-slate-400 mb-1">Start</label>
          <select id="start" class="w-full border rounded px-2 py-1.5 text-xs bg-white dark:bg-[#0f172a] border-slate-200 dark:border-[#263043]"></select>
        </div>
      </div>

      <div class="mt-3">
        <div class="text-[11px] font-semibold text-slate-500 dark:text-slate-400 mb-1">Break controls</div>
        <div class="flex flex-wrap gap-2">
          <button id="y1Breaks" class="px-2.5 py-1.5 rounded-md bg-white dark:bg-[#0f172a] border border-slate-200 dark:border-[#263043] text-xs hover:bg-slate-50 dark:hover:bg-[#111827]">+ Breaks Year 1</button>
          <button id="y2Breaks" class="px-2.5 py-1.5 rounded-md bg-white dark:bg-[#0f172a] border border-slate-200 dark:border-[#263043] text-xs hover:bg-slate-50 dark:hover:bg-[#111827]">+ Breaks Year 2</button>
          <button id="clearBreaks" class="px-2.5 py-1.5 rounded-md bg-white dark:bg-[#0f172a] border border-slate-200 dark:border-[#263043] text-xs hover:bg-slate-50 dark:hover:bg-[#111827]">Clear breaks</button>
        </div>
      </div>
    </div>

    <!-- ANALYTICS -->
    <div class="card p-4">
      <h3 class="text-sm font-semibold mb-3">Analytics</h3>
      <div class="grid grid-cols-2 gap-2">
        <div class="rounded-lg text-center text-white p-3" style="background:linear-gradient(135deg,#667eea,#764ba2)">
          <div class="text-xs opacity-90">Duration</div>
          <div id="vDur" class="text-xl font-bold">‚Äî</div>
          <div class="text-xs opacity-90">months</div>
        </div>
        <div class="rounded-lg text-center text-white p-3" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
          <div class="text-xs opacity-90">Breaks</div>
          <div id="vBrk" class="text-xl font-bold">0</div>
        </div>
        <div class="rounded-lg text-center text-white p-3" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
          <div class="text-xs opacity-90">Progress</div>
          <div id="vPct" class="text-xl font-bold">0%</div>
        </div>
        <div class="rounded-lg text-center text-white p-3" style="background:linear-gradient(135deg,#43e97b,#38f9d7)">
          <div class="text-xs opacity-90">Graduation</div>
          <div id="vGrad" class="text-xl font-bold">‚Äî</div>
        </div>
      </div>

      <div class="my-3 h-3 w-full bg-slate-200 rounded-full overflow-hidden">
        <div id="progFillClone" class="h-3 bg-sky-500 text-white text-[10px] leading-3 flex items-center justify-center transition-all" style="width:0%">0%</div>
      </div>

      <div>
        <h4 class="text-sm font-semibold mb-2">Break Impact</h4>
        <div id="breakImpact" class="text-xs text-slate-500 dark:text-slate-400">Select modules to see impact</div>
      </div>
    </div>

  </aside>
</main>

<!-- Toast container -->
<div id="toast" class="fixed top-4 right-4 space-y-2 z-50"></div>

<script>
/* =========================
   Data
   ========================= */
const F=['Biological Foundations of Mental Health','Techniques in Neuroscience','Psychological Foundations of Mental Health','Mental Health in the Community'];
const O=['Mindfulness: Neuroscience & Application','Global Mental Health','Psychology & Neuroscience of Addiction','Child & Adolescent Mental Health','Social, Genetic & Environmental Basis of Mental Health','Neuroscience in Society','Psychology & Neuroscience of Affective Disorders','Psychology & Neuroscience of Psychosis','Neuroimaging in Mental Health','Pharmacotherapies in Mental Health'];
const R=['Research Skills: From Reviewing & Critical Analysis to Research Ethics','Research Skills: From Methods & Procedures to Analysis & Reporting'];
const S=['Independent Synoptic Project'];
const REQ={PGCert:{f:4,o:0,r:0,s:0},PGDip:{f:4,o:4,r:0,s:0},MSc:{f:4,o:4,r:2,s:1}};
const SCH={"2023-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics"],"2023-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2023-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2023-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2023-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2023-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-01":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-03":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-05":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-06":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2024-09":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2024-10":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2025-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2025-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-01":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-03":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-05":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-06":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2026-09":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2026-10":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-01":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-03":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-05":["Mental Health in the Community","Child & Adolescent Mental Health","Global Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-06":["Biological Foundations of Mental Health","Psychology & Neuroscience of Addiction","Mindfulness: Neuroscience & Application","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"],"2027-09":["Techniques in Neuroscience","Psychology & Neuroscience of Affective Disorders","Neuroscience in Society","Social, Genetic & Environmental Basis of Mental Health","Research Skills: From Reviewing & Critical Analysis to Research Ethics","Independent Synoptic Project"],"2027-10":["Psychological Foundations of Mental Health","Psychology & Neuroscience of Psychosis","Neuroimaging in Mental Health","Pharmacotherapies in Mental Health","Research Skills: From Methods & Procedures to Analysis & Reporting","Independent Synoptic Project"]};
const keys=Object.keys(SCH).sort();

/* =========================
   State & helpers
   ========================= */
const state = { award:'MSc', start:'2023-09', options:[], breaks:new Set(), taken:new Map(), dark:false };
const $ = s => document.querySelector(s);
const el = (t,c='',h='') => { const d=document.createElement(t); if(c) d.className=c; if(h) d.innerHTML=h; return d; };
const addY=(k,y)=>{ const [yr,m]=k.split('-').map(Number); return `${yr+y}-${String(m).padStart(2,'0')}`; }
const fmtD=(k)=>{ const [y,m]=k.split('-').map(Number); return new Date(y,m-1,1).toLocaleString('en-GB',{month:'short',year:'numeric'}); }
const getType=(m)=> F.includes(m)?'f': O.includes(m)?'o': R.includes(m)?'r': S.includes(m)?'s':'u';
const countTaken = () => { const c = { f:0,o:0,r:0,s:0 }; state.taken.forEach(v => c[getType(v)]++); return c; };
const req = () => ({...REQ[state.award]});
let genTimer; const regen = () => { clearTimeout(genTimer); genTimer = setTimeout(gen, 60); };

// persistence
function save(){ const payload = {...state, breaks:[...state.breaks], taken:[...state.taken]}; localStorage.setItem('planner.v3', JSON.stringify(payload)); }
function load(){
  try {
    const raw = localStorage.getItem('planner.v3'); if(!raw) return;
    const obj = JSON.parse(raw);
    state.award = obj.award ?? state.award;
    state.start = obj.start ?? state.start;
    state.options = obj.options ?? [];
    state.breaks = new Set(obj.breaks ?? []);
    state.taken = new Map(obj.taken ?? []);
    state.dark = !!obj.dark;
  } catch {}
}
function toast(msg, kind='info'){
  const box=$("#toast");
  const n=el('div',`toast card px-3 py-2 text-sm border-2 ${kind==='ok'?'border-emerald-300 bg-emerald-50 dark:bg-[#0a1f17] dark:border-emerald-900':kind==='warn'?'border-amber-300 bg-amber-50 dark:bg-[#3a2b06] dark:border-amber-900':'border-sky-300 bg-sky-50 dark:bg-[#0b1d2b] dark:border-sky-900'}`);
  n.textContent=msg; box.appendChild(n); setTimeout(()=>n.remove(), 2200);
}

/* =========================
   Init
   ========================= */
function init(){
  load();

  // Dark toggle
  if(state.dark) document.documentElement.classList.add('dark');
  $("#darkToggle").textContent = state.dark ? '‚òÄÔ∏è Light' : 'üåô Dark';
  $("#darkToggle").addEventListener('click', () => {
    state.dark = !state.dark;
    document.documentElement.classList.toggle('dark', state.dark);
    $("#darkToggle").textContent = state.dark ? '‚òÄÔ∏è Light' : 'üåô Dark';
    save();
  });

  // Start select
  const startS=$("#start");
  keys.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=fmtD(k); startS.appendChild(o); });
  startS.value = state.start;
  startS.addEventListener('change', e => { state.start = e.target.value; regen(); save(); });

  // Award
  $("#award").value = state.award;
  $("#award").addEventListener('change', e => { state.award = e.target.value; regen(); save(); });

  // Options chips
  const optsW=$("#opts"); optsW.innerHTML='';
  O.forEach(n=>{
    const b=el('button','chip'); b.dataset.name=n; b.textContent=n;
    if(state.options.includes(n)) b.classList.add('on');
    b.addEventListener('click',()=>{
      const on=b.classList.contains('on'); let selected = new Set(state.options);
      if(on){ selected.delete(n); } else { if(selected.size>=4){ toast('You can only select 4 options','warn'); return; } selected.add(n); }
      state.options = [...selected]; $("#optCount").textContent = state.options.length; b.classList.toggle('on'); regen(); save();
    });
    optsW.appendChild(b);
  });
  $("#optCount").textContent = state.options.length;

  // Buttons
  $("#quickFillBtn").addEventListener('click', quickFill);
  $("#y1Breaks").addEventListener('click', ()=>addBreaksToYear(1));
  $("#y2Breaks").addEventListener('click', ()=>addBreaksToYear(2));
  $("#clearBreaks").addEventListener('click', clearAllBreaks);
  $("#resetBtn").addEventListener('click', resetPlan);
  $("#downloadBtn").addEventListener('click', downloadPlan);

  gen();
}

/* =========================
   Render
   ========================= */
function gen(){
  const r = req();
  // warn box
  const warnBox=$("#warnBox");
  if(r.o>0 && state.options.length<4) warnBox.classList.remove('hidden'); else warnBox.classList.add('hidden');

  renderPhase();
  renderTimeline();
  renderAnalytics();
  renderImpact();
  updateBreakImpact();

  save();
}
function renderPhase(){
  const r = req();
  const tkn = countTaken();
  const box=$("#phaseInfo");
  let txt='', cls='';
  if(tkn.f<r.f){ txt='üìò Phase 1: Foundation Modules (complete all 4 first)'; cls='bg-sky-50 dark:bg-[#0b1d2b] border-sky-200 dark:border-sky-900'; }
  else if(tkn.o<r.o){ txt='üìï Phase 2: Options (choose 4 from your selection)'; cls='bg-sky-50 dark:bg-[#0b1d2b] border-sky-200 dark:border-sky-900'; }
  else if(tkn.r<r.r){ txt='üìó Phase 3: Research Skills (after foundations + options)'; cls='bg-sky-50 dark:bg-[#0b1d2b] border-sky-200 dark:border-sky-900'; }
  else if(tkn.s<r.s){ txt='üìì Phase 4: Synoptic Project'; cls='bg-sky-50 dark:bg-[#0b1d2b] border-sky-200 dark:border-sky-900'; }
  else { txt='‚úÖ All Phases Complete!'; cls='bg-green-50 dark:bg-[#0f2a1f] border-green-200 dark:border-emerald-900'; }
  box.className = `card p-3 text-sm font-semibold border ${cls}`;
  box.textContent = txt;
}
function yearFromKey(k){ return k.split('-')[0]; }
function renderTimeline(){
  const tl=$("#timeline"); tl.innerHTML = '';
  const horizonStop = addY(state.start, 6);
  const span = keys.filter(k => k >= state.start && k <= horizonStop);

  let currentYear = '';
  span.forEach(k=>{
    const y = yearFromKey(k);
    if(y !== currentYear){
      currentYear = y;
      tl.appendChild(el('div','mt-2 mb-1 text-xs font-bold text-slate-600 dark:text-slate-300', y));
    }

    const isBreak = state.breaks.has(k);
    const tkMod = state.taken.get(k);
    const card = el('div','term-card border border-slate-200 dark:border-[#263043] rounded-lg p-2 bg-white dark:bg-[#0b1220]');

    // header
    const hdr=el('div','flex items-center justify-between mb-1');
    const ttl=el('div','text-xs font-semibold', fmtD(k));
    const ctrl=el('div','flex gap-1');
    if(isBreak){
      const b=el('button','text-xs border rounded px-2 py-0.5','üìÖ Break');
      b.addEventListener('click',()=>{ state.breaks.delete(k); regen(); });
      ctrl.appendChild(b);
    } else if (tkMod){
      const t=el('button','text-xs border rounded px-2 py-0.5 bg-emerald-50 dark:bg-[#0a1f17] border-emerald-200 dark:border-emerald-900','‚úì Taken');
      t.addEventListener('click',()=>{ state.taken.delete(k); regen(); });
      const b=el('button','text-xs border rounded px-2 py-0.5','Take Break');
      b.addEventListener('click',()=>{ state.breaks.add(k); state.taken.delete(k); regen(); });
      ctrl.appendChild(t); ctrl.appendChild(b);
    } else {
      const b=el('button','text-xs border rounded px-2 py-0.5','Set Break');
      b.addEventListener('click',()=>{ state.breaks.add(k); regen(); });
      ctrl.appendChild(b);
    }
    hdr.appendChild(ttl); hdr.appendChild(ctrl);
    card.appendChild(hdr);

    if(!isBreak && !tkMod){
      const mds = SCH[k] || [];
      const block=el('div','space-y-1');
      const r = req(); const tkn = countTaken();

      if(tkn.f<r.f){
        const avail=mds.filter(m=>F.includes(m) && ![...state.taken.values()].includes(m));
        renderChoices(block,k,avail,'f');
      } else if(tkn.o<r.o){
        const avail=mds.filter(m=>state.options.includes(m) && ![...state.taken.values()].includes(m));
        renderChoices(block,k,avail,'o');
      } else if(tkn.r<r.r){
        const avail=mds.filter(m=>R.includes(m) && ![...state.taken.values()].includes(m));
        renderChoices(block,k,avail,'r');
      } else if(tkn.s<r.s){
        const avail=mds.filter(m=>S.includes(m));
        renderChoices(block,k,avail,'s');
      } else {
        card.appendChild(el('div','text-xs text-slate-500 dark:text-slate-400','All requirements complete'));
      }
      card.appendChild(block);
    } else if (tkMod){
      card.appendChild(el('div','mt-1 text-xs font-semibold rounded border px-2 py-1 bg-emerald-50 dark:bg-[#0a1f17] border-emerald-200 dark:border-emerald-900', tkMod));
    }
    tl.appendChild(card);
  });

  // Grad box
  const ge=$("#gradBox");
  const lastK=[...state.taken.keys()].sort().pop();
  const r=req(); const tkn=countTaken();
  const reqOK = tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s>=r.s;
  if(lastK && reqOK){ ge.classList.remove('hidden'); $("#gradTxt").textContent=fmtD(lastK); }
  else { ge.classList.add('hidden'); }
}
function renderChoices(container, k, list, stage){
  if(list.length===0){
    const msg = stage==='f' ? 'No eligible foundation modules'
              : stage==='o' ? 'No eligible options available'
              : stage==='r' ? 'Complete 4 foundations + 4 options first'
              : 'Complete research modules first';
    container.appendChild(el('div','text-xs text-slate-500 dark:text-slate-400','üîí '+msg));
    return;
  }
  list.forEach(m=>{
    const btn=el('button','w-full text-left text-xs border rounded px-2 py-1 bg-slate-50 dark:bg-[#0f172a] border-slate-200 dark:border-[#263043] hover:bg-slate-100 dark:hover:bg-[#111827]');
    btn.textContent=m;
    btn.addEventListener('click',()=>{
      state.taken.set(k,m);
      if(stage==='s'){ const i=keys.indexOf(k); const nk=keys[i+1]; if(nk) state.taken.set(nk,m); }
      regen();
    });
    container.appendChild(btn);
  });
}
function renderAnalytics(){
  const r=req(); const tkn=countTaken();
  const lastK=[...state.taken.keys()].sort().pop();

  // duration
  if(lastK){
    const totalPeriods=keys.filter(k=>k>=state.start && k<=lastK).length;
    const studyPeriods=Math.max(0,totalPeriods - state.breaks.size);
    const months = studyPeriods*2;
    animateNumber($("#vDur"), months);
  } else { $("#vDur").textContent='‚Äî'; }

  // breaks
  animateNumber($("#vBrk"), state.breaks.size);

  // progress %
  const tot=r.f+r.o+r.r+r.s;
  const cur=tkn.f+tkn.o+tkn.r+tkn.s;
  const pct=tot?Math.round((cur/tot)*100):0;
  animateNumber($("#vPct"), pct, '%');
  const pf=$("#progFill"), pf2=$("#progFillClone"); pf.style.width=pct+'%'; pf2.style.width=pct+'%'; pf2.textContent=pct+'%';

  // mini grad card
  if(lastK){ $("#vGrad").innerHTML = fmtD(lastK).replace(' ','<br>'); } else { $("#vGrad").textContent='‚Äî'; }

  // badges
  $("#pf").textContent=tkn.f; $("#rf").textContent=r.f;
  $("#po").textContent=tkn.o; $("#ro").textContent=r.o;
  $("#pr").textContent=tkn.r; $("#rr").textContent=r.r;
  $("#ps").textContent=tkn.s; $("#rs").textContent=r.s;
}
function renderImpact(){
  const box=$("#impactBox");
  if(state.taken.size===0){ box.classList.add('hidden'); return; }
  const base = calcBaseline();
  const lastK=[...state.taken.keys()].sort().pop();
  if(!(base && lastK)){ box.classList.add('hidden'); return; }

  const bPeriods=keys.filter(k=>k>=state.start && k<=base).length;
  const cPeriods=keys.filter(k=>k>=state.start && k<=lastK).length;
  const delay=(cPeriods-bPeriods)*2 - state.breaks.size*2;

  $("#impBase").textContent = fmtD(base);
  $("#impPlan").textContent = fmtD(lastK);
  const d=$("#impDelta");
  d.textContent = (delay>0?'+':'')+delay+' months';
  d.className = 'ml-2 font-semibold ' + (delay>0?'text-amber-600':'text-emerald-500');

  box.classList.remove('hidden');
  drawImpactChart('impactChart', { baselinePeriods:bPeriods, currentPeriods:cPeriods, breaks:[...state.breaks].length });
}
function calcBaseline(){
  const r=req();
  const taken2=new Map(); let tkn={f:0,o:0,r:0,s:0};
  const hs=addY(state.start,6);
  const itk=keys.filter(k=>k>=state.start && k<=hs);

  for(const k of itk){
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s>=r.s) break;
    const mds=SCH[k]||[];

    if(tkn.f<r.f){
      const m=mds.find(x=>F.includes(x) && ![...taken2.values()].includes(x));
      if(m){ taken2.set(k,m); tkn.f++; continue; }
    }
    if(tkn.f>=r.f && tkn.o<r.o){
      const m=mds.find(x=>state.options.includes(x) && ![...taken2.values()].includes(x));
      if(m){ taken2.set(k,m); tkn.o++; continue; }
    }
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r<r.r){
      const m=mds.find(x=>R.includes(x) && ![...taken2.values()].includes(x));
      if(m){ taken2.set(k,m); tkn.r++; continue; }
    }
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s<r.s){
      const m=mds.find(x=>S.includes(x));
      if(m){ taken2.set(k,m); const ni=itk.indexOf(k); if(ni>=0 && ni<itk.length-1) taken2.set(itk[ni+1],m); tkn.s++; break; }
    }
  }
  return [...taken2.keys()].sort().pop();
}

/* =========================
   Actions
   ========================= */
function quickFill(){
  const r=req();
  if(r.o>0 && state.options.length<4){ toast('Please select 4 option modules first','warn'); return; }
  const before = state.taken.size;

  const hs=addY(state.start,6);
  const itk=keys.filter(k=>k>=state.start && k<=hs);
  let tkn=countTaken();

  for(const k of itk){
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s>=r.s) break;
    if(state.taken.has(k) || state.breaks.has(k)) continue;
    const mds=SCH[k]||[];

    if(tkn.f<r.f){
      const m=mds.find(x=>F.includes(x) && ![...state.taken.values()].includes(x));
      if(m){ state.taken.set(k,m); tkn.f++; continue; }
    }
    if(tkn.f>=r.f && tkn.o<r.o){
      const m=mds.find(x=>state.options.includes(x) && ![...state.taken.values()].includes(x));
      if(m){ state.taken.set(k,m); tkn.o++; continue; }
    }
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r<r.r){
      const m=mds.find(x=>R.includes(x) && ![...state.taken.values()].includes(x));
      if(m){ state.taken.set(k,m); tkn.r++; continue; }
    }
    if(tkn.f>=r.f && tkn.o>=r.o && tkn.r>=r.r && tkn.s<r.s){
      const m=mds.find(x=>S.includes(x));
      if(m){ state.taken.set(k,m); const ni=itk.indexOf(k); const nk=itk[ni+1]; if(nk) state.taken.set(nk,m); tkn.s++; break; }
    }
  }

  const added = state.taken.size - before;
  regen();
  if(added>0) toast(`Added ${added} module${added>1?'s':''} to your plan!`,'ok');
  else toast('No suitable modules found to add','warn');
}
function addBreaksToYear(year){
  const baseYear=parseInt(state.start.split('-')[0]); const target=baseYear+year-1; let added=0;
  keys.forEach(k=>{ if(parseInt(k.split('-')[0])===target && !state.taken.has(k) && !state.breaks.has(k)){ state.breaks.add(k); added++; } });
  regen();
  if(added>0) toast(`Added ${added} breaks to Year ${year}`,'ok'); else toast(`No available periods in Year ${year} for breaks`,'warn');
}
function clearAllBreaks(){ const n=state.breaks.size; state.breaks.clear(); regen(); if(n>0) toast(`Cleared ${n} breaks`,'ok'); else toast('No breaks to clear','warn'); }
function resetPlan(){
  if(!confirm('Reset everything? This cannot be undone.')) return;
  state.taken.clear(); state.breaks.clear(); state.options=[]; state.award='MSc'; state.start=keys.find(k=>k>='2023-09')||keys[0];
  $("#award").value=state.award; $("#start").value=state.start;
  document.querySelectorAll('#opts .chip').forEach(c=>c.classList.remove('on')); $("#optCount").textContent='0';
  regen(); toast('Plan reset successfully','ok');
}
function downloadPlan(){
  const payload = { award: state.award, start: state.start, options: state.options, breaks: [...state.breaks], taken: [...state.taken], generatedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='graduation_plan.json'; a.click(); URL.revokeObjectURL(a.href);
}

/* =========================
   Chart (vanilla)
   ========================= */
function drawImpactChart(id, {baselinePeriods, currentPeriods, breaks}){
  const c = document.getElementById(id); const ctx = c.getContext('2d'); const w=c.width, h=c.height;
  ctx.clearRect(0,0,w,h);

  const pad=30; const maxX = Math.max(baselinePeriods, currentPeriods)||1; const maxY = maxX;
  ctx.strokeStyle = '#94a3b8'; ctx.globalAlpha = .5; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.moveTo(pad,h-pad); ctx.lineTo(pad,pad); ctx.stroke(); ctx.globalAlpha = 1;
  const x = v => pad + (w-2*pad) * (v/maxX); const y = v => (h-pad) - (h-2*pad) * (v/maxY);

  ctx.strokeStyle = '#0ea5e9'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(x(0), y(0)); ctx.lineTo(x(baselinePeriods), y(baselinePeriods)); ctx.stroke();
  ctx.strokeStyle = '#06b6d4'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(x(0), y(0)); ctx.lineTo(x(currentPeriods), y(currentPeriods)); ctx.stroke();

  if(breaks>0){ ctx.fillStyle = '#f59e0b'; for(let i=1;i<=breaks;i++){ const bx=x(currentPeriods*(i/(breaks+1))); const by=y(currentPeriods*(i/(breaks+1))); ctx.beginPath(); ctx.arc(bx,by,3,0,Math.PI*2); ctx.fill(); } }

  ctx.fillStyle = '#94a3b8'; ctx.font = '10px system-ui, sans-serif'; ctx.fillText('Terms', w/2-14, h-8); ctx.save(); ctx.translate(12,h/2+20); ctx.rotate(-Math.PI/2); ctx.fillText('Cumulative terms',0,0); ctx.restore();
  ctx.fillStyle='#0ea5e9'; ctx.fillText('Baseline', w-90, 20); ctx.fillStyle='#06b6d4'; ctx.fillText('Your plan', w-90, 34); ctx.fillStyle='#f59e0b'; ctx.fillText('Breaks', w-90, 48);
}

/* =========================
   Sidebar / Break Impact
   ========================= */
function updateBreakImpact(){
  const el=$("#breakImpact");
  const base=calcBaseline();
  const lastK=[...state.taken.keys()].sort().pop();
  if(state.breaks.size===0){ el.textContent='No breaks selected'; return; }
  if(base && lastK){
    const bP=keys.filter(k=>k>=state.start && k<=base).length;
    const cP=keys.filter(k=>k>=state.start && k<=lastK).length;
    const delay=(cP-bP)*2;
    el.innerHTML = `${state.breaks.size} break(s) = <span class="${delay>0?'text-amber-600':'text-emerald-500'} font-semibold">${delay>0?'+':''}${delay} months</span>`;
  } else el.textContent = `${state.breaks.size} break(s) selected`;
}

/* =========================
   Tiny helper: animate number
   ========================= */
function animateNumber(node, value, suffix=''){
  const target = Number(value);
  const curr = Number((node.textContent||'0').replace('%','')) || 0;
  const steps = 12; const delta = (target - curr)/steps; let i=0;
  const tick=()=>{ i++; const val = i<steps ? Math.round(curr + delta*i) : target; node.textContent = val + (suffix||''); if(i<steps) requestAnimationFrame(tick); };
  requestAnimationFrame(tick);
}

/* =========================
   Boot
   ========================= */
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
